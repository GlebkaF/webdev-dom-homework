<!DOCTYPE html>
<html>

<head>
  <title>Проект "Комменты"</title>
  <meta charset="utf-8" />
  <link rel="stylesheet" href="styles.css" />
</head>

<body>
  <div class="container">
    <ul class="comments" id="add-comment">
      <!-- рендер из JS -->
    </ul>
    <div class="add-form">
      <input type="text" class="add-form-name" placeholder="Введите ваше имя" id="form-name" />
      <textarea type="textarea" class="add-form-text" placeholder="Введите ваш коментарий" rows="4"
        id="form-text"></textarea>
      <div class="add-form-row">
        <button class="add-form-button" id="add-button">Написать</button>
      </div>
    </div>
    <button class="add-form-button" id="add-button-delete">Удалить последний комментарий</button>
  </div>
</body>


//СТИЛИ
<style>
  .error {
    outline: 3px solid rgb(228, 67, 67);
  }

  .btn {
    background-color: #b9b9b9;
  }
</style>

<script>
  "use strict"; //СТР

  //ПЕРЕМЕННЫЕ
  const nameElement = document.getElementById('form-name');
  const textElement = document.getElementById('form-text');
  const buttonElement = document.getElementById('add-button');
  const buttonDeleteElement = document.getElementById('add-button-delete');
  const formCommentElement = document.getElementById('add-comment');

  // ШАБЛОН ВЫВОДА ДАТЫ СОЗДАНИЯ КОММЕНТАРИЯ
  const currentDate = new Date().toLocaleString('ru-RU', { year: '2-digit', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit', hour12: false }).replace(',', '');

  const comments = [
    {
      name: 'Глеб Фокин',
      date: "12.02.22 12:18",
      text: 'Это будет первый комментарий на этой странице',
      likeCount: 3,
      isEdit: false,
      isLike: false,
    },
    {
      name: 'Варвара',
      date: "13.02.22 19:22",
      text: 'Мне нравится как оформлена эта страница! ❤',
      likeCount: 78,
      isEdit: false,
      isLike: false,
    }
  ];
  const replyToComment = (index) => {
  const commentElements = document.querySelectorAll('.comment-text');
  for (const commentElement of commentElements) {
    commentElement.addEventListener('click', () => {
      const commentText = commentElement.innerText;
      document.getElementById('form-text').value = `>${commentText}\n ${comments[index].name}:`;
    });
  }
};
  function addLike() {
    const likeElements = document.querySelectorAll('.like-button');
    for (let likeElement of likeElements) {
      likeElement.addEventListener('click', (event) => {
        event.stopPropagation();
        let index = likeElement.dataset.index

        if (comments[index].isLike) {
          comments[index].likeCount--;
          comments[index].isLike = false
        } else {
          comments[index].likeCount++;
          comments[index].isLike = true

        }
        renderComments()
      });
    };
  };
  const initEditElements = () => {
    const editButtonElements = document.querySelectorAll('.edit-form-button');
    for (const editButton of editButtonElements) {
      editButton.addEventListener('click', () => {
        const index = editButton.dataset.index;
        comments[index].isEdit = true;
        renderComments()
      });
    }
  }

  const initSaveButtons = () => {
    const saveButtons = document.querySelectorAll(".save-form-button");
    for (const saveButton of saveButtons) {
      saveButton.addEventListener('click', () => {
        const index = saveButton.dataset.index;
        comments[index].isEdit = false;
        comments[index].text = formCommentElement.querySelectorAll('.comment')[index].querySelector('textarea').value;
        renderComments();
      });
    }
  };
  function addComment() {
    //ВАЛИДАЦИЯ
    //remove для удаления классов
    //trim() для избежания добавления комментариев состоящих из пустых симовлов (пробелов)
    nameElement.classList.remove('error');
    textElement.classList.remove('error');
    if (nameElement.value.trim() === '' || textElement.value.trim() === '') { // если хоть одна ошибка есть
      if (nameElement.value.trim() === '') { // если нет имени
        nameElement.classList.add('error');
        nameElement.placeholder = '* Имя является обязательным!'
      };
      if (textElement.value.trim() === '') { // если нет текста
        textElement.classList.add('error');
        textElement.placeholder = '* Комментраий является обязательным!'
      };
      // сюда дойдет всегда если нет хоть одного поля
      buttonElement.disabled = true;
      buttonElement.classList.add('btn')

      // разблокировка кнопки + удаление обводки
      nameElement.addEventListener('click', () => {
        buttonElement.disabled = false;
        buttonElement.classList.remove('btn');
        textElement.classList.remove('error');
      });
      textElement.addEventListener('click', () => {
        buttonElement.disabled = false;
        buttonElement.classList.remove('btn');
        nameElement.classList.remove('error');
      });
      return;
    };
    comments.push({
      name: nameElement.value
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;"),
      date: currentDate,
      text: textElement.value
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;"),
      likeCount: 0,
      isLike: false
    });

    renderComments();

    nameElement.value = ''; //очищаем форму (имя);
    textElement.value = ''; //очищаем форму (текст);
    nameElement.setAttribute('placeholder', 'Введите ваше имя'); //возвращаем placeholder к стандарту после добаваления комментария
    textElement.setAttribute('placeholder', 'Введите ваш коментарий',);//возвращаем placeholder к стандарту после добаваления комментария

  };
  //ВЫВОД
  const renderComments = () => {
    formCommentElement.innerHTML = comments.map((comment, index) => {
      return `<li class="comment">
        <div class="comment-header">
          <div>${comment.name}</div>
          <div>${comment.date}</div>
        </div>
        <div class="comment-body">
          ${comment.isEdit
          ? `<textarea type="textarea"  class="add-form-text" placeholder="Введите ваш коментарий" rows="4">${comment.text}</textarea>`
          : `<div class="comment-text"onclick="replyToComment(${index})"> ${comment.text} </div>`}
        </div>
        <div class="comment-footer">
          ${comment.isEdit
          ? `<button  class="save-form-button" data-index="${index}">Сохранить</button>`
          : `<button  class="edit-form-button" data-index="${index}">Редактировать</button>`
        }
          <div class="likes">
            <span class="likes-counter">${comment.likeCount}</span>
            <button class="like-button ${comment.isLike ? '-active-like' : ''}" data-index="${index}"></button>
          </div>
        </div>
      </li>`
    }).join('')
    addLike()
    initEditElements()
    initSaveButtons()
    replyToComment()
  };

  renderComments();

  // ВЫЗОВ ФУНКЦИИ НА КЛИК
  buttonElement.addEventListener('click', addComment);
  // ВЫЗОВ ФУНКЦИИ НА ENTER
  document.addEventListener('keyup', (event) => {
    if (event.code === 'Enter') {
      addComment();
    }
  });

  //УДАЛИТЬ ПОСЛЕДНИЙ КОММЕНТАРИЙ
  buttonDeleteElement.addEventListener('click', () => {
    const comments = document.getElementsByClassName('comment');
    if (comments.length > 0) {
      const lastComment = comments[comments.length - 1];
      lastComment.parentNode.removeChild(lastComment);
    }
  });
</script>

</html>