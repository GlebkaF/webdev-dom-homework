<!DOCTYPE html>
<html>

<head>
  <title>Проект "Комменты"</title>
  <meta charset="utf-8" />
  <link rel="stylesheet" href="styles.css" />
</head>

<body>
  <div class="container">
    <ul id="list" class="comments">
      <!--Рендерится из JS-->
    </ul>
    <div class="add-form">
      <input id="name-input" type="text" class="add-form-name" placeholder="Введите ваше имя" />
      <textarea id="comment-input" type="textarea" class="add-form-text" placeholder="Введите ваш коментарий"
        rows="4"></textarea>
      <div class="add-form-row">
        <button id="add-button" class="add-form-button">Написать</button>
      </div>      
    </div>
    <button class="del-form-button">Удалить последний комментарий</button>
  </div>
</body>
<script>
  "use strict";
  // Код писать здесь  

  let commentsArr = [
    /*{
      name: 'Глеб Фокин',
      date: '12.02.22 12:18',
      comment: 'Это будет первый комментарий на этой странице',
      likesCounter: 3,
      myLike: false,
    },
    {
      name: 'Варвара Н.',
      date: '13.02.22 19:22',
      comment: 'Мне нравится как оформлена эта страница! ❤',
      likesCounter: 75,
      myLike: true,
    }*/
  ];

  const comments = document.querySelector(".comments");
  const buttonElement = document.getElementById('add-button');
  const delFormBtn = document.querySelector(".del-form-button");
  const listElement = document.getElementById('list');
  const nameInputElement = document.getElementById('name-input');
  const commentInputElement = document.getElementById('comment-input');

  const fetchPromise = fetch("https://wedev-api.sky.pro/api/v1/ekaterinabbkv/comments", {
      method: "GET"
    });

    // подписываемся на успешное завершение запроса с помощью then
    fetchPromise.then((response) => {
      // Запускаем преобразовываем "сырые" данные от API в json формат
      const jsonPromise = response.json();

      // Подписываемся на результат преобразования
      jsonPromise.then((responseData) => {

        const appComments = responseData.comments.map((comment) => {
          return {
            name: comment.author.name,
            date: now (new Date (comment.date)),
            text: comment.text,
            likes: 0,
            myLike: false,
          }
        })
        // получили данные и рендерим их в приложении
        console.log(responseData);
        // comment = responseData.comment;
        commentsArr = appComments;
        renderComments();
      });
    });

  const initEventListeners = () => {
    const likeButtons = document.querySelectorAll('.like-button');

    for (const likeButton of likeButtons) {
      likeButton.addEventListener("click", () => {
        const comment = commentsArr[likeButton.dataset.index];
        comment.myLike ? --comment.likes : ++comment.likes;
        comment.myLike = !comment.myLike;
        renderComments();
      });
    }
  };

  buttonElement.disabled = true;

  document.addEventListener("input", () => {
    nameInputElement.value != "" && commentInputElement.value != ""
      ? (buttonElement.disabled = false)
      : (buttonElement.disabled = true);
  });

  document.addEventListener("keyup", (e) => {
    if (
      (e.code === "Enter" || e.code === "NumpadEnter") &&
      !buttonElement.disabled
    ) {
      createNewComment();
      renderComments();
    }
  });

  delFormBtn.addEventListener("click", () => {
  commentsArr.pop();
  renderComments();
  if (!commentsArr) delFormBtn.disabled = true;
});

  const replyToComment = () => {
    const commentBodies = document.querySelectorAll(".comment-body");
    for (const commentBody of commentBodies) {
      commentBody.addEventListener('click', () => {
        const oldComment = commentBody.dataset.text;
        const oldName = commentBody.dataset.name;
        commentInputElement.value += `${oldComment}\n${oldName}`;
      })
    }

  }

  const renderComments = () => {
    comments.innerHTML = commentsArr
      .map((comment, index) => {
        return `<li class="comment">
          <div class="comment-header">
            <div>${comment.name}</div>
            <div>${comment.date}</div>
          </div>
          <div class="comment-body" data-text = "${comment.text}" data-name = "${comment.name}">
            <div class="comment-text">
              ${comment.text}
            </div>
          </div>
          <div class="comment-footer">
            <div class="likes">
              <span class="likes-counter">${comment.likes}</span>
              <button data-index = '${index}' class="${comment.myLike ? 'like-button -active-like' : 'like-button'}"></button>
            </div>
          </div>
        </li>`
      })
      .join("");
    commentInputElement.value = "";
    nameInputElement.value = "";
    buttonElement.disabled = true;
    initEventListeners();
    replyToComment();
  }
  renderComments();

  const plusZero = (str) => {
    return str < 10 ? `0${str}` : str;
  }

  const now = (currentDate) => {
    let minute = plusZero(currentDate.getMinutes());
    let hours = plusZero(currentDate.getHours());
    let date = plusZero(currentDate.getDate());
    let month = plusZero(currentDate.getMonth() + 1);
    return `${date}.${month}.${currentDate.getFullYear() % 100} ${hours}:${minute}`;
  }
  let currentDate = new Date();
  const createNewComment = () => {
    // подписываемся на успешное завершение запроса с помощью then
  fetch("https://wedev-api.sky.pro/api/v1/ekaterinabbkv/comments", {
        method: "POST",
        body: JSON.stringify({
          name: nameInputElement.value,
          text: commentInputElement.value,
        })
        // JSON.stringifylikes:
      }).then((response) => {
        response.json().then((responseData) => {

          fetch("https://wedev-api.sky.pro/api/v1/ekaterinabbkv/comments", {
            method: "GET"  
          }).then((response) => {
      // Запускаем преобразовываем "сырые" данные от API в json формат
     response.json().then((responseData) => {

        const appComments = responseData.comments.map((comment) => {
          return {
            name: comment.author.name,
            date: now (new Date (comment.date)),
            text: comment.text,
            likes: 0,
            myLike: false,
          };
        });
        // // получили данные и рендерим их в приложении
        // console.log(responseData);
        //comment = responseData.comments;
        commentsArr = appComments;
        renderComments();
      });
        });
      });
    });
    /*commentsArr.push({
      name: nameInputElement.value.replaceAll('<', "&lt;").replaceAll('>', '&gt'),
      date: now(currentDate),
      comment: commentInputElement.value.replaceAll('<', "&lt;").replaceAll('>', '&gt'),
      likesCounter: 0,
      myLike: false,
    });*/
  }

  buttonElement.addEventListener("click", () => {
    createNewComment();
    renderComments();    
  });

  

  console.log("It works!");
</script>

</html>