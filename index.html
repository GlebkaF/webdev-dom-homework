<!DOCTYPE html>
<html>
  <head>
    <title>Проект "Комменты"</title>
    <meta charset="utf-8" />
    <link rel="stylesheet" href="styles.css" />
  </head>
  <body>
    <div class="container">
      <ul class="comments"></ul>
      <div class="add-form">
        <input
          type="text"
          class="add-form-name"
          placeholder="Введите ваше имя"
        />
        <textarea
          type="textarea"
          class="add-form-text"
          placeholder="Введите ваш коментарий"
          rows="4"
        ></textarea>
        <div class="add-form-row">
          <button class="add-form-button">Написать</button>
          <button class="remove-form-button">Удалить последний</button>
        </div>
      </div>
    </div>
  </body>
  <script>
    "use strict";
    
    const commentList = document.querySelector('.comments');
    const nameElement = document.querySelector('.add-form-name');
    const textElement = document.querySelector('.add-form-text');
    const addButton = document.querySelector('.add-form-button');
    const removeButton = document.querySelector('.remove-form-button');

    const comments = [
      {
        name: 'Глеб Фокин',
        date: '12.02.22 12:18',
        text: 'Это будет первый комментарий на этой странице',
        isActive: false,
        counter: 3
      },
      {
        name: 'Варвара Н.',
        date: '13.02.22 19:22',
        text: 'Мне нравится как оформлена эта страница! ❤',
        isActive: true,
        counter: 75
      }
    ];

    const renderComments = () => {
      commentList.innerHTML = comments.map((el, i) => {
        return `<li class="comment" data-index="${i}">
          <div class="comment-header">
            <div>${el.name}</div>
            <div>${el.date}</div>
          </div>
          <div class="comment-body">
            <div class="comment-text">${el.text}</div>
          </div>
          <footer class="comment-footer">
            <div class="likes">
              <span class="likes-counter">${el.counter}</span>
              <button class="like-button ${el.isActive ? '-active-like' : ''}" data-index="${i}"></button>  
            </div>
          </footer>
        </li>`;
      }).join('');

      checkAddButton();
      activateAddButton();
      likeComment();
      answerComment();
    }

    const checkAddButton = () => {
      if (!nameElement.value.trim() || !textElement.value.trim()) {
        addButton.disabled = true;
      }
    }
    const activateAddButton = () => {
      nameElement.addEventListener('input', () => {
        if (textElement.value.trim()) {
          addButton.disabled = false;
        }
      });
      textElement.addEventListener('input', () => {
        if (nameElement.value.trim()) {
          addButton.disabled = false;
        }
      });
    }
    const deleteLastComment = () => {
      comments.pop();

      renderComments();
    }
    const addComment = () => {
      let day = addZeroBefore((new Date).getDate());
      let month = addZeroBefore((new Date).getMonth());
      let year = editYear((new Date).getFullYear());
      let hours = addZeroBefore((new Date).getHours());
      let minutes = addZeroBefore((new Date).getMinutes());

      if (!nameElement.value.trim()) {
        nameElement.classList.add('form-error');
        return;
      } else if (!textElement.value.trim()) {
        textElement.classList.add('form-error');
        return;
      } else {
        comments.push({
          name: replaceValue(nameElement.value),
          date: `${day}.${month}.${year} ${hours}:${minutes}`,
          text: replaceValue(textElement.value)
          .replaceAll('START_QUOTE', '<div class="comment-quote">')
          .replaceAll('END_QUOTE', '</div>'),
          isEdit: false,
          isActive: false,
          counter: 0
        });
      }

      renderComments();

      nameElement.value = '';
      textElement.value = '';
      nameElement.classList.remove('form-error');
      textElement.classList.remove('form-error');

      checkAddButton();
    }
    const likeComment = () => {
      const likeButtons = document.querySelectorAll('.like-button');

      for (let button of likeButtons) {
        button.addEventListener('click', (event) => {
          event.stopPropagation();
          
          let index = button.dataset.index;

          if (!comments[index].isActive) {
            comments[index].counter++;
          } else {
            comments[index].counter--;
          }

          comments[index].isActive = !comments[index].isActive;

          renderComments();
        });
      }
    }
    const answerComment = () => {
      const commentElements = document.querySelectorAll('.comment');

      for (let element of commentElements) {
        element.addEventListener('click', () => {
          let index = element.dataset.index;

          textElement.value = `START_QUOTE${comments[index].name}:\n${comments[index].text.replaceAll('<div class="comment-quote">', 'START_QUOTE').replaceAll('</div>', 'END_QUOTE')}END_QUOTE`;
        });
      }
    }
    
    const replaceValue = (value) => {
      return value
      .replaceAll("&", "&amp;")
      .replaceAll("<", "&lt;")
      .replaceAll(">", "&gt;")
      .replaceAll('"', "&quot;");
    }
    const addZeroBefore = num => String(num).length < 2 ? '0' + num : num;
    const editYear = year => String(year)[2] + String(year)[3];

    renderComments();

    addButton.addEventListener('click', addComment);
    textElement.addEventListener('keyup', (event) => {
      if (event.key === 'Enter') {
        addComment();
      }
    });
    removeButton.addEventListener('click', deleteLastComment);
  </script>
</html>