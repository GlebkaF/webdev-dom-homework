<!DOCTYPE html>
<html>
  <head>
    <title>Проект "Комменты"</title>
    <meta charset="utf-8" />
    <link rel="stylesheet" href="styles.css" />
  </head>

  <body>
    <div class="container">
      <ul class="comments" id="list">
       
      </ul>
		
      <div class="add-form">
        <input
          type="text"
          class="add-form-name"
          placeholder="Введите ваше имя"
          id="name-input"
        />
        <textarea
          type="textarea"
          class="add-form-text"
          placeholder="Введите ваш коментарий"
          rows="4"
          id="comment-input"
        ></textarea>

        <div class="add-form-row">
          <button id="add-button" class="add-form-button">Написать</button>
          <button id="delete-button" class="add-form-button">Удалить</button>
        </div>
      </div>
    </div>
	</body>
<style>
	.error {
		background-color: gray;
	}
</style>
<script>
const buttonElement = document.getElementById("add-button");
const listElement = document.getElementById("list");
const nameInputElement = document.getElementById("name-input");
const commentInputElement = document.getElementById("comment-input");
const deleteButtonElement = document.getElementById("delete-button");


const commentsArray = [
  {
    name: "Глеб Фокин",
    date: "12.02.22 12:18",
    comment: "Это будет первый комментарий на этой странице",
    like: 3,
    userLike: false,
	 isEdit: false,
  },
  {
    name: "Варвара Н.",
    date: "13.02.22 19:22",
    comment: "Мне нравится как оформлена эта страница! ❤️",
    like: 75,
    userLike: true,
	 isEdit: false,
  },
];

const likes = () => {
  const likeButtons = document.querySelectorAll(".like-button");
  for (const likeButton of likeButtons) {
    likeButton.addEventListener("click", (event) => {
		event.stopPropagation();
      const index = likeButton.dataset.index;
      const comment = commentsArray[index];

      if (!comment.userLike) {
        comment.filling = "-active-like";
        comment.like += 1;
        comment.userLike = true;
		  
      } else {
        comment.filling = "";
        comment.like -= 1;
        comment.userLike = false;
      }

      renderComments();
    });
  }
};

const handleEdit = (index) => {
	const handleEditElements = document.querySelectorAll(".editing");
	for ( const handleEditElement of handleEditElements) {
		handleEditElement.addEventListener("click" , (event) => {
		event.stopPropagation();
  commentsArray[index].isEdit = true;
  renderComments();
  // Показываем кнопку "Сохранить"
  listElement.querySelectorAll('.comment')[index].querySelector('.save-button').style.display = "block";
  renderComments();
	});
  }
};



const handleSave = (index) => {
	const handleSaveElements = document.querySelectorAll(".saving");
	for ( const handleSaveElement of handleSaveElements) {
		handleSaveElement.addEventListener("click" , (event) => {
			event.stopPropagation();
  const editedComment = listElement.querySelectorAll('.comment')[index].querySelector('.comment-input').value; // Получаем отредактированный комментарий
  commentsArray[index].comment = editedComment; // Обновляем комментарий в массиве
  commentsArray[index].isEdit = false; // Устанавливаем флаг редактирования в false
  renderComments(); // Перерисовываем комментарии
  // Скрываем кнопку "Сохранить" после сохранения
  listElement.querySelectorAll('.comment')[index].querySelector('.save-buttons').style.display = "none";
		});
  }
};

const renderComments = () => {
  const commentsHtml = commentsArray
  .map((item, index) => {
      if (item.isEdit) {  
  return`
    <li class="comment" data-index='${index}' >
  <div class="comment-header">
    <div>${item.name}</div>
    <div>${item.date}</div>
    
  </div>
  <div class="comment-body">
                <div class="comment-text">
                  <textarea  class="comment-input add-text " rows="4">${item.comment}</textarea>
						<button onclick="handleSave(${index})" class="save-buttons add-form-button saving">Сохранить</button> 
                </div>
              </div>
            </li>
          `;
  } else {
            return `
          <li class="comment">
            <div class="comment-header">
              <div class="comment-name">${item.name}</div>
              <div>${item.date}</div>     
          </div>
            <div class="comment-body">
              <div class="comment-text">
                <span class="comment-content  ">${item.comment}</span>
					 <button class="edit-button add-form-button">Редактировать</button> <!-- новая кнопка -->
              </div>        
            </div>
        
            <div class="comment-footer">
              <div class="likes">
                <span class="likes-counter">${item.like}</span>
                <button data-index='${index}' class="like-button ${item.userLike ? "-active-like" : ""}"></button>
              </div>  
            </div>
          </li>
          `;
      }
        })
        .join("");
      listElement.innerHTML = commentsHtml;

      likes();
		handleEdit();
		handleSave();
		
    const editButtons = document.querySelectorAll(".edit-button");
      editButtons.forEach((button, index) => {
        button.addEventListener("click", (event) => {
      event.stopPropagation();
          commentsArray[index].isEdit = true;
          renderComments();
        });
      });
		const commentElements = document.querySelectorAll(".comment");
commentElements.forEach((comment) => {
  comment.addEventListener('click', (event) => {
	
   
    const author = comment.querySelector('.comment-header .comment-name').textContent;
    const text = comment.querySelector('.comment-text .comment-content').textContent;
	 	 
    // Формируем ответную цитату для вставки в поле комментария
    const quotedText = `> ${text}\n\n @${author}, `; 
    document.getElementById('comment-input').value = quotedText;
	 renderComments();
  }); 

  
});

    const saveButtons = document.querySelectorAll(".save-button");
      saveButtons.forEach((button, index) => {
        button.addEventListener("click", (event) => {
      event.stopPropagation();
          const editedComment = button.parentNode.nextElementSibling.children[0].children[0].value;
          commentsArray[index].comment = editedComment;
          commentsArray[index].isEdit = false;
			 renderComments();
        });
      });
};

renderComments();

buttonElement.disabled = true;
nameInputElement.addEventListener("input", () => {
  buttonElement.disabled = nameInputElement.value === "";
});

buttonElement.addEventListener("click", () => {
  nameInputElement.classList.remove("error");

  if (nameInputElement.value === "") {
    nameInputElement.classList.add("error");
    return;
  }
  commentInputElement.classList.remove("error");
  if (commentInputElement.value === "") {
    commentInputElement.classList.add("error");
    return;
  }
      if (nameInputElement.value.trim() === "" || commentInputElement.value.trim() === "") {

  return;
}
 renderComments();
const currentDate = new Date();
  const day = currentDate.getDate().toString().padStart(2, "0");
  const month = (currentDate.getMonth() + 1).toString().padStart(2, "0");
  const year = currentDate.getFullYear().toString().slice(-2);
  const hours = currentDate.getHours().toString().padStart(2, "0");
  const minutes = currentDate.getMinutes().toString().padStart(2, "0");
  const formattedDate = `${day}.${month}.${year} ${hours}:${minutes}`;

  commentsArray.push({
    name: nameInputElement.value.replaceAll("<", "&lt;").replaceAll(">", "&gt;"),
    date: formattedDate,
    comment: commentInputElement.value.replaceAll("<", "&lt;").replaceAll(">", "&gt;"),
    like: 0,
    userLike: false,
   isEdit: false,
  });


  nameInputElement.value = "";
  commentInputElement.value = "";
  buttonElement.disabled = true;
  nameInputElement.classList.remove("error");
  commentInputElement.classList.remove("error");

  renderComments();
});


deleteButtonElement.addEventListener("click", () => {
  const comments = listElement.querySelectorAll(".comment");
 
  if (comments.length > 0) {
    listElement.removeChild(comments[comments.length - 1]);
  }
      commentsArray.pop(); // Удаляем последний комментарий из массива
    });
renderComments();
    document.addEventListener("keyup", (event) => {
      if (event.key === "Enter") {
        buttonElement.click();
      }
    });

</script>

</html>