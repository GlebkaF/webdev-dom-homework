<!DOCTYPE html>
<html>
  <head>
    <title>Проект "Комменты"</title>
    <meta charset="utf-8" />
    <link rel="stylesheet" href="styles.css" />
  </head>

  <body class="body">
    <div class="container">
      <ul class="comments" id="listComment">
        <!-- generation with js -->
      </ul>
      <li class="hideTestM" id="hideText" style="display: none;"><h2>Подождите, пожалуйста, идет загрузка комментариев...</h2></li>
      <div class="add-form" id="hideForm" style="display: flex;">
        <input
          id = "inputGetName"
          type="text"
          class="add-form-name"
          placeholder="Введите ваше имя"
        />
        
        <textarea
          id = "inputGetComment"
          type="textarea"
          class="add-form-text"
          placeholder="Введите ваш коментарий"
          rows="4"
        ></textarea>
        <div class="add-form-row">
          <button id = "buttonSend" class="add-form-button">Написать</button>
        </div>
      </div>
    </div>
  </body>
  <style>
    .error {
        background-color: rgb(212, 141, 141);
    }
  </style>


  <script>

    /* ------------------------------------------------------------------
    *
                                getElementById
    *
    __________________________________________________________________ */

    const sendButton = document.getElementById("buttonSend");
    const deleteButton = document.getElementById("buttonDeleteLast");
    const getListComment = document.getElementById("listComment");
    const getName = document.getElementById("inputGetName");
    const getComment = document.getElementById("inputGetComment");
    const hideSendForm = document.getElementById("hideForm");
    const hideTextForm = document.getElementById("hideText");
    
  /* ------------------------------------------------------------------
  *
                                getListComponent
  *
  __________________________________________________________________ */

  function getListComponent() {

      hideSendForm.style.display = "none";
      hideTextForm.style.display = "flex";

      return fetch("https://wedev-api.sky.pro/api/v1/illia-hryn/comments", {
          method: "GET",
      })
      .then((response) => {
          if (response.status === 500) {
              alert("error, try later...");
              return Promise.reject("Server is down");
          } else {
              return response.json();
          }
      })
      .then((responseData) => {
        
          const appComment = responseData.comments.map((comment) => {
 
          function sTime() {

              let specialTime = new Date(comment.date);
              let day = specialTime.getDate() % 100;
              if (day < 10) day = '0' + day;
              let Month = specialTime.getMonth() % 100;
              if (Month < 10) Month = '0' + (1 + Month);
              let Hours = specialTime.getHours() % 100;
              if (Hours < 10) Hours = '0' + Hours;
              let Minutes = specialTime.getMinutes() % 100;
              if (Minutes < 10) Minutes = '0' + Minutes;

              return fullDates = day + '.' + Month + '.' + specialTime.getFullYear() + ' ' + Hours + ':' + Minutes;
          }

          return {

                  name: comment.author.name,
                  date: sTime(comment.date),
                  text: comment.text,
                  likes: comment.likes,
                  isLiked: false,
              }
          })
          
          console.log(responseData);
          user = appComment;
          render();
          hideTextForm.style.display = "none";
          hideSendForm.style.display = "flex";
      })
      .catch((error) => {
        alert("Кажется, у вас сломался интернет, попробуйте позже");
        console.log(error);
      });

  }

  getListComponent();

  let user = [];

/* ------------------------------------------------------------------

                                 button event

__________________________________________________________________ */

const handerLike = () => {

    const btn = document.querySelectorAll(".like-button");

    for (const el of btn) {

        el.addEventListener('click', (event) => {

              event.stopPropagation();
                
              const index = el.dataset.index;

              if (user[index].isLiked === false) {
                ++user[index].likes, user[index].isLiked = true, user[index].like = '-active-like'
              } else {
                --user[index].likes, user[index].isLiked = false, user[index].like = ''
              }
                
          render();

        })
    }
}

/* ------------------------------------------------------------------

                                 surfacing
                                 
__________________________________________________________________ */

const surfacing = () => {

const comments = document.querySelectorAll(".comment");

  for (const el of comments) {

      el.addEventListener("click", () => {

      const comment = el.dataset.text;
      const commentsName = el.dataset.name;
      getComment.value = `> ${comment}
${commentsName},`;
      
      })

  }
}


/* ------------------------------------------------------------------
*
                                 RENDER
*
__________________________________________________________________ */

    const render = () => {
      const result = user.map((el, index) => {
          return `<li class="comment" data-index="${index}" data-comment="${el.text}" data-name="${el.name}">
                  <div class="comment-header">
                    <div>${el.name}</div>
                    <div>${el.date}</div>
                  </div>
                  <div class="comment-body">
                    <div class="comment-text data-index="${index}" data-comment="${el.text}" data-name="${el.name}">
                      ${el.text}
                    </div>
                  </div>
                  <div class="comment-footer">
                    <div class="likes">
                      <span data-cost="${el.likes}" class="likes-counter" ${el.like}>${el.likes}</span>
                      <button data-index="${index}" data-active="${el.isLiked}" class="like-button ${el.like}"></button>
                    </div>
                  </div>
                </li>
              `}).join('');
              
              getListComment.innerHTML = result;
              handerLike();
              surfacing();
    }

    render();

/* ------------------------------------------------------------------
*
                                 DATE
*
__________________________________________________________________ */

function myTime() {

      let myDate = new Date();
      let year = myDate.getFullYear() % 100;
      if (year < 10) year = '0' + year;
      let fullDate;
      return fullDate = myDate.getDate() + '.' + myDate.getMonth() + '.' + year + ' ' + myDate.getHours() + ':' + myDate.getMinutes();
  }

/* ------------------------------------------------------------------
*
                                    SEND
*
__________________________________________________________________ */

const sendBtn = () => {

        hideSendForm.style.display = "none";
        hideTextForm.style.display = "flex";
      
        if (getName.value != '' && getComment.value != '') {
          
            fetch("https://wedev-api.sky.pro/api/v1/illia-hryn/comments", {
            method: "POST",
            body: JSON.stringify({
                name: getName.value.replaceAll("<", "&lt").replaceAll(">","&gt").replaceAll('"', "&quot;").replaceAll("&", "&amp;"),
                text: getComment.value.replaceAll("<", "&lt").replaceAll(">","&gt").replaceAll('"', "&quot;").replaceAll("&", "&amp;"),
                forceError: true,
                }),
            })
            .then((response) => {

                if (response.status === 400) {
                    alert("Имя и комментарий должны быть не короче 3 символов");
                    hideTextForm.style.display = "none";
                    hideSendForm.style.display = "flex";
                    throw new Error("error input");
                } else {
                    return response;
                }
            })
            .then((response) => {
  
                if (response.status === 500) {
                    alert("server is down");
                    hideTextForm.style.display = "none";
                    hideSendForm.style.display = "flex";
                    throw new Error("500");
                } else {
                    return getListComponent();
                }
            })
            .then(() => {
                hideTextForm.style.display = "none";
                getName.value = "",
                getComment.value = "";
                hideSendForm.style.display = "flex";
            })
            .catch((error) => {
                if (error.message = 500){
                    console.log(error);
                    sendBtn();
                } else {
                    console.log('Type > 2 symbol: ',error);
                }
            });
        }
}

sendButton.addEventListener("click", sendBtn);

  </script>
</html>  