<!DOCTYPE html>
<html>
  <head>
  <title>Проект "Комменты"</title>
  <meta charset="utf-8" />
  <link rel="stylesheet" href="styles.css" />
</head>
<body>
  <div class="container">
    <ul class="comments" id="list">

    </ul>
    <p class="comments-list-loading">Подождите пожалуйста, комментарии загружаются...</p>
    <div class="add-form" id="add-form">
      <input type="text" class="add-form-name" placeholder="Введите ваше имя" value="" id="name-input" />
      <textarea type="textarea" class="add-form-text" placeholder="Введите ваш коментарий" rows="4"
        id="text-input"></textarea>
      <div class="add-form-row">
        <button class="add-form-button" id="add-button">Написать</button>
      </div>
    </div>
    <p class="comment-loading">Комментарий добавляется...</p>
</body>
<style>
  .error {
    background-color: gray;
    color: black;
  }

  .form-error {
    background-color: rgb(248, 204, 204);
    opacity: 0.9;
  }

  .quote {
    margin-bottom: 32px;
    padding: 15px 20px;
    white-space: pre-line;
    background: #d5d2d2;
    font-size: 16px;
    color: #000000;
    border-radius: 5px;
  }

  .hidden {
    display: none;
  }
</style>
<script>
  "use strict";

  const addButton = document.getElementById('add-button');
  const nameInputElement = document.getElementById('name-input');
  const textInputElement = document.getElementById('text-input');
  const listElement = document.getElementById('list');
  const addForm = document.querySelector('.add-form');
  const commentLoading = document.querySelector('.comment-loading');
  const commentsListElements = document.querySelector('.comments-list-loading');

  let comments = [];

  commentsListElements.classList.remove('hidden');
  commentLoading.classList.add('hidden');

  const fetchGetRender = () => {
    return fetch('https://webdev-hw-api.vercel.app/api/v1/dennis-sharin/comments', {
        method: 'GET',
      })
      .then((response) => {
        return response.json();
      })
      .then((responseData) => {
        comments = responseData.comments;
        renderComments();
      })
      .then(() => {
        commentsListElements.classList.add('hidden');
      })
  };


  const renderComments = () => {
    const commentsHtml = comments.map((comment, index) => {
      return `<li data-index=${index} class="comment">
          <div class="comment-header">
            <div>${comment.author.name}</div>
            <div>${getTime(comment.date)}</div>
          </div>
          <div class="comment-body">
            <div class="comment-text">
              ${comment.text}
            </div>
          </div>
          <div class="comment-footer">
            <div class="likes">
              <span class="likes-counter">${comment.likes}</span>
              <button data-index="${index}" class="like-button ${comment.isLiked ? '-active-like' : 'like-button'}"></button>
            </div>
          </div>
        </li>`;
    }).join('');

    listElement.innerHTML = commentsHtml;
    likeComment()
    newReply()
  };


  const getTime = (commentDate) => {
    let date = new Date(commentDate);
    let time = date.toTimeString().slice(0, 5);
    let day = (date.getDate() < 10) ? '0' + date.getDate() : date.getDate();
    let month = ((date.getMonth() + 1) < 10) ? '0' + (date.getMonth() + 1) : (date.getMonth() + 1);
    let year = Number(String(date.getFullYear()).substring(2));
    return day + '.' + month + '.' + year + ' ' + time;
  };


  const addComment = () => {
    let inputUserText = textInputElement.value;
    let inputUserName = nameInputElement.value;

    if (nameInputElement.value === '') {
      nameInputElement.classList.add('form-error');
      return
    } else if (textInputElement.value === '') {
      textInputElement.classList.add('form-error');
      return
    } else {
      addForm.classList.add('hidden');
      commentLoading.classList.remove('hidden');
      fetch('https://webdev-hw-api.vercel.app/api/v1/dennis-sharin/comments', {
        method: 'POST',
        body: JSON.stringify({
        name: replaceValue(nameInputElement.value),
        text: replaceValue(textInputElement.value)
          .replaceAll('QUOTE_BEGIN', '<div class="quote">')
          .replaceAll('QUOTE_END', '</div>'),
        forceError: true,
      })
    })
    .then((response) => {

      if (response.status === 500) {
        console.log('Ошибка 500');
        throw new Error('error500');
      }
      if (response.status === 400) {
        console.log('Ошибка 400');
        throw new Error('error400')
      }
      console.log('test ok');
      response.json();
    })
    .then(() => {
      return fetchGetRender();
    })
    .then(() => {
      addForm.classList.remove('hidden');
      commentLoading.classList.add('hidden');
    })
    .catch((error) => {
      console.log('catch is working here');
      switch (error.message) {
        case 'error500':
          textInputElement.value = inputUserName;
          nameInputElement.value = inputUserText;
          return addComment()
            break;
        case 'error400':
          alert('Минимальное количество введённых символов не должно быть меньше 3')
          textInputElement.value = inputUserName;
          nameInputElement.value = inputUserText;
          addForm.classList.remove('hidden');
          commentLoading.classList.add('hidden');
            break;
        default:
          console.log('Кажется сломался интернет')
          textInputElement.value = inputUserName;
          nameInputElement.value = inputUserText;
          addForm.classList.remove('hidden');
          commentLoading.classList.add('hidden');
            break;
      }

      return error

      addForm.classList.remove('hidden');
      commentLoading.classList.add('hidden');
      textInputElement.value = inputUserName;
      nameInputElement.value = inputUserText;
    })
  };
    nameInputElement.classList.remove('form-error');
    textInputElement.classList.remove('form-error');
    textInputElement.value = '';
    nameInputElement.value = '';
};


  const likeComment = () => {
    const likeButtons = document.querySelectorAll('.like-button');

    for (const likeButton of likeButtons) {
      likeButton.addEventListener('click', (event) => {

        event.stopPropagation();

        let index = likeButton.dataset.index;
        let counter = comments[index].likes;
        console.log(counter)
        if (!comments[index].isLiked) {
          counter += 1;
        } else {
          counter -= 1;
        }
        comments[index].isLiked = !comments[index].isLiked;
        comments[index].likes = counter;
        renderComments()
      });
    };
  };


  const newReply = () => {
    const commentElements = document.querySelectorAll('.comment');

    for (const commentElement of commentElements) {
      commentElement.addEventListener('click', () => {

        let index = commentElement.dataset.index;

        textInputElement.value =
          `QUOTE_BEGIN${comments[index].author.name} : ${comments[index].text.replaceAll('<div class="quote">', '').replaceAll('</div>', '')}QUOTE_END`;
      });
    };
  };


  const replaceValue = (value) => {
    return value
      .replaceAll("&", "&amp;")
      .replaceAll("<", "&lt;")
      .replaceAll(">", "&gt;")
      .replaceAll('"', "&quot;");
  };

  fetchGetRender()

  addButton.addEventListener('click', addComment)

  textInputElement.addEventListener('keyup', event => {
    if (event.key === 'Enter') {
      addComment();
    }
  });

  nameInputElement.addEventListener('keyup', event => {
    if (event.key === 'Enter') {
      addComment();
    }
  });
  console.log("It works!");
</script>

</html>