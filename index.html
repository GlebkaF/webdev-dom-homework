<!DOCTYPE html>
<html>

<head>
  <title>Проект "Комменты"</title>
  <meta charset="utf-8" />
  <link rel="stylesheet" href="styles.css" />
  <style>
    .error {
      background-color: red;
    }

    .disabled {
      background-color: gray;
      pointer-events: none;
    }

    .like-button.active {
      background-color: rgba(255, 0, 0, 0.566);
    }

    @keyframes rotating {
      from {
        transform: rotate(0deg);
      }

      25% {
        transform: rotate(30deg);
      }

      75% {
        transform: rotate(-30deg);
      }

      to {
        transform: rotate(0deg);
      }
    }

    .-loading-like {
      animation: rotating 2s linear infinite;
    }
  </style>
</head>

<body>
  <div class="container">
    <ul class="comments" id="comments-list">
    </ul>
    <div class="add-form">
      <input type="text" class="add-form-name" id="name-input" placeholder="Введите ваше имя" />
      <textarea type="textarea" class="add-form-text" id="comment-input" placeholder="Введите ваш комментарий"
        rows="4"></textarea>
      <div class="add-form-row">
        <button class="add-form-button" id="add-comment-button">Написать</button>
        <button class="deleteCommentButton" id="deleteCommentButton">Удалить последний комментарий</button>
      </div>
    </div>
  </div>

  <script>
    let addCommentButton = document.getElementById("add-comment-button");
    let nameInput = document.getElementById("name-input");
    let commentInput = document.getElementById("comment-input");
    let commentsList = document.getElementById("comments-list");
    let deleteCommentButton = document.getElementById("deleteCommentButton");
    let likeButtons = [];

    let isAddingComment = false;
    let pendingName = "";
    let pendingComment = "";

    function sanitizeInput(input) {
      return input.replaceAll("<", "&lt;").replaceAll(">", "&gt;");
    }

    function displayComments(comments) {
      const commentsList = document.getElementById("comments-list");
      commentsList.innerHTML = "";

      comments.forEach((comment) => {
        const { id, author, date, text, likes } = comment;
        const formattedDate = new Date(date).toLocaleString();

        

        const commentHtml = `
        <li class="comment" data-comment-id="${id}">
          <div class="comment-header">
            <div>${author.name}</div>
            <div>${formattedDate}</div>
          </div>
          <div class="comment-body">
            <div class="comment-text">${text}</div>
          </div>
          <div class="comment-footer">
            <div class="likes">
              <span class="likes-counter">${likes}</span>
              <button class="like-button"></button>
            </div>
          </div>
        </li>
      `;

        commentsList.innerHTML += commentHtml;
      });

      // Add event listeners to all like buttons
      likeButtons = document.querySelectorAll(".like-button");
      likeButtons.forEach((button) => {
        button.addEventListener("click", () => {
          handleLikeButtonClick(button);
        });
      });
    }

    async function addComment() {
      if (isAddingComment) {
        return;
      }

      const name = sanitizeInput(nameInput.value.trim());
      const comment = sanitizeInput(commentInput.value.trim());

      if (name.length < 3 || comment.length < 3) {
        alert("Имя и комментарий должны быть не короче 3 символов");
        return;
      }

      nameInput.classList.remove("error");
      commentInput.classList.remove("error");

      const currentDate = new Date();
      const formattedDate = `${currentDate.getDate()}.${currentDate.getMonth() + 1}.${currentDate.getFullYear()} ${currentDate.getHours()}:${currentDate.getMinutes()}`;

      const newComment = {
        name: name,
        author: { name: name },
        text: comment,
        date: formattedDate,
        likes: 0,
        isLiked: false,
      };

      isAddingComment = true;
      commentsList.textContent = "Добавляю...";
      addCommentButton.textContent = "Добавляю...";
      nameInput.value = "Добавляю...";
      commentInput.value = "Добавляю...";
      nameInput.disabled = true;
      commentInput.disabled = true;

      try {
        const response = await fetch("https://wedev-api.sky.pro/api/v1/atamyrat-isayev/comments", {
          method: "POST",
          body: JSON.stringify(newComment),
        });

        if (response.status === 400) {
          alert("Имя и комментарий должны быть не короче 3 символов");
          pendingName = name;
          pendingComment = comment;
        } else if (response.status === 500) {
          alert("Сервер сломался, попробуйте позже");
          pendingName = name;
          pendingComment = comment;
        } else {
          const responseData = await response.json();
          console.log("New comment added:", responseData);
          fetchComments();
          nameInput.value = "";
          commentInput.value = "";
        }
      } catch (error) {
        alert("Кажется, у вас сломался интернет, попробуйте позже");
        pendingName = name;
        pendingComment = comment;
      } finally {
        isAddingComment = false;

        if (pendingName !== "") {
          nameInput.value = pendingName;
        }
        if (pendingComment !== "") {
          commentInput.value = pendingComment;
        }

        addCommentButton.textContent = "Написать";
        nameInput.disabled = false;
        commentInput.disabled = false;

        pendingName = "";
        pendingComment = "";
      }
    }

    function handleLikeButtonClick(button) {
    const likesCounter = button.parentElement.querySelector(".likes-counter");
    const currentLikes = parseInt(likesCounter.textContent, 10);

    if (button.classList.contains("active")) {
      button.classList.remove("active", "loading-like");
      likesCounter.textContent = currentLikes - 1;
    } else {
      button.classList.add("active", "loading-like");
      likesCounter.textContent = currentLikes + 1;
    }

    setTimeout(() => {
      button.classList.remove("loading-like");
    }, 2000);
  }

  addCommentButton.addEventListener("click", addComment);

  deleteCommentButton.addEventListener("click", async () => {
    deleteCommentButton.textContent = "Удаляю...";

    // Check if there are comments to delete
    const lastComment = commentsList.lastElementChild;
    if (lastComment) {
      // Get the ID of the last comment from the data attribute
      const commentId = lastComment.getAttribute("data-comment-id");

      try {
        // Delete the last comment from the API
        await fetch(`https://wedev-api.sky.pro/api/v1/atamyrat-isayev/comments/${commentId}`, {
          method: "DELETE",
        });

        // Remove the last comment from the UI
        commentsList.removeChild(lastComment);

        deleteCommentButton.textContent = "Удалить последний комментарий";
      } catch (error) {
        console.error("Error deleting comment:", error);
        alert("Ошибка при удалении комментария");
        deleteCommentButton.textContent = "Удалить последний комментарий";
      }
    }
  }); 

    addCommentButton.addEventListener("click", addComment);

    deleteCommentButton.addEventListener("click", async () => {
      deleteCommentButton.textContent = "Удаляю...";

      // Check if there are comments to delete
      const lastComment = commentsList.lastElementChild;
      if (lastComment) {
        // Get the ID of the last comment from the data attribute
        const commentId = lastComment.getAttribute("data-comment-id");

        try {
          // Delete the last comment from the API
          await fetch(`https://wedev-api.sky.pro/api/v1/atamyrat-isayev/comments/${commentId}`, {
            method: "DELETE",
          });

          // Remove the last comment from the UI
          commentsList.removeChild(lastComment);

          deleteCommentButton.textContent = "Удалить последний комментарий";
        } catch (error) {
          console.error("Error deleting comment:", error);
          alert("Ошибка при удалении комментария");
          deleteCommentButton.textContent = "Удалить последний комментарий";
        }
      }
    });

    async function fetchComments() {
      try {
        const response = await fetch("https://wedev-api.sky.pro/api/v1/atamyrat-isayev/comments");

        if (response.status === 500) {
          alert("Сервер сломался, попробуйте позже");
          return;
        }

        const comments = await response.json();
        displayComments(comments.comments);
      } catch (error) {
        alert("Кажется, у вас сломался интернет, попробуйте позже");
      }
    }

    fetchComments();
  </script>
</body>

</html>
