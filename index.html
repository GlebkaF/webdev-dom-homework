<!DOCTYPE html>
<html>
  <head>
    <title>Проект "Комменты"</title>
    <meta charset="utf-8" />
    <link rel="stylesheet" href="styles.css" />
  </head>

  <body id="body">
    <div class="container">
      <ul class="comments" id="comment-list">
        
      </ul>
      <div class="add-form" id="forma">
        <input
          type="text"
          id="form-name"
          class="add-form-name"
          placeholder="Введите ваше имя"
        />
        <textarea
          id="form-text"
          type="textarea"
          class="add-form-text"
          placeholder="Введите ваш коментарий"
          rows="4"
        ></textarea>
        <div class="add-form-row">
          <button class="add-form-button" id="add-form-button">Написать</button>
        </div>
        <div class="add-form-row">
          <!--<button class="delete-form-button" id="delete-form-button">Удалить последний коммент</button>-->
        </div>
      </div>
    </div>
  </body>

  <script>
    "use strict";


    // Получаем дату и время

    function getCurrentDate(date) {

      let year = date.getFullYear().toString().slice(-2); // Получаем последние две цифры года
      let month = (date.getMonth() + 1 < 10) ? '0' + (date.getMonth() + 1) : (date.getMonth() + 1); // Получаем месяц с ведущим нулем, если нужно
      let day = (date.getDate() < 10) ? '0' + date.getDate() : date.getDate(); // Получаем день с ведущим нулем, если нужно
      let hours = (date.getHours() < 10) ? '0' + date.getHours() : date.getHours(); // Получаем часы с ведущим нулем, если нужно
      let minutes = (date.getMinutes() < 10) ? '0' + date.getMinutes() : date.getMinutes(); // Получаем минуты с ведущим нулем, если нужно

      let formattedDate = day + '.' + month + '.' + year; // Склеиваем день, месяц и год в нужном формате
      let formattedTime = hours + ':' + minutes; // Склеиваем часы и минуты в нужном формате

      let currentDate = formattedDate + ' ' + formattedTime;
      return currentDate;

      //console.log(formattedDate + ' в ' + formattedTime); // Выводим отформатированную дату и время
      }

    


    // Запрет на действие по умолчанию для textArea - gthеход на новую строку. Иначе функция addComment будет выполняться, 
    // если заполнено поле с именеи и в поле комментария есть переход на новую строку

    const textArea = document.getElementById('form-text').addEventListener('keydown', (event) => {
      if (event.key === 'Enter') {
        event.preventDefault(); 
      }
    })




    // Получаем все необходимые элементы
    const baseUrl = "https://wedev-api.sky.pro/api/v1/pavel-fedotov/";
    const body = document.querySelector(".container");
    //console.log(body);
    const commentList = document.getElementById('comment-list');
    const buttonAddComment = document.getElementById('add-form-button');
    const inputName = document.getElementById('form-name');
    const inputText = document.getElementById('form-text');
    const formaComment = document.getElementById('forma');
    const buttonDeleteComment = document.getElementById('delete-form-button');
    let isLoaded;

    // const fetchPromise = fetch("https://wedev-api.sky.pro/api/tasks/random-red", {
    //   method: "GET",
    // });

    // console.log(fetchPromise);

    // fetchPromise.then((response) => {
    //   console.log(response);

    //   const jsonPromise = response.json();

    //   jsonPromise.then((responseData) => {
    //      console.log(responseData);

    //      body.style.backgroundColor = responseData.color;
    //   });
    // });

    let comments = [
      // {
      //   text: 'Это будет первый комментарий на этой странице',
      //   author: 'Глеб Фокин',
      //   date: '12.02.22 12:18',
      //   likeCount: 3,
      //   myLike: true,
      //   isEdit: false
      // },
      // {
      //   text: 'Мне нравится как оформлена эта страница! ❤',
      //   author: 'Варвара Н.',
      //   date: '13.02.22 19:22',
      //   likeCount: 75,
      //   myLike: false,
      //   isEdit: false
      // }
    ]

    const fetchPromiseComments = fetch(`${baseUrl}comments`, {
      method: "GET",
    });

    //console.log(fetchPromiseComments);

    fetchPromiseComments.then((result) => {
      //console.log(result);

      const resultJSON = result.json();

      resultJSON.then((resultData) => {
        //console.log(resultData.comments);
        const resultComments = resultData.comments.map((comment) => {
          //console.log(comment.author.name);
          let currentDate = getCurrentDate(new Date(comment.date));
          return {
            author: comment.author.name,
            date: currentDate,
            text: comment.text,
            likeCount: comment.likes,
            myLike: comment.isLiked
          };
        });
        comments = resultComments;
        renderComments();
        
      });
    });

    // const jsonArr = JSON.stringify(comments);
    // console.log(jsonArr);

    // const arrFromJson = JSON.parse(jsonArr);
    // console.log(arrFromJson);

    // Функция ответа на комментарий

    // const initAnswerComment = () => {
    //   const textComments = document.querySelectorAll(".comment-text");

    //   for (const textComment of textComments) {
    //     textComment.addEventListener("click", () => {
    //       //console.log(textComment.innerHTML);
    //       let index = textComment.dataset.index;
          
    //       inputText.value = '> ' + comments[index].text + '\n' + comments[index].author + ', ';
    //     })
    //   }
    // }

    function initAnswerComment2() {
      const commentTexts = document.querySelectorAll(".comment-text");

      commentTexts.forEach((commentText, index) => {
        commentText.addEventListener("click", () => {
          inputText.value = '> ' + comments[index].text + '\n' + comments[index].author + ', ';
        })
      })
    }

    // Функция разблокировки кнопки "Написать", если поле с именем не пустое

    inputName.addEventListener('input', () => {
      buttonAddComment.disabled = false;
    })

    // Функция разблокировки кнопки "Написать", если поле с текстом комментария не пустое

    inputText.addEventListener('input', () => {
      buttonAddComment.disabled = false;
    })

    // Функция добавления лайка

    const ititAddLikeListener = () => {
      const likeButtons = document.querySelectorAll(".like-button");

      for (const likeButton of likeButtons) {
        likeButton.addEventListener('click', () => {
          let index = likeButton.dataset.islike;
          
          if (comments[index].myLike) {
            comments[index].myLike = false;
            comments[index].likeCount--;
          } else {
            comments[index].myLike = true;
            comments[index].likeCount++;
          }
          
          renderComments();
        })
      }
    }

    // Функция изменения комментария - вызов по кнопке "Редактировать"

    const initEditCommentListener = () => {
      const editButtons = document.querySelectorAll(".comment-text-edit");

      for (const editButton of editButtons) {
        editButton.addEventListener('click', () => {
          let index = editButton.dataset.edit;

          comments[index].isEdit = true;
          renderComments();
        })
      }
    }

      // Функция сохранения изменений в комментарии - вызов по кнопке "Сохранить"

    const initSaveEditCommentListener = () => {
      const saveButtons = document.querySelectorAll(".comment-text-save");

      for (const saveButton of saveButtons) {
        saveButton.addEventListener('click', () => {
          let index = saveButton.dataset.edit;
          const inputText = document.getElementById('form-text');

          comments[index].text = inputText.value;
          comments[index].isEdit = false;

          renderComments();
        })
      }
    }


    // Функция рендера комментариев

    const renderComments = () => {
      const CommentsHtml = comments.map((comment, index) => {
        let isLike;
        let inputTextHtml;
        let textButtonEditSave;
        let classButtonEditSave;
        comment.myLike ? isLike = "-active-like" : false
        
        comment.isEdit ? textButtonEditSave = "Сохранить" : textButtonEditSave = "Редактировать"
        comment.isEdit ? classButtonEditSave = "comment-text-save" : classButtonEditSave = "comment-text-edit"
        comment.isEdit ? inputTextHtml = `<textarea id="form-text" type="textarea" class="add-form-text" placeholder="Введите ваш коментарй" rows="4">${comment.text}</textarea>` : inputTextHtml = `<div data-index="${index}" class="comment-text">${comment.text}</div>`;

        if (isLoaded) {
          return `<li class="comment">
                  <div class="comment-body">
                    Комментарий добавляется...
                  </div>
                </li>`;
        } else {
          return `<li class="comment">
                  <div class="comment-header">
                    <div>${comment.author}</div>
                    <div>${comment.date}</div>
                  </div>
                  <div class="comment-body">
                    ${inputTextHtml}
                  </div>
                  <button data-edit="${index}" class="${classButtonEditSave}">${textButtonEditSave}</button>
                  <div class="comment-footer">
                    <div class="likes">
                      <span class="likes-counter">${comment.likeCount}</span>
                      <button class="like-button ${isLike}" id="like-button" data-islike="${index}"></button>
                    </div>
                  </div>
                </li>`;
        }
        
                
      }).join("");
      commentList.innerHTML = CommentsHtml;
      ititAddLikeListener();
      initEditCommentListener();
      initSaveEditCommentListener();
      //initAnswerComment();
      initAnswerComment2();
    };

    renderComments();



    // Функция отправки комментария

    function addComment(event) {

      if (event.type === 'click' || (event.type === 'keyup' && event.key === 'Enter'))  {

        const oldCommentList = commentList.innerHTML;

        if (inputName.value === '' && inputText.value !== '') {
          inputName.classList.add('error-form');
          inputText.classList.remove('error-form');
          buttonAddComment.disabled = true;
          return;} 
          
        else if (inputText.value === '' && inputName.value !== '') {
          inputText.classList.add('error-form');
          inputName.classList.remove('error-form');
          buttonAddComment.disabled = true;
          return;} 
        
        else if (inputName.value === '' && inputText.value === '') {
          inputName.classList.add('error-form');
          inputText.classList.add('error-form');
          buttonAddComment.disabled = true;
          return;
        }

        inputName.classList.remove('error-form');
        inputText.classList.remove('error-form');
        
        let currentDate = getCurrentDate(new Date());

        // comments.push({
        //   text: inputText.value.replaceAll("<", "&lt;").replaceAll(">", "&gt;"),
        //   author: inputName.value.replaceAll("<", "&lt;").replaceAll(">", "&gt;"),
        //   date: currentDate,
        //   likeCount: 0,
        //   myLike: false,
        //   isEdit: false
        // });

        isLoaded = true;
        console.log(isLoaded);

        const fetchPromises = fetch(`${baseUrl}comments`, {
          method: "POST",
          body: JSON.stringify({
            text: inputText.value,
            name: inputName.value,
            date: currentDate,
            likes: 0,
            isLiked: false
          }),
        });

        console.log(fetchPromises);

        fetchPromises.then((resultComments) => {
          //console.log(resultComments);

          resultComments.json().then((resultCommentsData) => {
            const fetchPromiseComments = fetch(`${baseUrl}comments`, {
              method: "GET",
            });
    
            //console.log(fetchPromiseComments); 
            fetchPromiseComments.then((result) => {
              //console.log(result);
              const resultJSON = result.json();
              
              resultJSON.then((resultData) => {
                //console.log(resultData.comments);
                const resultComments = resultData.comments.map((comment) => {
                  //console.log(comment.author.name);
                  let currentDate = getCurrentDate(new Date(comment.date));
                  
                  return {
                    author: comment.author.name,
                     date: currentDate,
                    text: comment.text,
                    likeCount: comment.likes,
                    myLike: comment.isLiked
                  };
                });
                isLoaded = false;
                console.log(isLoaded);
                comments = resultComments;
                renderComments();
              });
            });
          });
        });
        

        inputName.value = '';
        inputText.value = '';

        renderComments();
        
      }
    }

    // buttonDeleteComment.addEventListener('click', () => {
      
    //   let arrList = Array.from(commentList.children)
    //   //const lastComment = commentList.innerHTML.lastIndexOf();
    //   console.log(arrList);
    //   arrList = arrList.pop();

    //   console.log(arrList);
    //   console.log(commentList);

    //   commentList.innerHTML = String.from(arrList);
    //   //commentList.innerHTML = arrList;
      
    //   //commentList.innerHTML = commentList - lastComment;
    // });


    buttonAddComment.addEventListener('click', addComment);
    formaComment.addEventListener('keyup', addComment);


  </script>
</html>
