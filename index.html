<!DOCTYPE html>
<html>
  <head>
    <title>Проект "Комменты"</title>
    <meta charset="utf-8" />
    <link rel="stylesheet" href="styles.css" />
  </head>

  <body id="body">
    <div class="container">
      <ul class="comments" id="comments">
      </ul>
      <div class="add-form" id="add-form">
        <input
          id="add-form-name"
          type="text"
          class="add-form-name"
          placeholder="Введите ваше имя"
        />
        <!-- <textarea id="quote"></textarea> -->
        <textarea
          id="add-form-text"
          type="textarea"
          class="add-form-text "
          placeholder="Введите ваш коментарий"
          rows="4"
        ></textarea>
        <div class="add-form-row">
          <button class="add-form-button" id="add-form-button" >Написать</button>
        </div>
      </div>
      <button class="delete-comment-button" id="delete-comment-button" >Удалить последний комментарий</button>

    </div>
  </body>

  <script>
    // "use strict";
    const commentsElement = document.getElementById("comments");
    const addFormButtonElement = document.getElementById("add-form-button");
    const nameInputElement = document.getElementById("add-form-name");
    const textInputElement = document.getElementById("add-form-text");
    const form = document.getElementById("add-form");
    const deleteCommentButton = document.getElementById("delete-comment-button");
    let quote = "";
    let currentDate = new Date();

    const plusZero = (str) => {
      return str < 10 ? `0${str}` : str;
    };

    const now = (currentDate) => {
        let date = plusZero(currentDate.getDate());
        let month = plusZero(currentDate.getMonth() + 1);
        let hours = plusZero(currentDate.getHours());
        let mins = plusZero(currentDate.getMinutes());
        return `${date}.${month}.${currentDate.getFullYear() % 100} ${hours}:${mins}`;
      };



let comments = [
      // {
      //   name: `Глеб Фокин`,
      //   date: `12.02.22 12:18`,
      //   quote: '',
      //   comment: `Это будет первый комментарий на этой странице`,
      //   like: 3,
      //   activeLike: false,
      //   changeButton: false,

      // },
      // {
      //   name: `Варвара Н.`,
      //   date: `13.02.22 19:22`,
      //   quote: '',
      //   comment: `Мне нравится как оформлена эта страница! ❤`,
      //   like: 75,
      //   activeLike: false,
      //   changeButton: false,
      // },
    ];

    const fetchPromise = fetch("https://wedev-api.sky.pro/api/v1/skorik-marina/comments", {
      method: "GET"
    });

    // подписываемся на успешное завершение запроса с помощью then
    fetchPromise.then((response) => {
      // Запускаем преобразовываем "сырые" данные от API в json формат
      const jsonPromise = response.json();

      // Подписываемся на результат преобразования
      jsonPromise.then((responseData) => {

        const appComments = responseData.comments.map((comment) => {
          return {
            name: comment.author.name,
            date:  now (new Date (comment.date)),
            text: comment.text,
            likes: 0,
            activeLike: false,
            changeButton: false,

          }
        })
        // получили данные и рендерим их в приложении
        console.log(responseData);
        // comment = responseData.comment;
        comments = appComments;
        renderComment();
      });
    });



const changeComment = () => {
  const changeCommentBottons = document.querySelectorAll(".change-comment-button");
  for (const changeCommentBotton of changeCommentBottons) {
    changeCommentBotton.addEventListener('click', () => {
      console.log('f');
      const commentButton = comments[changeCommentBotton.dataset.index];
      commentButton.changeButton  = true ;
      renderComment();
      // document.querySelectorAll(".change-form-text").focus();
    })
  } 
};

const saveChangeComment = () => {
  const saveChangeCommentBottons = document.querySelectorAll(".save-comment-button");
  for (const saveChangeCommentBotton of saveChangeCommentBottons) {
    saveChangeCommentBotton.addEventListener('click', () => {
      console.log('qqq');
      const comment = comments[saveChangeCommentBotton.dataset.index];
      comment.changeButton = false ;
      const saveFormText = saveChangeCommentBotton
      .closest(".comment")
      .querySelector(".change-form-text");
      comment.text = saveFormText.value;
      fetch("https://wedev-api.sky.pro/api/v1/skorik-marina/comments", {
        method: "POST",
        body: JSON.stringify({
          name: comment.name,
          text: comment.text
            .replace(`"${quote}"\n`, "")
            .replaceAll("&", "&amp;")
            .replaceAll("<", "&lt;")
            .replaceAll(">", "&gt;")
            .replaceAll('"', "&quot;"),
        })
        // JSON.stringifylikes:
      }).then((response) => {
        response.json().then((responseData) => {

          fetch("https://wedev-api.sky.pro/api/v1/skorik-marina/comments", {
            method: "GET"  
          }).then((response) => {
      // Запускаем преобразовываем "сырые" данные от API в json формат
        response.json().then((responseData) => {

        const appComments = responseData.comments.map((comment) => {
          return {
            name: comment.name,
            date: now (new Date (comment.date)),
            text: comment.text,
            likes: 0,
            activeLike: false,
          };
        });
        // // получили данные и рендерим их в приложении
        // console.log(responseData);
        comment = responseData.text;
        comments = appComments;
        renderComment();
          });
        });
      });
    });
      // let currentDate = new Date();
      // comment.date = now(currentDate);
      renderComment();
    })
  }
};

const clickLike = () => {
  const likeButtons = document.querySelectorAll(".like-button");
    for (const likeButton of likeButtons) {
      likeButton.addEventListener('click', () => {
        console.log('d')
        const newLike = comments[likeButton.dataset.index];
        newLike.activeLike ? --newLike.likes : ++newLike.likes;
        newLike.activeLike = !newLike.activeLike;
        renderComment();
      })
    }
};


const replyToComment = () => {
  const commentBodys = document.querySelectorAll(".comment-body");
    for (const commentBody of commentBodys) {
      commentBody.addEventListener ('click', () => {
        const oldComment =  commentBody.dataset.text;
        const oldName = commentBody.dataset.name;
        const quote = `${oldComment}\n${oldName}: `;
        // quote.value = ;
        textInputElement.value += `"${quote}"\n`;

      })
  }
};



const renderComment = () => {
  const newComments = comments.map ((comment, index) => {
    return `<li class="comment">
        <div class="comment-header">
          <div>${comment.name}</div>
          <div>${comment.date}</div>
        </div>
          ${comment.quote ? `<div class=quote> ${quote}</div>` : ""}
          ${
            comment.changeButton ? 
            `<textarea
            tipe = "textarea"
            class = "change-form-text"
            rows = 3
            autofocus> ${comment.text}</textarea>`
            : `<div class="comment-body"  data-text="${comment.text}" data-name="${comment.name}">
                <div class="comment-text">
                  ${comment.text}
                </div>
              </div>`}
        <div class="comment-footer">
          ${comment.changeButton 
            ? `<button class="save-comment-button" data-index="${index}">Сохранить</button>` 
            : `<button class="change-comment-button" data-index="${index}">Изменить</button>`}
          <div class="likes">
            <span class="likes-counter">${comment.likes}</span>
            <button data-index="${index}" class='${comment.activeLike ? "like-button -active-like" : "like-button"}'></button>
          </div>
        </div>
      </li>`;
  }).join('');
  commentsElement.innerHTML = newComments;
  clickLike();
  changeComment();
  saveChangeComment();
  replyToComment();
}

renderComment();





addFormButtonElement.classList.add("empty");
addFormButtonElement.disabled = true;

  const check = (elem) => {
    elem.addEventListener ('input', () => {
  if (textInputElement.value === "" || nameInputElement.value === "") {
    addFormButtonElement.classList.add("empty");
    addFormButtonElement.disabled = true;
  } else {
    addFormButtonElement.classList.remove("empty");
    addFormButtonElement.disabled = false;
  }});
  }

  check(textInputElement)
  check(nameInputElement)



nameInputElement.addEventListener ('input',() => {
  if (nameInputElement.value !== ""){
    nameInputElement.classList.remove("emptyTextName");
  }
});

textInputElement.addEventListener ('input',() => {
  if (textInputElement.value !== ""){
    textInputElement.classList.remove("emptyTextName");
  }
});



const addNewComment = () => {
textInputElement.classList.remove("emptyTextName");
nameInputElement.classList.remove("emptyTextName");


if (nameInputElement.value === "" && textInputElement.value === ""){
  textInputElement.classList.add("emptyTextName");
  nameInputElement.classList.add("emptyTextName");
  return;
} else if (textInputElement.value === "") {
  textInputElement.classList.add("emptyTextName");
  return;
} else if (nameInputElement.value === "") {
  nameInputElement.classList.add("emptyTextName");
  return;
};


// comments.push(
//   {
//     name: nameInputElement.value
//     .replaceAll("&", "&amp;")
//     .replaceAll("<", "&lt;")
//     .replaceAll(">", "&gt;")
//     .replaceAll('"', "&quot;"),
//     date: now(currentDate),
//     quote: quote,
//     comment: textInputElement.value
//     .replace(`"${quote}"\n`, "")
//     .replaceAll("&", "&amp;")
//     .replaceAll("<", "&lt;")
//     .replaceAll(">", "&gt;")
//     .replaceAll('"', "&quot;"),
//     // .replaceAll(`"`, "<div class=quote>")
//     // .replaceAll(`"`, "</div>"),
//     like: 0,
//     activeLike: false,
//     changeButton: false,
//   });

  // buttonElement.addEventListener("click", () => {
  //     if (textInputElement.value === "") {
  //       return;
  //     }

      // подписываемся на успешное завершение запроса с помощью then
      fetch("https://wedev-api.sky.pro/api/v1/skorik-marina/comments", {
        method: "POST",
        body: JSON.stringify({
          name: nameInputElement.value
            .replaceAll("&", "&amp;")
            .replaceAll("<", "&lt;")
            .replaceAll(">", "&gt;")
            .replaceAll('"', "&quot;"),
          text: textInputElement.value
            .replace(`"${quote}"\n`, "")
            .replaceAll("&", "&amp;")
            .replaceAll("<", "&lt;")
            .replaceAll(">", "&gt;")
            .replaceAll('"', "&quot;"),
        })
        // JSON.stringifylikes:
      }).then((response) => {
        response.json().then((responseData) => {

          fetch("https://wedev-api.sky.pro/api/v1/skorik-marina/comments", {
            method: "GET"  
          }).then((response) => {
      // Запускаем преобразовываем "сырые" данные от API в json формат
        response.json().then((responseData) => {

        const appComments = responseData.comments.map((comment) => {
          return {
            name: comment.author.name,
            date: now (new Date (comment.date)),
            text: comment.text,
            likes: 0,
            activeLike: false,
          };
        });
        // // получили данные и рендерим их в приложении
        // console.log(responseData);
        comment = responseData.text;
        comments = appComments;
        renderComment();
          });
        });
      });
    });

renderComment();

textInputElement.value = "";
nameInputElement.value = "";
}

addFormButtonElement.addEventListener("click", addNewComment);

form.addEventListener("keyup", (e) => {
  if (e.code === "Enter") addNewComment();
});



deleteCommentButton.addEventListener('click', () => {
  comments.pop();
  renderComment();
});



  </script>
</html>
