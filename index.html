<!DOCTYPE html>
<html>
  <head>
    <title>Проект "Комменты"</title>
    <meta charset="utf-8" />
    <link rel="stylesheet" href="styles.css" />
  </head>

  <body>
    <div class="container">
      <ul class="comments">
        
      </ul>
      <div class="add-form">
        <input
          type="text" id="name-input"
          class="add-form-name"
          placeholder="Введите ваше имя" 
        />
        <textarea id="comment-input"
          type="textarea"
          class="add-form-text"
          placeholder="Введите ваш коментарий"
          rows="4"
        ></textarea>
        <div class="add-form-row">
          <button class="add-form-button">Написать</button>

          <div class="loading-message"></div>
          <ul class="comments"></ul>
          

        </div>
      </div>
    </div>
  </body>

  <script>
    "use strict";
  // 1. нужно найти элементы формы DOM с помощью метода document.querySelector(), используя добавленные id:
  // Получаем элементы формы и список комментариев из DOM
const nameInput = document.querySelector('#name-input');
const commentInput = document.querySelector('#comment-input');
const addButton = document.querySelector('.add-form-button');
const commentsList = document.querySelector('.comments');
const loadingMessage = document.querySelector('.loading-message');
let isLoading = true;
//const likeButtons = document.querySelectorAll('.like-button');

let comments = [];

let getComments = () => {
  fetch("https://wedev-api.sky.pro/api/v1/kristina-sapega/comments", {
    method: "GET",
  })
    .then((response) => response.json())
    .then((responseData) => {
      const appComments = responseData.comments.map((comment) => {
        return {
          id: comment.id,
          name: comment.author.name,
          date: new Date(comment.date),
          text: comment.text,
          likes: comment.likes,
          liked: false,
        };
      });
      comments = appComments;
      isLoading = false;
      renderComments();
    })
};

getComments();



  const renderComments = () => {
  commentsList.innerHTML = "";

  if (isLoading) {
    loadingMessage.textContent = "Пожалуйста, подождите, загружаю комментарии...";
    return;
  }
  

    comments.forEach((comment) => {
    const newComment = document.createElement("li");
    newComment.classList.add("comment");
  
  const likeButtonClass = comment.liked ? "like-button -active-like" : "like-button";

   
    
    // Добавление кнопки "Редактировать" и "Сохранить"
    const editButton = document.createElement("button");
    editButton.classList.add("edit-button");
    editButton.textContent = "Редактировать";

    const saveButton = document.createElement("button");
    saveButton.classList.add("save-button");
    saveButton.textContent = "Сохранить";
    saveButton.style.display = "none"; // Изначально скрываем кнопку "Сохранить"

    // Добавление поля ввода (textarea) для редактирования текста комментария
    const textarea = document.createElement("textarea");
    textarea.classList.add("edit-textarea");
    textarea.value = comment.text;
    textarea.style.display = "none"; // Изначально скрываем поле ввода

    const dateAndTime = `${comment.date.toLocaleDateString()} ${comment.date.toLocaleTimeString()}`;
    newComment.innerHTML = `
      <div class="comment-header">
        <div>${comment.name}</div>
        <div>${dateAndTime}</div>
      </div>
      <div class="comment-body">
        <div class="comment-text">
          ${comment.text}
        </div>
      </div>
      <div class="comment-footer">
        <div class="likes">
          <span class="likes-counter">${comment.likes}</span>
          <button class="${likeButtonClass}" data-comment-id="${comment.id}"></button>
          <div class="edit-buttons">
      <button class="edit-button" data-comment-id="${comment.id}">Редактировать</button>
        </div>
      </div>
    `;

    // Добавление обработчиков событий для кнопок редактирования и сохранения
    editButton.addEventListener("click", () => {
      comment.isEdit = true; // Изменяем значение isEdit на true
      editButton.style.display = "none"; // Скрываем кнопку "Редактировать"
      saveButton.style.display = "inline-block"; // Показываем кнопку "Сохранить"
      textarea.style.display = "block"; // Показываем поле ввода
    });

    saveButton.addEventListener("click", () => {
      const updatedText = textarea.value;
      comment.text = updatedText; // Обновляем текст комментария
      comment.isEdit = false; // Изменяем значение isEdit на false
      editButton.style.display = "inline-block"; // Показываем кнопку "Редактировать"
      saveButton.style.display = "none"; // Скрываем кнопку "Сохранить"
      textarea.style.display = "none"; // Скрываем поле ввода
      renderComments(); // Перерисовываем комментарии для отображения изменений
    });

    commentsList.appendChild(newComment);

    newComment.addEventListener("click", () => {
    // При клике на комментарий, заполняем поля формы добавления комментария данными комментария
    nameInput.value = '';
    commentInput.value = `@${comment.name}, ${comment.text}:`;
    commentInput.focus();
    });
    commentsList.appendChild(newComment);
  });




    // Найти кнопку лайка внутри текущего комм
    const likeButtons = document.querySelectorAll('.like-button');
    likeButtons.forEach((button) => {
    button.addEventListener('click', (event) => {
      event.stopPropagation();
    // Получаем идентификатор комментария из атрибута data-comment-id кнопки лайка
    const commentId = parseInt(button.dataset.commentId);
    // Находим комментарий в массиве comments по идентификатору
    const comment = comments.find((c) => c.id === commentId);

      // Если комментарий уже был отмечен как понравившийся, уменьшаем счетчик лайков
      // Если комментарий не был отмечен, увеличиваем счетчик лайков
      if (comment.liked) {
        comment.likes--;
      } else {
        comment.likes++;
      }
      // Инвертируем значение свойства liked у комментария
      comment.liked = !comment.liked;

      // Перерисовываем список комментариев для отображения обновленных данных
      renderComments();
    });
  });
};


addButton.addEventListener('click', function() {
  if (nameInput.value.trim() === '' || commentInput.value.trim() === '') {
    alert('Заполните все поля ввода!');
    return;
  }
// Скрытие формы добавления комментария и отображение сообщения "Комментарий добавляется ..."
  nameInput.disabled = true;
  commentInput.disabled = true;
  addButton.disabled = true;
  loadingMessage.textContent = "Комментарий добавляется...";
  

  const now = new Date();
  const dateString = `${now.getDate()}.${now.getMonth() + 1}.${now.getFullYear()} ${now.getHours()}:${now.getMinutes()}`;

  const newComment = {
    id: comments.length + 1,
    author: nameInput.value.
    replaceAll("<", "&lt;")
    .replaceAll(">", "&gt;")
    .replaceAll("&", "&amp;")
    .replaceAll('"', "&quot;"),
    date: dateString,
    text: commentInput.value
    .replaceAll("<", "&lt;")
    .replaceAll(">", "&gt;")
    .replaceAll("&", "&amp;")
    .replaceAll('"', "&quot;"),
    likes: "0",
    liked: false
  };

  //comments.push(newComment);
  //renderComments();

  addButton.disabled = true;
  addButton.textContent = "Элемент добавляется...";

  // Отправляем новый комментарий на сервер через POST-запрос
  function addComments() {
  fetch("https://wedev-api.sky.pro/api/v1/kristina-sapega/comments", {
    method: "POST",
    body: JSON.stringify({
      name: nameInput.value,
      text: commentInput.value,
    }),
  })
    .then((response) => response.json())
    .then((responseData) => {
      return fetch("https://wedev-api.sky.pro/api/v1/kristina-sapega/comments");
    })
    .then((response) => response.json())
    .then((responseData) => {
      comments = responseData.comments;
      getComments();
      addButton.disabled = false;
      addButton.textContent = "Добавить";
    });
  }

addComments();
renderComments();


  // очищаем поля ввода
  nameInput.value = "";
  commentInput.value = "";
});


  
    //console.log("It works!");
  </script>
</html>



