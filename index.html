<!DOCTYPE html>
<html>
  <head>
    <title>Проект "Комменты"</title>
    <meta charset="utf-8" />
    <link rel="stylesheet" href="styles.css" />
  </head>

  <body>
    <div class="container">
      <ul class="comments" id="comments-list"></ul>
      <div class="add-form" id="form">
        <input
          type="text"
          class="add-form-name"
          placeholder="Введите ваше имя"
          id="user-name" />
        <textarea
          type="textarea"
          class="add-form-text"
          placeholder="Введите ваш коментарий"
          rows="4"
          id="user-text"></textarea>
        <div class="add-form-row">
          <button class="add-form-button" id="button-form">Написать</button>
        </div>
      </div>
      <div>
        <button class="add-form-button" id="delete-button">
          Удалить последний комментарий
        </button>
      </div>
    </div>
  </body>

  <script>
    "use strict";
    const listElement = document.getElementById("comments-list");
    const buttonElement = document.getElementById("button-form");
    const nameInputElement = document.getElementById("user-name");
    const textInputElement = document.getElementById("user-text");
    const formElement = document.getElementById("form");
    const deleteButtonElement = document.getElementById("delete-button");
    let date = new Date();
    const formattedDate =
      date.getDate().toString().padStart(2, "0") +
      "." +
      (date.getMonth() + 1).toString().padStart(2, "0") +
      "." +
      date.getFullYear().toString().slice(-2) +
      " " +
      date.getHours().toString().padStart(2, "0") +
      ":" +
      date.getMinutes().toString().padStart(2, "0");

    let comments = [];

    const fetchPromise = fetch(
      "https://wedev-api.sky.pro/api/v1/qwitchers/comments",
      {
        method: "GET",
      }
    );

    fetchPromise.then((responce) => {
      responce.json().then((responceData) => {
        const appComments = responceData.comments.map((comment) => {
          return {
            name: comment.author.name,
            date: new Date(comment.date),
            text: comment.text,
            likes: comment.likes,
            isLiked: false,
          };
        });
        comments = appComments;
        renderComments();
      });
    });

    const copyComment = () => {
      const commentsElement = document.querySelectorAll(".comment");

      for (const comment of commentsElement) {
        comment.addEventListener("click", () => {
          textInputElement.value =
            `> ${comment
              .querySelector(".comment-text")
              .innerHTML.replaceAll("&amp;", "&")
              .replaceAll("&lt;", "<")
              .replaceAll("&gt;", ">")
              .replaceAll("&quot;", '"')}` +
            `\n\n${comment
              .querySelector(".comment-header")
              .children[0].innerHTML.replaceAll("&amp;", "&")
              .replaceAll("&lt;", "<")
              .replaceAll("&gt;", ">")
              .replaceAll("&quot;", '"')}`;
        });
      }
    };

    // const initLike = () => {
    //   const likeButtonElements = document.querySelectorAll(".like-button");
    //   for (const likeButton of likeButtonElements) {
    //     const index = likeButton.dataset.index;
    //     likeButton.addEventListener("click", (e) => {
    //       e.stopPropagation();

    //       if (comments[index].isLiked) {
    //         comments[index].likeCount--;
    //       } else {
    //         comments[index].likeCount++;
    //       }
    //       comments[index].isLiked = !comments[index].isLiked;
    //       renderComments();
    //     });
    //   }
    // };

    const renderComments = () => {
      const commentsHtml = comments
        .map((comment) => {
          return `
            <li class="comment">
                <div class="comment-header">
                <div id="commentName">${comment.name}</div>
                <div>${comment.date}</div>
                </div>
                <div class="comment-body">
                  <div class="comment-text"  id="commentText">${comment.text}</div>
                </div>
                <div class="comment-footer">
                  <div class="likes">
                    <span class="likes-counter" >${comment.likeCount}</span>
                    <button class="like-button" data-id='${comment.id}'></button>
                  </div>
                </div>
              </li>`;
        })
        .join("");

      listElement.innerHTML = commentsHtml;

      // initLike();
      copyComment();
    };

    renderComments();

    buttonElement.addEventListener("click", () => {
      buttonElement.classList.remove("add-form-button-error");
      buttonElement.classList.add("add-form-button");
      nameInputElement.classList.remove("error");
      textInputElement.classList.remove("error");

      if (nameInputElement.value === "" || textInputElement.value === "") {
        buttonElement.classList.remove("add-form-button");
        buttonElement.classList.add("add-form-button-error");

        if (nameInputElement.value === "") {
          nameInputElement.classList.add("error");
        }
        if (textInputElement.value === "") {
          textInputElement.classList.add("error");
        }
        const postPromise = fetch(
          "https://wedev-api.sky.pro/api/v1/qwitchers/comments",
          {
            method: "POST",
            body: JSON.stringify({
              id: "",
              text: textInputElement.value,
              name: nameInputElement.value,
              data: formattedDate,
              likeCount: "0",
              isLiked: false,
            }),
          }
        ).then((response) => {
          response.json().then((responseData) => {
            comments = responseData.todos;
            renderComments();
          });
        });
        return;
      }
    });
    const postPromise = fetch(
      "https://wedev-api.sky.pro/api/v1/qwitchers/comments",
      {
        method: "GET",
      }
    );
    postPromise.then((responce) => {
      responce.json().then((responceData) => {
        const appComments = responceData.comments.map((comment) => {
          return {
            name: comment.author.name,
            date: new Date(comment.date),
            text: comment.text,
            likes: comment.likes,
            isLiked: false,
          };
        });
        comments = appComments;
        renderComments();
      });
    });
    renderComments();

    // deleteButtonElement.addEventListener("click", () => {
    //   const lastCommentIndex = listElement.innerHTML.lastIndexOf(
    //     '<li class="comment">'
    //   );
    //   if (lastCommentIndex !== -1) {
    //     listElement.innerHTML = listElement.innerHTML.substring(
    //       0,
    //       lastCommentIndex
    //     );
    //   }
    //   comments.pop();
    //   renderComments();
    // });

    document.addEventListener("keyup", (event) => {
      if (event.key === "Enter") {
        buttonElement.click();
      }
    });

    console.log("It works!");
  </script>
</html>
