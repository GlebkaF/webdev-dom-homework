<!DOCTYPE html>
<html>
<head>
    <title>Проект "Комменты"</title>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="styles.css"/>
</head>

<body>
<div class="container">
     <ul id="list" class="comments">
        <!-- <li class="comment">
            <div class="comment-header">
                <div>Глеб Фокин</div>
                <div id="comment-date-1">12.02.22 12:18</div>
            </div>
            <div class="comment-body">
                <div class="comment-text">
                    Это будет первый комментарий на этой странице
                </div>
            </div>
            <div class="comment-footer">
                <div class="likes">
                    <span class="likes-counter">3</span>
                    <button class="like-button"></button>
                </div>
            </div>

        </li>
       
          

        <li class="comment">
            <div class="comment-header">
                <div>Варвара Н.</div>
                <div>13.02.22 19:22</div>
            </div>
            <div class="comment-body">
                <div class="comment-text">
                    Мне нравится как оформлена эта страница! ❤️
                </div>
            </div>
            <div class="comment-footer">
                <div class="likes">
                    <span class="likes-counter">75</span>
                    <button class="like-button"></button>
                </div>
            </div>
            
        </li> -->
    </ul>
    <div class="add-form">
        <input
                type="text" id="name-input"
                class="add-form-name"
                placeholder="Введите ваше имя"
        />
        <textarea
                id="comm-input"
                class="add-form-text"
                placeholder="Введите ваш коментарий"
                rows="4"
        ></textarea>
        <div class="add-form-row">
            <button id="publish-button" class="add-form-button">Написать</button>
        </div>
    </div>
</div>
</body>

<script>
    const nameInputElement = document.getElementById("name-input");
    const commInputElement = document.getElementById("comm-input");
    const buttonElement = document.getElementById("publish-button");
    const listElement = document.getElementById("list");
 
    function formatDate(date) {
        const day = String(date.getDate()).padStart(2, '0');
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const year = String(date.getFullYear()).slice(-2);
        const hours = String(date.getHours()).padStart(2, '0');
        const minutes = String(date.getMinutes()).padStart(2, '0');
        return `${day}.${month}.${year} ${hours}:${minutes}`;
    };

    function attachLikeHandler(button, counter) {
        let liked = false;
        button.addEventListener('click', () => {
            if (liked) {
                liked = false;
                button.classList.remove('-active-like');
                counter.textContent = parseInt(counter.textContent) - 1;

            } else {
                liked = true;
                button.classList.add('-active-like');
                counter.textContent = parseInt(counter.textContent) + 1;

            }
        });
    }

    
    function attachCommentClickHandler(comment) {
    comment.addEventListener('click', () => {
        
        const name = comment.querySelector('.comment-header div:first-child').textContent;
        const text = comment.querySelector('.comment-text').textContent;

        
        commInputElement.value = `${name}: ${text}`;
        
    });
}



buttonElement.addEventListener("click", () => {
    commInputElement.style.backgroundColor = "";
    nameInputElement.style.backgroundColor = "";
    if (commInputElement.value === "" || nameInputElement.value === "") {
        commInputElement.style.backgroundColor = "red";
        nameInputElement.style.backgroundColor = "red";
       
        return;
    }
    sendCommentToServer()
})


    function renderComments() {
        const allCommentsHtml = commentsData.map(comment => {
            return `<li class="comment">
            <div class="comment-header">
               <div>${comment.name}</div>
                <div id="comment-date-1">${comment.date}</div>
            </div>
            <div class="comment-body">
                <div class="comment-text">
                    ${comment.text}
                </div>
            </div>
            <div class="comment-footer">
                <div class="likes">
                    <span class="likes-counter">${comment.likes}</span>
                    <button class="like-button"></button>
                </div>
            </div>
        </li>`
        }).join("")
        listElement.innerHTML = allCommentsHtml;
        
        const likeButtons = document.querySelectorAll(".like-button");
        const likeCounts = document.querySelectorAll(".likes-counter");
        likeButtons.forEach((button, index) => {
        attachLikeHandler(button, likeCounts[index]);
    });
        
    }

    let commentsData = [];
   


    // function sendCommentToServer(comment) {
    //     const postData = {
    //         name: nameInputElement.value,
    //         text: commInputElement.value,
    //     };

    //     fetch("https://wedev-api.sky.pro/api/v1/yana-orlova/comments", {
    //         method: "POST",
    //         // headers: {
    //         //     "Content-Type": "application/json",
    //         // },
    //         body: JSON.stringify(postData),
    //     }).then((response) => {
    //         if (!response.ok) {
    //             throw new Error("Network response was not ok");
    //         }
            
    //     }).then(() => {
    //         // Обработка успешной отправки комментария 
    //         // Очищаем поля ввода
    //         commInputElement.value = "";
    //         nameInputElement.value = "";
    //         getCommentsFromServer()
    //         console.log("Comment sent successfully:");
    //     }).catch((error) => {
    //         console.error("Fetch error:", error);
    //     });
    // }

    listElement.textContent = "Пожалуйста подождите, комментариии загружаются";

    function getCommentsFromServer() {
    fetch("https://wedev-api.sky.pro/api/v1/yana-orlova/comments", {
        method: "GET",
    })
    .then((response) => {
        if (!response.ok) {
            throw new Error("Network response was not ok");
        }
        return response.json();
    })
    .then((responseData) => {
        let appComments = responseData.comments.map((comment) => {
            return {
                name: comment.author.name,
                text: comment.text,
                date: comment.date,
                likes: comment.likes,
                isLike: comment.isLike,
            };
        });

        commentsData = appComments;
        renderComments();
    })
    .catch((error) => {
        console.error("Fetch error:", error);
    });
}

// Вызываем getCommentsFromServer для загрузки комментариев при загрузке страницы
getCommentsFromServer();

commInputElement.textContent = "Добавляем комментарий...";

function sendCommentToServer(comment) {
        const postData = {
            name: nameInputElement.value,
            text: commInputElement.value,
        };

        fetch("https://wedev-api.sky.pro/api/v1/yana-orlova/comments", {
            method: "POST",
            // headers: {
            //     "Content-Type": "application/json",
            // },
            body: JSON.stringify(postData),
        }).then((response) => {
            if (!response.ok) {
                throw new Error("Network response was not ok");
            }
            
        }).then(() => {
            // Обработка успешной отправки комментария 
            // Очищаем поля ввода
            commInputElement.value = "";
            nameInputElement.value = "";
            getCommentsFromServer()
            console.log("Comment sent successfully:");
        }).catch((error) => {
            console.error("Fetch error:", error);
        });
    }

    console.log("It works!");

</script>
</html>
