<!DOCTYPE html>
<html>
  <head>
    <title>Проект "Комменты"</title>
    <meta charset="utf-8" />
    <link rel="stylesheet" href="styles.css" />
  </head>

  <body>
    <div class="container">
    <div>
      <p>Подождите, комментарии загружаются...</p>
    </div>
      <ul class="comments" id="comments-list"></ul>
      <div class="add-form" id="input-list">
        <input
          id="name-input"
          value=""
          type="text"
          class="add-form-name"
          placeholder="Введите ваше имя"
        />
        <textarea
          id="comment-input"
          value=""
          type="textarea"
          class="add-form-text"
          placeholder="Введите ваш коментарий"
          rows="4"
        ></textarea>
        <div class="add-form-row">
          <button class="add-form-button" id="add-button">Написать</button>
          <button class="new-form-button" id="new-button">
            Удалить последний комментарий
          </button>
        </div>
      </div>
    </div>
  </body>
  <style>
    .error {
      background-color: rgb(232, 144, 14);
    }
  </style>
  <script>
    const buttonElement = document.getElementById("add-button");
    const listComments = document.getElementById("comments-list");
    const newComment = document.getElementById("comment-new");
    const nameElement = document.getElementById("comment-name");
    const dataElement = document.getElementById("comment-data");
    const textElement = document.getElementById("comment-text");
    const nameInputElement = document.getElementById("name-input");
    const commentInputElement = document.getElementById("comment-input");
    const likeElement = document.getElementById("like-text");
    const newButton = document.getElementById("new-button");
    const inputList = document.getElementById("input-list");

    const getCurrentDate = () => {
      const currentDate = new Date();
      const year = String(currentDate.getFullYear()).slice(-2);
      const month = String(currentDate.getMonth() + 1).padStart(2, "0");
      const day = String(currentDate.getDate()).padStart(2, "0");
      const hours = String(currentDate.getHours()).padStart(2, "0");
      const minutes = String(currentDate.getMinutes()).padStart(2, "0");
      const seconds = String(currentDate.getSeconds()).padStart(2, "0");
      const resultDate = `${day}.${month}.${year} ${hours}:${minutes}`;
      return resultDate;
    };

    let comments = [];


const getDateApi = () => {
  return fetch(
      'https://wedev-api.sky.pro/api/v1/:yulenka/comments',
      {
        method:'GET'
      })
    .then((response) => {
    return response.json();})
.then((responseData) =>{
      const appComments = responseData.comments.map((comment)=>{
        return {
        name: comment.author.name,
        date: getCurrentDate(),
        text: comment.text,
        like: comment.likes,
        active: false,
        isEdit: false,
        }
      });

    comments = appComments; 
     renderComments();
    });
};

getDateApi();


    const clickLike = (event) => {
      event.stopPropagation();
      const index = event.target.dataset.index;
      const comment = comments[index];
      if (!comment.active) {
        comment.active = true;
        comment.like++;
      } else {
        comment.active = false;
        comment.like--;
      }
      renderComments();
    };

    // const clickEdit = (event) => {
    //   event.stopPropagation();
    //   const index = event.target.dataset.edit;
    //   const comment = comments[index];
    //   const textarea = document.querySelectorAll(".edit-form");

    //   if (!textarea) {
    //     comments[index].text = textarea.value;
    //   }

    //   if (comment.isEdit) {
    //     comment.isEdit = false;
    //   } else {
    //     comment.isEdit = true;
    //   }
    //   renderComments();
    // };

    // const textCommentClick = (event) => {
    //   event.stopPropagation();
    //   const index = commentElements.dataset.test;
    //   const comment = comments[index];
    //   commentInputElement.value =
    //     ">" + comments[index].text + "\n" + "\n" + comments[index].name + ",";
    //   renderComments();
    // };

    const renderComments = () => {
      const commentsHtml = comments
        .map((comment, index) => {
          if (comment.active === true) {
            comment.active = "-active-like";
          }
          return `<li class="comment" id="comment-new" data-test="${index}">
          <div class="comment-header">
            <div id="comment-name">${comment.name}</div>
            <div id="comment-data">${comment.date}</div>
          </div>
          <div class="comment-body">
            ${
              comment.isEdit
                ? `<textarea type="textarea" class="add-form-text edit-form" rows="4"  data-edit="${index}" >
              ${comment.text}</textarea>`
                : `<div class="comment-text" style="white-space:pre-line" id="comment-text" data-text=${index}>
              ${comment.text}</div>`
            }
          </div>
          <button class="add-form-button" data-edit="${index}">${
            comment.isEdit ? "Сохранить" : "Редактировать"
          }</button>
          <div class="comment-footer">
            <div class="likes">
              <span class="likes-counter" id="like-text" value="">${
            comment.like
          }</span>
              <button class="like-button ${
                comment.active
              }" data-index="${index}"></button>
            </div>
          </div>
        </li>`;
        })
        .join("");
      listComments.innerHTML = commentsHtml;

      const buttonLikes = document.querySelectorAll(".like-button");
      buttonLikes.forEach((button) => {
        button.addEventListener("click", clickLike);
      });

      const commentElements = document.querySelectorAll(".comment");
      for (const commentElement of commentElements) {
        commentElement.addEventListener("click", () => {
          const index = commentElement.dataset.test;
          commentInputElement.value =
        ">" + comments[index].text + "\n" + "\n" + comments[index].name + ",";
      renderComments();
        });
      }

      // const buttonEdit = document.querySelectorAll(".add-form-button");
      // buttonEdit.forEach((button) => {
      //   button.addEventListener("click", clickEdit);
      // });
    };

    renderComments();

    const getElement = () => {
      nameInputElement.classList.remove("error");
      commentInputElement.classList.remove("error");

      if (nameInputElement.value === "") {
        buttonElement.disabled = true;
        buttonElement.style.backgroundColor = "gray";
        nameInputElement.classList.add("error");
        return;
      }
      if (commentInputElement.value === "") {
        buttonElement.disabled = true;
        buttonElement.style.backgroundColor = "gray";
        commentInputElement.classList.add("error");
        return;
      }

      buttonElement.disabled = true;
      buttonElement.textContent = 'Ждём, комментарий добавляется...';

       return fetch(
      'https://wedev-api.sky.pro/api/v1/:yulenka/comments',
      {
        method:'POST',
        body: JSON.stringify({
          name: nameInputElement.value, 
          text: commentInputElement.value,
        }),
      })
      .then((response) => {
    return response.json();})
    .then(() =>{
      
      return getDateApi();
      })
    .then(()=> {
      buttonElement.disabled = false;
      buttonElement.textContent = 'Написать';
    });
  

      nameInputElement.value = "";
      commentInputElement.value = "";
      nameInputElement.classList.remove("error");
      commentInputElement.classList.remove("error");

    };

    buttonElement.addEventListener("click", getElement);

    nameInputElement.addEventListener("input", () => {
      buttonElement.disabled = false;
      buttonElement.style.backgroundColor = "";
      nameInputElement.classList.remove("error");
    });

    commentInputElement.addEventListener("input", () => {
      buttonElement.disabled = false;
      buttonElement.style.backgroundColor = "";
      commentInputElement.classList.remove("error");
    });

    newButton.addEventListener("click", () => {
      comments.pop();
      renderComments();
    });

    document.addEventListener("keyup", (event) => {
      if (event.key === "Enter") {
        getElement();
      }
    });

    console.log("It works!");
  </script>
</html>
