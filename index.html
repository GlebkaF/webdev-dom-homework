<!DOCTYPE html>
<html>

<head>
  <title>Проект "Комменты"</title>
  <meta charset="utf-8" />
  <link rel="stylesheet" href="styles.css" />
</head>

<body>
  <div class="container">
    <div id="loader" class="loader">Пожалуйста, подождите, загружаю комментарии...</div>
    <ul id="list" class="comments">
      <!-- Список рендерится из JS -->
      <!-- <li class="comment">
        <div class="comment-header">
          <div>Глеб Фокин</div>
          <div>12.02.22 12:18</div>
        </div>
        <div class="comment-body">
          <div class="comment-text">
            Это будет первый комментарий на этой странице
          </div>
        </div>
        <div class="comment-footer">
          <div class="likes">
            <span id="like-count" class="likes-counter">3</span>
            <button id="like" class="like-button -active-like"></button>
          </div>
        </div>
      </li> -->
      <!-- <li class="comment">
        <div class="comment-header">
          <div>Варвара Н.</div>
          <div>13.02.22 19:22</div>
        </div>
        <div class="comment-body">
          <div class="comment-text">
            Мне нравится как оформлена эта страница! ❤
          </div>
        </div>
        <div class="comment-footer">
          <div class="likes">
            <span id="like-count" class="likes-counter">75</span>
            <button id="like" class="like-button -active-like"></button>
          </div>
        </div>
      </li> -->
    </ul>
    <div class="form-loading" style="display: none; margin-top: 20px">
      Комментарий добавляется...
    </div>
    <div id="add-form-block" class="add-form">
      <input id="name" type="text" class="add-form-name" placeholder="Введите ваше имя" />
      <textarea id="comment-text" type="textarea" class="add-form-text" placeholder="Введите ваш коментарий"
        rows="4"></textarea>
      <div class="add-form-row">
        <button id="add-button" class="add-form-button">Написать</button>
      </div>
    </div>
  </div>
</body>
<style>
  .error {
    background-color: #fa7575c3;
  }

  .error-button {
    background-color: grey;
  }

  .loader {
    display: none;
    text-align: center;
    padding: 20px;
    font-weight: bold;
  }
</style>
<script>

  const buttonElement = document.getElementById("add-button");
  const listElement = document.getElementById("list");
  const inputNameElement = document.getElementById("name");
  const inputTextElement = document.getElementById("comment-text");
  const addForm = document.getElementById("add-form-block");
  let currenDate = new Date();


  // GET-запрос связка данных с сервером с помощью API

  const fetchAndRenderTasks = () => {
    return fetch(
      "https://webdev-hw-api.vercel.app/api/v1/kostasdvor/comments",
      {
        method: "GET"
      }
    )
      .then((response) => response.json())
      .then((responseData) => {
        const appComments = responseData.comments.map((comment) => {
          const commentDate = new Date(comment.date);
          const day = commentDate.getDate();
          const month = commentDate.getMonth() + 1;
          const year = commentDate.getFullYear();
          const formattedDate = `${day < 10 ? "0" : ""}${day}.${month < 10 ? "0" : ""}${month}.${year}`;
          const hours = commentDate.getHours();
          const minutes = commentDate.getMinutes();
          const formattedTime = `${hours < 10 ? "0" : ""}${hours}:${minutes < 10 ? "0" : ""}${minutes}`;
          const formattedDateTime = `${formattedDate} ${formattedTime}`;

          return {
            name: comment.author.name,
            date: formattedDateTime,
            text: comment.text,
            likes: comment.likes,
            isLikes: false,
          };
        });

        usersComments = appComments;
        renderUsersComments();
      });
  }

  let usersComments = [
    // {
    //   date: "12.02.22 12:18",
    //   likes: 3,
    //   isLiked: false,
    //   text: "Это будет первый комментарий на этой странице",
    //   name: "Глеб Фокин",
    // },
    // {
    //   name: "Варвара Н.",
    //   comment: "Мне нравится как оформлена эта страница! ❤",
    //   time: "13.02.22 19:22",
    //   likes: 75,
    //   isLiked: false,
    // },
  ];

  // Рендер-функция 

  const renderUsersComments = () => {
    const usersCommentsHTML = usersComments.map((usersComment, index) => {
      return `<ul id="list" class="comment">
        <div class="comment-header">
          <div>${usersComment.name}</div>
          <div>${usersComment.date}</div>
        </div>
        <div class="comment-body">
          <div class="comment-text">
            ${usersComment.text}
          </div>
        </div>
        <div class="comment-footer">
          <div class="likes">
            <span id="like-count" class="likes-counter">${usersComment.likes}</span>
            <button id="like" data-index="${index}" class="like-button liked ${usersComment.isLiked ? '-active-like' : ''}"></button>
          </div>
        </div>
      </ul>`;
    }).join('');

    listElement.innerHTML = usersCommentsHTML;
    toggleLike();
    checkCommentFields();
    addCommentReplyHandlers();
  };

  fetchAndRenderTasks();
  renderUsersComments();

  // Плохая функция добавления лайка 

  // function toggleLike(event) {
  //   const likeHeart = event.target;
  //   const likeCount = event.target.previousElementSibling;
  //   let count = parseInt(likeCount.innerText);
  //   let liked = likeHeart.classList.contains('liked');
  //   if (liked) {
  //     count--;
  //     liked = false;
  //     likeHeart.classList.remove('liked');
  //   } else {
  //     count++;
  //     liked = true;
  //     likeHeart.classList.add('liked');
  //   }
  //   likeCount.innerText = count;
  // }

  // listElement.addEventListener('click', function (event) {
  //   if (event.target.matches('.like-button')) {
  //     toggleLike(event);
  //   }
  // });

  //Хорошая функция добавления лайка с использованием stopPropagation

  function toggleLike() {

    const likeButtons = document.querySelectorAll('.like-button');
    addCommentReplyHandlers();

    for (const button of likeButtons) {
      button.addEventListener('click', function (event) {
        event.stopPropagation();
        const index = button.dataset.index;
        if (usersComments[index].isLiked) {
          usersComments[index].likes--
        } else {
          usersComments[index].likes++
        }

        usersComments[index].isLiked = !usersComments[index].isLiked;
        renderUsersComments();
      })
    }
  };

  // Функция отключения кнопки "написать" при незаполненных input

  function checkCommentFields() {

    function togglePublishButton() {
      if (inputNameElement.value.trim() === "" || inputTextElement.value.trim() === "") {
        buttonElement.disabled = true;
      } else {
        buttonElement.disabled = false;
      }
    }

    inputNameElement.addEventListener('input', togglePublishButton);
    inputTextElement.addEventListener('input', togglePublishButton);
  }

  // Функция для ответа на комментарий

  function addCommentReplyHandlers() {
    const commentElements = document.querySelectorAll(".comment");

    for (const commentElement of commentElements) {
      commentElement.addEventListener("click", (event) => {
        const author = commentElement.querySelector(".comment-header div:first-child").textContent;
        const text = commentElement.querySelector(".comment-text").textContent;

        inputTextElement.value = `>${text.trim()}\n@${author}, `;
        inputTextElement.focus();
      });
    }
  }
  addCommentReplyHandlers();

  listElement.innerHTML = 'Пожалуйста, подождите, загружаю комментарии...';

  // Обработчик клика на кнопку "написать"

  buttonElement.addEventListener("click", () => {

    // Условное ветвление для проверки заполненности input

    inputNameElement.classList.remove('error');
    inputTextElement.classList.remove('error');
    buttonElement.classList.remove('error-button');

    if (inputNameElement.value === "" && inputTextElement.value === "") {
      inputNameElement.classList.add('error');
      inputTextElement.classList.add('error');
      buttonElement.classList.add('error-button');
      return;
    } else if (inputNameElement.value === " " || inputTextElement.value === "") {
      inputTextElement.classList.add('error');
      buttonElement.classList.add('error-button');
      return;
    } else if (inputNameElement.value === "" || inputTextElement.value === " ") {
      inputNameElement.classList.add('error');
      buttonElement.classList.add('error-button');
      return;
    }

    // Функция текущей даты и времени

    function formatDateTime(date) {
      const day = date.getDate().toString().padStart(2, '0');
      const month = (date.getMonth() + 1).toString().padStart(2, '0');
      const year = date.getFullYear().toString().slice(-2);
      const hours = date.getHours().toString().padStart(2, '0');
      const minutes = date.getMinutes().toString().padStart(2, '0');
      const timeString = hours + ':' + minutes;
      const formatedDate = `${day}.${month}.${year} ${timeString}`;
      return formatedDate;
    }

    const currentDate = new Date();
    formatDateTime(currentDate);

    // Пуш комментариев пользователя в массив с заменой html символов 

    // usersComments.push({
    //   name: inputNameElement.value
    //     .replaceAll("&", "&amp;")
    //     .replaceAll("<", "&lt;")
    //     .replaceAll(">", "&gt;")
    //     .replaceAll('"', "&quot;"),
    //   comment: inputTextElement.value
    //     .replaceAll("&", "&amp;")
    //     .replaceAll("<", "&lt;")
    //     .replaceAll(">", "&gt;")
    //     .replaceAll('"', "&quot;"),
    //   time: formatDateTime(currentDate),
    //   likes: 0,
    //   isLiked: false,
    // });

    let loadingForm = document.querySelector('.form-loading');
    loadingForm.style.display = 'block';
    addForm.style.display = 'none';

    // Получение новых комментов на сервер с помощью API
    const fetchPromise = fetch(
      "https://webdev-hw-api.vercel.app/api/v1/kostasdvor/comments",
      {
        method: "POST",
        body: JSON.stringify({
          // date: formatDateTime(currentDate),
          // likes: 0,
          // isLiked: false,
          text: inputTextElement.value,
          name: inputNameElement.value,
        }),
      }
    );

    fetchPromise
      .then((response) => response.json())
      .then((responseData) => {
        return fetchAndRenderTasks();
      }).then(() => {
        // addForm.innerHTML = `<input id="name" type="text" class="add-form-name" placeholder="Введите ваше имя" />
        // <textarea id="comment-text" type="textarea" class="add-form-text" placeholder="Введите ваш коментарий"
        // rows="4"></textarea>
        // <div class="add-form-row">
        // <button id="add-button" class="add-form-button">Написать</button>
        // </div>`;
        loadingForm.style.display = 'none';
        addForm.style.display = 'block';
        renderUsersComments();

      });

    checkCommentFields();
  });

</script>

</html>