<!DOCTYPE html>
<html>
  <head>
    <title>Проект "Комменты"</title>
    <meta charset="utf-8" />
    <link rel="stylesheet" href="styles.css" />    
  </head>

  <body>
    <div class="container">
      <ul class="comments" id="list-comments">        
      </ul>
      <button class="remove-comment-button" id="button-remove-comment">Удалить последний коментарий</button>
      <div class="add-form">
        <input
          type="text"
          class="add-form-name"
          placeholder="Введите ваше имя"          
        />
        <textarea
          type="textarea"
          class="add-form-text"
          placeholder="Введите ваш коментарий"
          rows="4"
        ></textarea>
        <div class="add-form-row">
          <button class="add-form-button" id="button-add-comment">Написать</button>
        </div>
      </div>
    </div>

    <script type="text/html" id="template-comment">
      <li class="comment">
        <div class="comment-header">
          <div>{author}</div>
          <div>{date}</div>
        </div>
        <div class="comment-body">
          <div class="comment-text">
            <pre>{comment}</pre>
          </div>
        </div>
        <div class="comment-footer">
          <div class="likes">
            <span class="likes-counter">0</span>
            <button class="like-button"></button>
          </div>
        </div>
      </li>
    </script>

  </body>

  <script>
    "use strict";
   

    const commentsData = [
      {
        author: "Глеб Фокин",
        date: "12.02.22 12:18",
        text: "Это будет первый комментарий на этой странице",
        likesCount: 3,
        liked: false,
        isEdited: false
      },
      {
        author: "Варвара Н.",
        date: "13.02.22 19:22",
        text: "Мне нравится как оформлена эта страница! ❤",
        likesCount: 75,
        liked: true,
        isEdited: false
      }
    ];


    const formAddComment = document.getElementsByClassName('add-form')[0];
    const inputName = formAddComment.getElementsByClassName('add-form-name')[0];
    const inputComment = formAddComment.getElementsByClassName('add-form-text')[0];
    const inputs = [inputName, inputComment];

    const listComments = document.getElementById('list-comments');
    const buttonAddComment = document.getElementById('button-add-comment');
    const templateComment = document.getElementById('template-comment');

    const buttonRemoveComment = document.getElementById('button-remove-comment');


    const setbuttonRemoveCommentEnabled = () => buttonRemoveComment.disabled = commentsData.length == 0;

    const initCommentsEventHandlers = () => {
      const likeButtons = document.querySelectorAll('.comment .like-button');
      for (const button of likeButtons) {
        button.addEventListener('click', (event) => {
          const item = commentsData[event.target.dataset.index];
          item.likesCount += item.liked ? -1 : +1;
          item.liked = !item.liked;
          renderComments();
        });
      }

      const editButtons = document.querySelectorAll('.comment .comment-edit-button');
      for (const button of editButtons) {
        button.addEventListener('click', (event) => {
          const item = commentsData[event.target.dataset.index];
          item.isEdited = true;
          renderComments();
        });
      }
      
    }

    const renderComments = () => {
      const renderCommentText = (comment, index) => {        
        if(comment.isEdited){
          return `<textarea class="comment-text-edit">${comment.text}</textarea>
          <button data-index="${index}" class="add-form-button comment-edit-save-button">Сохранить</button>
          <button data-index="${index}" class="add-form-button comment-edit-cancel-button">Отмена</button>
          `;
        } 
        return `<div class="comment-text">${comment.text}</div>
        <button data-index="${index}" class="add-form-button comment-edit-button">Редактировать</button>`;
      };      

      const commentsHTML = commentsData.map((comment, index) =>
          `<li class="comment">
            <div class="comment-header">
              <div>${comment.author}</div>
              <div>${comment.date}</div>
            </div>
            <div class="comment-body"> 
             ${renderCommentText(comment, index)}
            </div>
            <div class="comment-footer">
              <div class="likes">
                <span class="likes-counter">${comment.likesCount}</span>
                <button data-index="${index}" class="like-button ${comment.liked ? 'active-like' : ''}"></button>
              </div>
            </div>
          </li>`
        ).join('');

      listComments.innerHTML = commentsHTML;

      initCommentsEventHandlers();

      setbuttonRemoveCommentEnabled();
    };



    renderComments();


    const addComment = (author, comment) => {
      commentsData.push({
        author: author,
        date: formatDateTime(new Date()),
        text: comment,
        likesCount: 0,
        liked: false,
        isEdited: false     
      });
      renderComments();
    };


    const validationState = {
      isNameValid: false,
      setIsNameValid(state) { this.isNameValid = state; if(this.onchange) this.onchange(); },
      isCommentValid: false,
      setIsCommentValid(state) { this.isCommentValid = state; if(this.onchange) this.onchange(); },
      isValid(){
        return this.isNameValid && this.isCommentValid;
      }
    };

    const formatDateTime = (date) => {
      const day = String(date.getDate()).padStart(2, '0');
      const month = String(date.getMonth()).padStart(2, '0');
      const year = String(date.getFullYear() - 2000);
      const minutes = String(date.getMinutes()).padStart(2, '0');
      const hours = String(date.getHours()).padStart(2, '0');
      return `${day}.${month}.${year} ${hours}:${minutes}`;
    };

    

    const inputIsNotEmpty = (input) => input.value.trim() !== '';

    const validateName = () => { 
      validationState.setIsNameValid(inputIsNotEmpty(inputName)); 
      return validationState.isNameValid;
    };
    const validateComment = () => {
      validationState.setIsCommentValid(inputIsNotEmpty(inputComment)); 
      return validationState.isCommentValid;
    };

    const setAddCommentButtonEnabled = () => {
      buttonAddComment.disabled = !validationState.isValid();
    };

    const setInputValidityStatus = (input, status) =>{
      if(status){
        input.classList.remove('error');
      } else {
        input.classList.add('error');
      }
    };

    const validate = () => {      
      setInputValidityStatus(inputName, validateName());
      setInputValidityStatus(inputComment, validateComment());
      return validationState.isValid();
    }

    const validateAndSend = () => {      
      if(!validate()){
        return;
      }
      
      addComment(inputName.value, inputComment.value);
      
      inputComment.value = '';
      validateComment();
    };

    const removeLastComment = () => {
      if(commentsData.length == 0){
        return;
      }
      commentsData.splice(commentsData.length - 1, 1);
      renderComments();
    }
    
    inputName.addEventListener('input', validateName);
    
    inputComment.addEventListener('input', validateComment);

    inputComment.addEventListener('keydown', (e) =>{
      if(e.code == 'Enter'){
        validateAndSend();
        e.preventDefault();
      }
    });

    buttonAddComment.addEventListener('click', validateAndSend);

    validationState.onchange = () => setAddCommentButtonEnabled();

    buttonRemoveComment.addEventListener('click', removeLastComment);

    validateName();
    validateComment();
    setbuttonRemoveCommentEnabled();
  </script>
</html>
