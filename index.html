<!DOCTYPE html>
<html>

<head>
  <title>Проект "Комменты"</title>
  <meta charset="utf-8" />
  <link rel="stylesheet" href="styles.css" />
</head>

<body>
  <div class="container">
    <div id="comment-loading">
      <p>Пожалуйста подождите, загружаю комментарии...</p>
    </div>
    <ul id="list" class="comments">
      <!-- <li class="comment">
          <div class="comment-header">
            <div>Глеб Фокин</div>
            <div>12.02.22 12:18</div>
          </div>
          <div class="comment-body">
            <div class="comment-text">
              Это будет первый комментарий на этой странице
            </div>
          </div>
          <div class="comment-footer">
            <div class="likes" data-name="Глеб Фокин" data-like="3" data-isLiked="inactive">
              <span class="likes-counter">3</span>
              <button id="like-button" class="like-button"></button>
            </div>
          </div>
        </li>-->
    </ul>
    <div id="comment-render">
      <p>Комментарий добавляется...</p>
    </div>
    <div class="add-form" id="add-form-disable">
      <input type="text" class="add-form-name" placeholder="Введите ваше имя" id="name-input" value="" />
      <textarea type="textarea" class="add-form-text" placeholder="Введите ваш коментарий" rows="4" id="comment-input"
        value=""></textarea>
      <div class="add-form-row">
        <button id="add-button" class="add-form-button add-form-button_disable">Написать</button>
      </div>
    </div>
  </div>
</body>

<style>
  .error {
    background-color: grey;
  }
</style>

<script>
  "use strict";
  const buttonElement = document.getElementById('add-button');
  const listElement = document.getElementById('list');
  const nameInputElement = document.getElementById('name-input');
  const commentInputElement = document.getElementById('comment-input');

  // Получение списка комментариев из API завернутый в функцию GET запрос 
  function getCommentList(showLoading) {
    if (showLoading == true) {
      document.getElementById('comment-loading').style.display = 'flex'; 
    } else {
      document.getElementById('comment-loading').style.display = 'none';
    };
    const fetchPromise = fetch("https://wedev-api.sky.pro/api/v1/anton-shlyapkin/comments", {
      method: "GET"
    });
      fetchPromise.then((response) => {
        const jsonPromise = response.json();
          jsonPromise.then((responseData) => {
            console.log(responseData);
            const appComments = responseData.comments.map((comment) => {
            return {
              date: `${(new Date(comment.date).getDate().toString().padStart(2, "0")) + "." + (new Date(comment.date).getMonth() + 1).toString().padStart(2, "0") + "." + (new Date(comment.date).getFullYear() - 2000) + " " + (new Date(comment.date).getHours().toString().padStart(2, "0")) + ":" + (new Date(comment.date).getMinutes().toString().padStart(2, "0"))}`,
              likes: comment.likes,
              isLiked: false,
              text: comment.text,
              name: comment.author.name,
            };
          });
          document.getElementById('comment-loading').style.display = 'none'; 
          comments = appComments;
          renderComments();
        });
      });
  } 
  getCommentList(true); 

  let comments = []

  // Проверка заполненности полей и отключение кнопки 
  const checkInput = () => {
    disableBtn();
    nameInputElement.addEventListener('input', () => {
      disableBtn()
      nameInputElement.classList.remove('add-form-name_error')
      // console.log("Поле ввода заполнено текстом")
    })

    nameInputElement.addEventListener('blur', () => {
      if (nameInputElement.value == '') {
        nameInputElement.classList.add('add-form-name_error')
        // console.log("Поле ввода пустое")
      } else {
        nameInputElement.classList.remove('add-form-name_error')
        // console.log("Поле ввода заполнено текстом")
      }
    })

    // Перекрашиваем поле и включаем/отлючаем кнопку в инпуте комментариев
    commentInputElement.addEventListener('input', () => {
      disableBtn()
      commentInputElement.classList.remove('add-form-comment_error')
    })

    commentInputElement.addEventListener('blur', () => {
      if (commentInputElement.value == '') {
        commentInputElement.classList.add('add-form-comment_error')
      } else {
        commentInputElement.classList.remove('add-form-comment_error')
      }
    })

    function disableBtn() {
      if (!nameInputElement.value == '' && !commentInputElement.value == '') {
        buttonElement.classList.remove('add-form-button_disable')
      } else {
        buttonElement.classList.add('add-form-button_disable')
      }
    }
  }
  checkInput();

  // Счётчик лайков и отображение лайков на комментарии
  const initEventListeners = () => {
    const likeElements = document.querySelectorAll(".like-button");
    likeElements.forEach((element, index) => {
      element.addEventListener('click', (event) => {
        event.stopPropagation();
        if (comments[index].isLiked) {
          comments[index].isLiked = false;
          comments[index].likes -= 1;
        } else {
          comments[index].isLiked = true;
          comments[index].likes += 1;
        }
        renderComments();
        initCommentingListeners();
      })
    })
  }

  // Ответ на комментарий 
  const initCommentingListeners = () => {
    const commentingElements = document.querySelectorAll(".comment");
    commentingElements.forEach((element, index) => {
      element.addEventListener('click', () => {
        commentInputElement.value = "> " + comments[index].text + " " + comments[index].name + ", ";
      })
    })
  }
  initCommentingListeners();

  // Рендер комментария в список всех комментариев
  const renderComments = () => {
    const commentsHtml = comments.map((comment) => { 
      return `<li class="comment">
          <div class="comment-header">
            <div id="name-input">${comment.name}</div>
              <div>${comment.date}</div> 
          </div>
          <div class="comment-body">
            <div id="comment-input" class="comment-text">
              ${comment.text}
            </div>
          </div>
          <div class="comment-footer">
            <button id="" class="edit-button">Редактировать</button>
            <div class="likes" data-name="${comment.name}" data-like="${comment.likes}" data-isLiked="${comment.isLiked}">
              <span class="likes-counter">${comment.likes}</span>
              <button id="like-button" class="like-button ${(comment.isLiked) ? "-active-like" : ""}"></button>
            </div>
          </div>
        </li>`
    }).join("");

    listElement.innerHTML = commentsHtml;
    checkInput();
    initEventListeners();
    initCommentingListeners();
  }
  //renderComments();

  // Отправка комментария с клавиши Enter на клавиатуре 
  document.addEventListener('keyup', (e) => {
    e.preventDefault(); // снимает дефолтные браузерные функции с ивента
    if (e.code == 'Enter' || e.code == 'NumpadEnter') {
      // console.log("Нажал клавишу Enter");
      if (!nameInputElement.value == '' && !commentInputElement.value == '') {
        sendingComment();
        renderComments();
        buttonElement.classList.add('add-form-button_disable')
      }
    };
  });

  // Отправка комментария через кнопку
  buttonElement.addEventListener('click', () => {
    // console.log('Нажал кнопку "Написать"');
    checkInput();
    sendingComment();
    buttonElement.classList.add('add-form-button_disable')
    buttonElement.blur();
  })

  document.getElementById('comment-render').style.display = 'none'; 
  
  const sendingComment = () => {
    const sanitizeHtml = (htmlString) => {
      return htmlString
      .replaceAll("&", "&amp;")
      .replaceAll("<", "&lt;")
      .replaceAll(">", "&gt;")
      .replaceAll('"', "&quot;");
    };

    function addComment() { 
      document.getElementById('comment-render').style.display = 'flex';
      document.getElementById('add-form-disable').style.display = 'none';
      const fetchPromise = fetch("https://wedev-api.sky.pro/api/v1/anton-shlyapkin/comments", {
        method: "POST",
        body: JSON.stringify({
          date: new Date(),
          likes: 0,
          isLiked: false,
          text: sanitizeHtml(commentInputElement.value),
          name: sanitizeHtml(nameInputElement.value),
          forceError: true,
        }),
      })
        .then((response) => {
          //console.log('1');
          if (response.status === 400) {
            alert('Имя и комментарий должен быть не короче 3х символов'); 
          } else {
            return response; 
          }    
        })
        .then((response) => {
          //console.log('2');
          if (response.status === 500) {
            alert('Сервер сломался, попробуйте позже'); 
          } else {
            return response; 
          }    
        })
        .then((response) => {
          //console.log('3');
          return response.json();     
        })
        // .then((response) => {
        //   console.log('1');
        //   if (response.status === 400) {
        //     alert('Имя и комментарий должен быть не короче 3х символов');
        //   } else if (response.status === 500) {
        //     throw new Error('Some error');
        //     alert('Сервер сломался, попробуйте позже');
        //   } else {
        //     return response.json(); 
        //   }    
        // })
        .then(() => {
          //console.log('4');
          return getCommentList(false);
        })
        .then(() => {
          //console.log('5');
          document.getElementById('add-form-disable').style.display = 'flex';
          document.getElementById('comment-render').style.display = 'none';
          nameInputElement.value = "";
          commentInputElement.value = "";
        })
        .catch((error) => {
          //console.log('6');
          document.getElementById('add-form-disable').style.display = 'flex'; // Скрыть поле ввода
          document.getElementById('comment-render').style.display = 'none'; // Комментарий добавляется..
          //console.warn(error);
          console.log(error.message);
          if (error.message === "Cannot read properties of undefined (reading 'json')") {
            sendingComment();
            //console.log('500=>201');
          }
        });
      renderComments();
    }
    addComment();
  } 
  console.log("It works!");
</script>
</html>