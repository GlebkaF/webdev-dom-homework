<!DOCTYPE html>
<html>

<head>
  <title>Проект "Комменты"</title>
  <meta charset="utf-8" />
  <link rel="stylesheet" href="styles.css" />
</head>

<body>
  <div class="container">
    <!-- Загрузка -->
    <div class="loading"></div>
    <ul id="comment-list" class="comments">
      <!-- JS -->
    </ul>
    <div class="add-form">
      <input type="text" id="input-comment-name" class="add-form-name" placeholder="Введите ваше имя" />
      <textarea type="textarea" id="input-comment-text" class="add-form-text" placeholder="Введите ваш коментарий"
        rows="4"></textarea>
      <div class="add-form-row">
        <button id="add-form-button-id" class="add-form-button">Написать</button>
      </div>
    </div>
  </div>
</body>
<style>
  .error {
    border: 1px solid red;
  }
</style>
<script>
  "use strict";
  const buttonElement = document.getElementById('add-form-button-id');
  const commentListElement = document.getElementById('comment-list');
  const inputCommentNameElement = document.getElementById('input-comment-name');
  const inputCommentTextElement = document.getElementById('input-comment-text');
  const commentDate = new Date();
  const loadingElement = document.querySelector(".loading");


  // GET API
  const getApi = () => {

    loadingElement.textContent = `Лента комментариев загружается...`;

    return fetch('https://wedev-api.sky.pro/api/v1/:maksim-sokolskiy/comments', {
      method: "GET"
    })
      .then((response) => {
        return response.json();
      })
      .then((responseData) => {
        const appComments = responseData.comments.map((comment) => {
          return {
            name: comment.author.name,
            date: new Date(comment.date),
            text: comment.text,
            like: comment.likes,
            isLiked: false,
          }
        });
        loadingElement.textContent = "";
        commentsArr = appComments;
        renderComments();
      });
  };
  getApi();


  // POST API
  const postApi = (inputCommentTextElement, inputCommentNameElement) => {

    buttonElement.disabled = true;
    buttonElement.textContent = 'Отправка...';

    return fetch('https://wedev-api.sky.pro/api/v1/:maksim-sokolskiy/comments', {
      method: "POST",
      body: JSON.stringify({
        text: inputCommentTextElement.value,
        name: inputCommentNameElement.value,
        forceError: true,
      })
    })
      .then((response) => {

        if (response.status === 201) {
          return response.json();
        } else if (response.status === 400) {
          throw new Error('Ошибка запроса')
        } else if (response.status === 500) {
          throw new Error('Ошибка сервера')
        }

      })
      .then(() => {
        return getApi();
      })
      .then(() => {
        buttonElement.disabled = false;
        buttonElement.textContent = 'Написать';
        inputCommentNameElement.value = ""
        inputCommentTextElement.value = ""
      })
      .catch((error) => {

        buttonElement.disabled = false;
        buttonElement.textContent = 'Написать';

        if (error.message === 'Ошибка запроса' || inputCommentTextElement.value.length < 3 || inputCommentNameElement.value.length < 3) {
          alert("Имя и комментарий должны быть не короче 3 символов");
          return;
        } else if (error.message === 'Ошибка сервера') {
          alert("Сервер сломался, попробуй позже");
          return;
        } else {
          alert("Кажется, у вас сломался интернет, попробуйте позже");
        }

      });
  }


  // Массив 
  let commentsArr = [];


  // Добавляет Лайки //
  const addLike = () => {
    const likeButtonElements = document.querySelectorAll(".like-button");
    for (const likeButton of likeButtonElements) {
      likeButton.addEventListener('click', (event) => {
        event.stopPropagation();
        const counter = commentsArr[likeButton.dataset.index]
        let a = counter.like
        if (counter.isLiked === false) {
          counter.isLiked = true;
          counter.like++;
        }
        else if (counter.isLiked === true) {
          counter.isLiked = false
          counter.like--;
        }
        renderComments();
      });
    }
  };
  addLike();


  // Ответ на комментарий
  const answer = () => {
    const answerComment = document.querySelectorAll('.comment');
    const answerCommentTexts = document.querySelectorAll('.comment-text');
    const answerCommentHeaders = document.querySelectorAll('.comment-header');
    const inputField = document.querySelector('.add-form-text');
    answerComment.forEach((answerComment, index) => {
      answerComment.addEventListener('click', () => {
        inputField.value = '>' + ' ' + answerCommentTexts[index].innerText + ' (' + answerCommentHeaders[index].innerText + ')';
        renderComments();
      });
    });
  };


  // Рендер
  const renderComments = () => {
    const commentsHtml = commentsArr.map((comment, index) => {
      const commentDate = new Date(comment.date);
      const timeDate = commentDate.toLocaleDateString() + ' ' + commentDate.getHours() + ':' + commentDate.getMinutes();
      return `<li  class="comment">
          <div class="comment-header">
            <div>${comment.name}</div>
            <div>${timeDate}</div>
          </div>
          <div class="comment-body">
            <div class="comment-text">${comment.text}</div>
          </div>
          <div class="comment-footer">
            <div class="likes">
              <span class="likes-counter">${comment.like}</span>
              <button class="like-button ${comment.isLiked ? '-active-like' : ''}" data-index=${index}></button>
            </div>
          </div>
      </li>`
    })
      .join("");
    commentListElement.innerHTML = commentsHtml;
    addLike();
    answer();
  };
  renderComments();


  // Добавляет комментарий 
  const addComment = () => {
    buttonElement.addEventListener('click', () => {
      inputCommentNameElement.classList.remove("error")
      inputCommentTextElement.classList.remove("error")

      if (inputCommentNameElement.value === '' && inputCommentTextElement.value === '') {
        inputCommentNameElement.classList.add("error")
        inputCommentTextElement.classList.add("error")
        return;
      } else if (inputCommentNameElement.value === '') {
        inputCommentNameElement.classList.add("error")
        return;
      } else if (inputCommentTextElement.value === '') {
        inputCommentTextElement.classList.add("error")
        return;
      };


      postApi(inputCommentTextElement, inputCommentNameElement);
      renderComments();
    });
  }
  addComment();     
</script>

</html>