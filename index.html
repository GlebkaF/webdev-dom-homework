<!DOCTYPE html>
<html>
  <head>
    <title>Проект "Комменты"</title>
    <meta charset="utf-8" />
    <link id = "elementStyle" rel="stylesheet" href="styles.css" />
  </head>

  <body>
    <div class="container">
      <ul id = "list-input" class="comments">
  <!-- Список в JS -->
      </ul>
      <div class="add-form">
        <input
          type="text"
          class="add-form-name"
          id = "name-input"
          placeholder="Введите ваше имя"
        />
        <textarea
          type="textarea"
          class="add-form-text"
          id = "text-input"
          placeholder="Введите ваш комментарий"
          rows="4"
        ></textarea>
        <div class="add-form-row">
          <button class="add-form-button" id = "add-button">Написать</button>
        </div>
      </div>
    </div>
  </body>
  <style>
    .error {
      background-color: grey;
    }
  </style>
  <script>
    "use strict";
    const buttonElement = document.getElementById('add-button');
    const listElement = document.getElementById("list-input");
    const nameInputElement = document.getElementById('name-input');
    const textInputElement = document.getElementById('text-input');
   

    const initEventListeners = () =>{
    const likeButtonElements = document.querySelectorAll('.like-button');
    for(const likeButtonElement of likeButtonElements){
    likeButtonElement.addEventListener('click', event =>{
      event.stopPropagation();
      const index = likeButtonElement.dataset.index;
      if (comments[index].isLiked === false){
              comments[index].likes++;
              comments[index].isLiked = true;
            }
          else {
            comments[index].likes--;
            comments[index].isLiked = false;
          }
        renderComments (); 
  });
  };};
  initEventListeners();


  let comments = [
    // 
  ];

  let fetchPromise = fetch(
    'https://wedev-api.sky.pro/api/v1/nata_kosovskaya/comments',
  {
    method: "GET",
  });
  
  fetchPromise.then((response) => {
    let jsonPromise = response.json();
    jsonPromise.then((responseData) => {
      console.log(response);
      let appComments = responseData.comments.map((comment) => {
        return { 
        name: comment.author.name,
        date: new Date(comment.date),
        text: comment.text,
        likes: comment.likes,
        isLiked: false,
        };
    });
    comments = appComments;
    renderComments();  
  });
  })


// function sanitizeHTML(htmlString) {
//   return htmlString
//   .replaceAll("<", "&lt;")
//   .replaceAll(">", "&gt;")
//   .replaceAll("&", "&amp;")
//   .replaceAll('"', "&quot;");
// }
// console.log(sanitizeHTML);



const renderComments = () => {
  const commentsHTML = comments.map((comment, index) => {
  let newTime = {
  hour: 'numeric',
  minute: 'numeric',
  };
  const time = new Date();
  let dateTime = comment.date.getDate() + "." + (comment.date.getMonth() + 1)+ 
"." + comment.date.getFullYear().toString().substring(2) + " " + comment.date.toLocaleString('ru', newTime);      

          return `<li class="comment">
          <div class="comment-header">
            <div class="commeent-name">${comment.name}</div>
            <div>${dateTime} </div>
          </div>
          <div class="comment-body">
            <div class="comment-text">${comment.text}  
            </div>
          </div>
         <div class="comment-footer">
            <div class="likes">
              <span  class="likes-counter">${comment.likes}</span>
              <button data-index ='${index}' class="${comments[index].isLiked ? 'like-button -active-like' : 'like-button'}">
                <div></div>
                </button>
            </div>
          </div>

        </li>`;
  }). join(''); 


  listElement.innerHTML = commentsHTML;
  initEventListeners();
};
  renderComments ();

  nameInputElement.value = "";
  textInputElement.value = "";    

// let newTime1 = {
//   hour: 'numeric',
//   minute: 'numeric',
//   }; 

buttonElement.addEventListener('click', () => {
      
  buttonElement.classList.remove("error");
    if(nameInputElement.value === "" ||  textInputElement.value ===""){
        buttonElement.classList.add("error");
        return;
      }
      fetchPromise = fetch('https://wedev-api.sky.pro/api/v1/nata_kosovskaya/comments',
  {
    method: "POST",
    body: JSON.stringify({
    text:  textInputElement.value,
    name: nameInputElement.value,
    }),
  })
    fetchPromise.then((response) => {
    let jsonPromise = response.json();
    jsonPromise.then((responseData) => {
      console.log(response);
      let appComments = responseData.comments.map((comment) => {
        return { 
        name: comment.author.name,
        date: newDate(comment.date),
        text: comment.text,
        likes: comment.likes,
        isLiked: false,
        };
    });
    comments = appComments;
    renderComments ();
    });
  });
  })
//       const time = new Date();
//       let dateTime = time.getDate() + "." + (time.getMonth() + 1)+ 
// "." + time.getFullYear().toString().substring(2) + " " + time.toLocaleString('ru', newTime);
    
   
  fetchPromise = fetch(
    'https://wedev-api.sky.pro/api/v1/nata_kosovskaya/comments',
  {
    method: "GET",
  });
  
  fetchPromise.then((response) => {
    let jsonPromise = response.json();
    jsonPromise.then((responseData) => {
      console.log(response);
      let appComments = responseData.comments.map((comment) => {
        return { 
        name: comment.author.name,
        date: new Date(comment.date),
        text: comment.text,
        likes: comment.likes,
        isLiked: false,
        };
    });
    comments = appComments;
    renderComments();  
  });
  })
 

nameInputElement.value = "";
textInputElement.value = "";
  
initEventListeners();
// answerComment();
// renderComments ();  

// function answerComment() {
//   const commentAnswer = document.querySelectorAll('.comment');
//   const formText = document.querySelector('.add-form-text');

//   commentAnswer.forEach((comment, index) =>{
//     comment.addEventListener('click', () => {
//       console.log(index);
//       formText.value = `-${comments[index].name} \n -${comments[index].comment}`;
//     renderComments()
//     });
//   });
// };
// answerComment();

 </script>
</html>
