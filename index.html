<!DOCTYPE html>
<html>

<head>
  <title>Проект "Комменты"</title>
  <meta charset="utf-8" />
  <link rel="stylesheet" href="styles.css" />
</head>

<body>
  <div class="container">
    <ul class="comments" id="commentsList">
      <!--Список рендерится из JS-->
    </ul>
    <div class="add-form">
      <input type="text" class="add-form-name" placeholder="Введите ваше имя" id="nameInput" />
      <textarea type="textarea" class="add-form-text" placeholder="Введите ваш коментарий" rows="4"
        id="textInput"></textarea>
      <div class="add-form-row">
        <button class="add-form-button" id="add-button">Написать</button>
        <button class="add-form-button" id="cancel-button">Удалить коментарий</button>
      </div>
    </div>
    <div class="downloading">Комментарий загружается...</div>
  </div>
</body>

<style>
  .disabledButton {
    background-color: gainsboro;
    color: grey;
  }
</style>

<script>
  "use strict";
  const commentsListElement = document.getElementById('commentsList');
  const cancelButtonElement = document.getElementById('cancel-button');
  const formElement = document.querySelector('.add-form');

  let comments = [];


  function getDate(currentDate = new Date()) {
    let day = currentDate.getDate();
    let month = currentDate.getMonth() + 1;
    let year = currentDate.getFullYear().toString().substr(-2);
    let hour = currentDate.getHours();
    let minutes = currentDate.getMinutes();
    if (month < 10) {
      month = "0" + month;
    }
    if (minutes < 10) {
      minutes = "0" + minutes;
    }
    if (hour < 10) {
      hour = "0" + hour;
    }
    if (day < 10) {
      day = "0" + day;
    }

    return day + '.' + month + '.' + year + ' ' + hour + ':' + minutes;
  };

  const initReplyButtonListeners = () => {
    const replyButtonElements = document.querySelectorAll('.comment');

    for (const replyButtonElement of replyButtonElements) {
      replyButtonElement.addEventListener('click', (e) => {
        e.stopPropagation();
        const index = replyButtonElement.dataset.index;
        comments[index].isEdit ? '' : textInputElement.value = `QUOTE_BEGIN ${comments[index].text} 
        ${comments[index].name} QUOTE_END`;
        renderComments();
      });
    };
  };

  const initEditButtonListeners = () => {
    const editButtonElements = document.querySelectorAll('.edit-button');
    for (const editButtonElement of editButtonElements) {
      editButtonElement.addEventListener('click', (e) => {
        e.stopPropagation();
        const index = editButtonElement.dataset.index;

        if (comments[index].isEdit === false) {
          comments[index].isEdit = true;
        }
        else {
          comments[index].isEdit = false;
        }
        renderComments();
      });
    };
  };

  const initLikeButtonListeners = () => {
    const likeButtonElements = document.querySelectorAll('.like-button');
    for (const likeButtonElement of likeButtonElements) {
      likeButtonElement.addEventListener('click', (e) => {
        e.stopPropagation();
        const index = likeButtonElement.dataset.index;

        if (comments[index].isLiked === false) {
          comments[index].likes++;
          comments[index].isLiked = true;
        }

        else {
          comments[index].likes = --comments[index].likes;
          comments[index].isLiked = false;
        }
        renderComments();
      });
    };
  };

  const initDisabledButton = () => {
    const buttonElement = document.getElementById('add-button');
    const nameInputElement = document.getElementById('nameInput');
    const textInputElement = document.getElementById('textInput');
    buttonElement.disabled = true;
    buttonElement.classList.add('disabledButton');
    buttonElement.classList.remove('add-form-button:hover');

    nameInputElement.addEventListener('input', () => {
      buttonElement.disabled = false;
      buttonElement.classList.remove('disabledButton');
      if (nameInputElement.value === '' || textInputElement.value === '') {
        buttonElement.disabled = true;
        buttonElement.classList.add('disabledButton');
      }
      return;
    });

    textInputElement.addEventListener('input', () => {
      buttonElement.disabled = false;
      buttonElement.classList.remove('disabledButton');
      if (nameInputElement.value === '' || textInputElement.value === '' || textInputElement.value.endsWith('QUOTE_END ')) {
        buttonElement.disabled = true;
        buttonElement.classList.add('disabledButton');
      }
      return;
    });

    textInputElement.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        e.preventDefault();
        buttonElement.click();
      }
    });
  };

  // const renderForm = () => {
  //   formElement.innerHTML = `
  //   <input type="text" class="add-form-name" placeholder="Введите ваше имя" id="nameInput" />
  //     <textarea type="textarea" class="add-form-text" placeholder="Введите ваш коментарий" rows="4"
  //       id="textInput"></textarea>
  //     <div class="add-form-row">
  //       <button class="add-form-button" id="add-button">Написать</button>
  //       <button class="add-form-button" id="cancel-button">Удалить коментарий</button>`;

  //   initDisabledButton();

  //   const cancelButtonElement = document.getElementById('cancel-button');
  //   cancelButtonElement.addEventListener('click', () => {
  //     comments.splice(-1, 1);
  //     renderComments();
  //   });
  // };



  const renderComments = () => {
    const commentsHtml = comments
      .map((comment, index) => {
        return `<li class="comment" data-index='${index}'>
        <div class="comment-header">
          <div>${comment.name
            .replaceAll("&", "&amp;")
            .replaceAll("<", "&lt;")
            .replaceAll(">", "&gt;")
            .replaceAll('"', "&quot;")}</div>
          <div>${getDate(comment.date)}</div>
        </div>
        <div class="comment-body">
          ${comment.isEdit ? `<textarea type="textarea" class="add-form-text" rows="4"
        id="textInput">${comment.text}</textarea>` : `<div class="comment-text">
            ${comment.text
            .replaceAll('QUOTE_BEGIN', "<div class='quote'>")
            .replaceAll('QUOTE_END', '</div>')
            .replaceAll("&", "&amp;")
            .replaceAll("<", "&lt;")
            .replaceAll(">", "&gt;")
            .replaceAll('"', "&quot;")}
          </div>`}          
        </div>
        <div class="comment-footer">
          <div class="edit">
            <button data-index='${index}' class="edit-button">${comment.isEdit ? 'Save' : 'Edit'}</button>
          </div>
          <div class="likes">
            <span class="likes-counter">${comment.likes}</span>
            <button data-index='${index}' class="like-button ${comment.isLiked ? '-active-like' : ''}"></button>
          </div>
        </div>  
      </li>`;
      })
      .join('');
    commentsListElement.innerHTML = commentsHtml;

    initReplyButtonListeners();
    initLikeButtonListeners();
    initEditButtonListeners();
    initDisabledButton();

  };


  const getComments = () => {
    fetch('https://webdev-hw-api.vercel.app/api/v1/katerina-nosova/comments', {
      method: 'GET'
    }).then((response) => {
      response.json().then((responseData) => {
        //преобразование данных формата api в наш формат
        comments = responseData.comments.map((comment) => {
          return {
            name: comment.author.name,
            date: new Date(comment.date),
            text: comment.text,
            likes: comment.likes,
            isLiked: false
          };
        });
        renderComments();
      });
    });
  };
  getComments();
  // renderForm();

  const textInputElement = document.getElementById('textInput');
  const nameInputElement = document.getElementById('nameInput');
  const buttonElement = document.getElementById('add-button');

  const toggleForm = (isLoading) => {
    if (isLoading) {
      document.querySelector('.add-form').style.display = 'none';
      document.querySelector('.downloading').style.display = 'flex';
    }
    else {
      document.querySelector('.add-form').style.display = 'flex';
      document.querySelector('.downloading').style.display = 'none';
    }
  };


  buttonElement.addEventListener('click', () => {
    toggleForm(true);
    const postComments = () => {
      fetch('https://webdev-hw-api.vercel.app/api/v1/katerina-nosova/comments', {
        method: 'POST',
        body: JSON.stringify({
          text: textInputElement.value,
          name: nameInputElement.value
        })
      }).then((response) => {
        response.json().then((responseData) => {
          comments = responseData.comments;
          getComments();
          toggleForm(false);
        });
      });
    };

    postComments();


    nameInputElement.value = '';
    textInputElement.value = '';
  });

</script>

</html>