<!DOCTYPE html>
<html>

<head>
  <title>Проект "Комменты"</title>
  <meta charset="utf-8" />
  <link rel="stylesheet" href="styles.css" />
</head>

<body>
  <div class="mask">
    <div class="mask-text">Подождите, пожалуйста, комментарии загружаются</div>
  </div>
  <div class="container">
    <ul class="comments" id="add-comment">
      <!-- рендер из JS -->
    </ul>
    <div class="mask-comment">
      <div class="loader-comment">Комментарий загружается...</div>
    </div>
    <div class="add-form">
      <input type="text" class="add-form-name" placeholder="Введите ваше имя" id="form-name" />
      <textarea type="textarea" class="add-form-text" placeholder="Введите ваш коментарий" rows="4"
        id="form-text"></textarea>
      <div class="add-form-row">
        <button class="add-form-button" id="add-button">Написать</button>
      </div>
    </div>
    <button class="add-form-button" id="add-button-delete">Удалить последний комментарий</button>
  </div>
</body>


<!-- СТИЛИ -->
<style>
  .error {
    outline: 3px solid rgb(228, 67, 67);
  }

  .btn {
    background-color: #b9b9b9;
  }
</style>

<script>
  "use strict"; //СТР РЕЖИМ *

  //ПЕРЕМЕННЫЕ
  const nameElement = document.getElementById('form-name');
  const textElement = document.getElementById('form-text');
  const buttonElement = document.getElementById('add-button');
  const buttonDeleteElement = document.getElementById('add-button-delete');
  const formCommentElement = document.getElementById('add-comment');
  const addLoader = document.querySelector(".mask");

  const formLoader = document.querySelector('.add-form');
  const addLoaderComment = document.querySelector(".mask-comment");

  addLoaderComment.style.display = 'none';

  //2.12 функция для получения данных по API
  const getComments = () => {
    return fetch('https://wedev-api.sky.pro/api/v1/egor-gorohow/comments',
      {
        method: 'GET'
      })
      .then((response) => {
        return response.json();
      })
      .then((responseData) => {
        let appComments = responseData.comments.map((comment) => {
          return {
            name: comment.author.name,
            date: new Date(comment.date).toLocaleString('ru-RU', { year: '2-digit', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit', hour12: false }).replace(',', ''),
            text: comment.text,
            likeCount: comment.likes,
            isLike: comment.isLiked
          };
        });
        comments = appComments;
        console.log(appComments);
        renderComments();
        //скрытие лоадера
        addLoader.style.display = 'none';
        addLoaderComment.style.display = 'none';
        formLoader.style.visibility = 'visible';
        buttonDeleteElement.style.visibility = 'visible'
      });
  };

  getComments(); //вызываем функцию котороя получит данные и вызовет render функцию

  // ШАБЛОН ВЫВОДА ДАТЫ СОЗДАНИЯ КОММЕНТАРИЯ
  // function normalDate(date){
  // const currentDate = new Date(date).toLocaleString('ru-RU', { year: '2-digit', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit', hour12: false }).replace(',', '');
  // return currentDate;}

  //РЕНДЕР ДАННЫХ ИЗ МАССИВА ОБЪЕКТОВ
  //upd API - данные постятся и получаются из API
  let comments = [
    // {
    //   name: 'Глеб Фокин',
    //   date: "12.02.22 12:18",
    //   text: 'Это будет первый комментарий на этой странице',
    //   likeCount: 3,
    //   isEdit: false,
    //   isLike: false,
    // },
    // {
    //   name: 'Варвара',
    //   date: "13.02.22 19:22",
    //   text: 'Мне нравится как оформлена эта страница! ❤',
    //   likeCount: 78,
    //   isEdit: false,
    //   isLike: false,
    // }
  ];

  //защитная функция от кода в input (для того что бы тэги введенные в input не влияли на код)
  const sanitizeHtml = (htmlString) => {
    return htmlString.replaceAll("&", "&amp;")
      .replaceAll("<", "&lt;")
      .replaceAll(">", "&gt;")
      .replaceAll('"', "&quot;");
  };

  //Функция редактирования комментария по клику на TEXT комментария
  const editingComment = () => {
    const commentElements = document.querySelectorAll('.comment-text');

    for (const commentElement of commentElements) {
      commentElement.addEventListener('click', () => {
        const index = commentElement.dataset.index;
        const text = `>${comments[index].text} \n ${comments[index].name}:`;
        textElement.value = text;

      })
    }
  }

  //Функция "переключателя" count лайков
  function delay(interval = 300) {
    return new Promise((resolve) => {
      setTimeout(() => {
        resolve();
      }, interval);
    });
  }

  function addLike() {
    const likeElements = document.querySelectorAll('.like-button');
    for (let likeElement of likeElements) {
      likeElement.addEventListener('click', (event) => {
        event.stopPropagation(); //Против "ВСПЛЫТИЯ"
        likeElement.style.animation = 'rotating 2s linear infinite';
        let index = likeElement.dataset.index;
        delay(1600).then(() => {
          if (comments[index].isLike) {
            comments[index].likeCount--;
            comments[index].isLike = false
          } else {
            comments[index].likeCount++;
            comments[index].isLike = true
          }
          renderComments();
        })
      });
    };
  };

  //РЕДАКТИРОВАНИЕ комментария
  const initEditElements = () => {
    const editButtonElements = document.querySelectorAll('.edit-form-button');
    for (const editButton of editButtonElements) {
      editButton.addEventListener('click', (event) => {
        event.stopPropagation();
        const index = editButton.dataset.index;
        comments[index].isEdit = true;
        renderComments();
      });
    };
  };

  //СОХРАНЕНИЕ отредактированного комментария
  const initSaveButtons = () => {
    const saveButtons = document.querySelectorAll(".save-form-button");
    for (const saveButton of saveButtons) {
      saveButton.addEventListener('click', (event) => {
        event.stopPropagation();
        const index = saveButton.dataset.index;
        comments[index].isEdit = false;
        comments[index].text = formCommentElement.querySelectorAll('.comment')[index].querySelector('textarea').value;
        renderComments();
      });
    }
  };


  const postComments = () => {

    fetch('https://wedev-api.sky.pro/api/v1/egor-gorohow/comments',
      {
        method: 'POST',
        body: JSON.stringify({
          name: nameElement.value,
          text: textElement.value
        }),
      })
      .then((response) => {
        return response.json();
      })
      .then((responseData) => {
        return getComments();
      })
      .then(() => {
        buttonElement.disabled = false;
        buttonElement.textContent = "Написать";
      })
    addLoaderComment.style.display = 'block';
    formLoader.style.visibility = 'hidden';
    buttonDeleteElement.style.visibility = 'hidden'
  }

  //Функция добавления комментария (ЛОГИКА) + PUSH новых комментариев
  function addComment() {
    //ВАЛИДАЦИЯ
    //remove для удаления классов
    //trim() для избежания добавления комментариев состоящих из пустых симовлов (пробелов)
    nameElement.classList.remove('error');
    textElement.classList.remove('error');
    if (nameElement.value.trim() === '' || textElement.value.trim() === '') { // если хоть одна ошибка есть
      if (nameElement.value.trim() === '') { // если нет имени
        nameElement.classList.add('error');
        nameElement.placeholder = '* Имя является обязательным!'
      };
      if (textElement.value.trim() === '') { // если нет текста
        textElement.classList.add('error');
        textElement.placeholder = '* Комментраий является обязательным!'
      };
      // сюда дойдет всегда если нет хоть одного поля
      buttonElement.disabled = true;
      buttonElement.classList.add('btn')

      // разблокировка кнопки + удаление обводки
      nameElement.addEventListener('click', () => {
        buttonElement.disabled = false;
        buttonElement.classList.remove('btn');
        textElement.classList.remove('error');
      });
      textElement.addEventListener('click', () => {
        buttonElement.disabled = false;
        buttonElement.classList.remove('btn');
        nameElement.classList.remove('error');
      });
      return;
    };

    //предупреждаем пользователя при нажатии кнопки что данные добавляются и деактивируем кнопку
    buttonElement.disabled = true;
    buttonElement.textContent = "Комментарий добавляется...";
    //Добавляем в функцию postComments API с методом POST для сохранения данных в массиве, она вынесена в отедбную функцию
    postComments()

    nameElement.value = ''; //очищаем форму (имя);
    textElement.value = ''; //очищаем форму (текст);
    nameElement.setAttribute('placeholder', 'Введите ваше имя'); //возвращаем placeholder к стандарту после добаваления комментария
    textElement.setAttribute('placeholder', 'Введите ваш коментарий',);//возвращаем placeholder к стандарту после добаваления комментария
  };

  //ВЫВОД
  const renderComments = () => {
    formCommentElement.innerHTML = comments.map((comment, index) => {
      return `<li class="comment" data-index="${index}">
      <div class="comment-header">
        <div>${sanitizeHtml(comment.name)}</div>
        <div class="comment-date">${sanitizeHtml(comment.date)}</div>
      </div>
      <div class="comment-body">
        ${comment.isEdit
          ? `<textarea type="textarea"  class="add-form-text" placeholder="Введите ваш коментарий" rows="4">${sanitizeHtml(comment.text)}</textarea>`
          : `<div class="comment-text" data-index="${index}"> ${sanitizeHtml(comment.text)} </div>`}
      </div>
      <div class="comment-footer">
        ${comment.isEdit
          ? `<button  class="save-form-button" data-index="${index}">Сохранить</button>`
          : `<button  class="edit-form-button" data-index="${index}">Редактировать</button>`
        }
        <div class="likes">
          <span class="likes-counter">${comment.likeCount}</span>
          <button class="like-button ${comment.isLike ? '-active-like' : ''}" data-index="${index}"></button>
        </div>
      </div>
    </li>`
    }).join('');
    addLike();
    initEditElements();
    initSaveButtons();
    editingComment();
  };

  renderComments();

  // ВЫЗОВ ФУНКЦИИ НА КЛИК
  buttonElement.addEventListener('click', addComment);
  // ВЫЗОВ ФУНКЦИИ НА ENTER
  document.addEventListener('keyup', (event) => {
    if (event.code === 'Enter') {
      addComment();
    };
  });

  //УДАЛИТЬ ПОСЛЕДНИЙ КОММЕНТАРИЙ
  buttonDeleteElement.addEventListener('click', () => {
    comments.pop();
    renderComments();
  });
</script>

</html>