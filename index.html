<!DOCTYPE html>
<html>
  <head>
    <title>Проект "Комменты"</title>
    <meta charset="utf-8" />
    <link rel="stylesheet" href="styles.css" />
  </head>

  <body>
    <div class="container">
      <ul id="comment-list" class="comments">
        <!-- <li class="comment">
          <div class="comment-header">
            <div>Глеб Фокин</div>
            <div>12.02.22 12:18</div>
          </div>
          <div class="comment-body">
            <div class="comment-text">
              Это будет первый комментарий на этой странице
            </div>
          </div>
          <div class="comment-footer">
            <div class="likes">
              <span class="likes-counter">3</span>
              <button class="like-button"></button>
            </div>
          </div>
        </li>
        <li class="comment">
          <div class="comment-header">
            <div>Варвара Н.</div>
            <div>13.02.22 19:22</div>
          </div>
          <div class="comment-body">
            <div class="comment-text">
              Мне нравится как оформлена эта страница! ❤
            </div>
          </div>
          <div class="comment-footer">
            <div class="likes">
              <span class="likes-counter">75</span>
              <button class="like-button -active-like"></button>
            </div>
          </div>
        </li> -->
        <!-- список рендерится из JS -->
      </ul>
      <div class="loading-comment">Комментарии загружаются...</div>
      <div class="add-form">
        <input id="name-input"
          type="text"
          class="add-form-name"
          placeholder="Введите ваше имя"
        />
        <textarea id="comment-input"
          type="textarea"
          class="add-form-text"
          placeholder="Введите ваш коментарий"
          rows="4"
        ></textarea>
        <div class="add-form-row">
          <button id="add-button" class="add-form-button">Написать</button>
        </div>
      </div>
    </div>
  </body>

  <script>
    "use strict";

    const commentListElement = document.getElementById("comment-list");
    const buttonElement = document.getElementById("add-button");
    const nameInputElement = document.getElementById("name-input");
    const commentInputElement = document.getElementById("comment-input");

    const commentsElements = document.querySelectorAll(".comments");

    const likeButtons = document.querySelectorAll(".like-button");
    const likeCounts = document.querySelectorAll(".likes-counter");
    const addForm = document.querySelectorAll(".add-form");

    const loadingComment = document.querySelector(".loading-comment");

    let comments = [
      // {
      //   name: 'Глеб Фокин',
      //   text: 'Это будет первый комментарий на этой странице',
      //   date: '12.02.22 12:18',
      //   likes: 3,
      //   isLike: false
      // },
      // {
      //   name: 'Варвара Н.',
      //   text: 'Мне нравится как оформлена эта страница! ❤',
      //   date: '13.02.22 19:22',
      //   likes: 75,
      //   isLike: true
      // }
    ];

    function enableButton() {
      buttonElement.disabled = true;
      if (nameInputElement.length === 0 && commentInputElement.length === 0) {
        buttonElement.disabled = true;
        }
      }
    enableButton();

    nameInputElement.addEventListener('input', function () {
      if (nameInputElement.value==='' || commentInputElement.value==='') {
        buttonElement.setAttribute('disabled', 'disabled')
      }else{
        buttonElement.removeAttribute('disabled')
      }
    });
    commentInputElement.addEventListener('input', function () {
      if (nameInputElement.value === '' || commentInputElement.value === '') {
        buttonElement.setAttribute('disabled', 'disabled')
      }else{
        buttonElement.removeAttribute('disabled')
      }
    });

    const addQuote = () => {
      const commentElements = document.querySelectorAll(".comment");
      for (const commentElement of commentElements) {
        commentElement.addEventListener('click', () => {
          const index = commentElement.dataset.index;
          if (index !== null) {
            const comment = comments[index];
            commentInputElement.value = `>>${comment.text} \nto: ${comment.name},`;

            comment.text.replace("<div class='quote'</div>");
            const styleQuote = document.querySelectorAll(".quote");
          }
        })
      }
    }

    const renderComments = () => {
      const commentsHtml = comments.map((comment, index) => {
        let liked = comment.isLike ? `-active-like` : ``;
        return `<li class="comment" data-index="${index}">
          <div class="comment-header">
            <div>${comment.name}</div>
            <div>${comment.date}</div>
          </div>
          <div class="comment-body">
            <div class="comment-text">
              ${comment.text}
            </div>
          </div>
          <div class="comment-footer">
            <div class="likes">
              <span class="likes-counter">${comment.likes}</span>
              <button class="like-button ${comment.isLike ? `-active-like` : ``} ${comment.isLikeLoading ? `-loading-like` : ``}" data-index="${index}"></button>
            </div>
          </div>
        </li>`;
      })
      .join("");

      commentListElement.innerHTML = commentsHtml;

      nameInputElement.value = "";
      commentInputElement.value = "";

      addLikes();
      addQuote();
    };

    const fetchComments = () => {

    return fetch("https://wedev-api.sky.pro/api/v1/elena-vakulenko/comments", {
      method: "GET"
    })
    .then((response) => {
      return response.json();
    })
    .then((responseData) => {
        const appComments = responseData.comments.map((comment) => {
          return {
            name: comment.author.name,
            date: new Date(comment.date).toLocaleString(),
            text: comment.text,
            likes: comment.likes,
            isLikeLoading: false,
            isLike: false,
          }
        });
        comments = appComments;
        renderComments();
      })
    .then(() => {
      loadingComment.classList.add("hidden");
    });
    };

    fetchComments();

    function delay(interval = 300) {
      return new Promise((resolve) => {
        setTimeout(() => {
          resolve();
        }, interval);
      });
    }

    // Добавляет обработчики кликов ко всем элементам с классом
    const addLikes = () => {
        // Находит все элементы с классом в разметке
        const likeButtons = document.querySelectorAll(".like-button");
        // Цикл for проходит по каждому элементу в списке
        for (const likeButton of likeButtons) {
          // Добавляет обработчик клика на конкретный элемент в списке
          likeButton.addEventListener("click", () => {
            const index = likeButton.dataset.index;
            comments[index].isLikeLoading = true;

            delay(2000).then(() => {
              comments[index].likes = comments[index].isLike
                ? comments[index].likes - 1
                : comments[index].likes + 1;
              comments[index].isLike = !comments[index].isLike;
              comments[index].isLikeLoading = false;
              renderComments();
            });

            // if (comments[index].isLike) {
            //   comments[index].likes -= 1;
            //   comments[index].isLike = false;
            // } else {
            //   comments[index].likes += 1;
            //   comments[index].isLike = true;
            // }
            event.stopPropagation();
            renderComments();
          });
        }
      };

      renderComments();

    function addZero(z) {
      return (z < 10) ? '0' + z : z;
    }

    function currentDate(d = new Date()) {
      let year = d.getFullYear().toString().substr(-2);
      let month = addZero(d.getMonth() + 1);
      let day = addZero(d.getDate());
      let hour = addZero(d.getHours());
      let minute = addZero(d.getMinutes());
      return `${day}.${month}.${year} ${hour}:${minute}`
    }

    // console.log(commentListElement.innerHTML);
    // commentListElement.innerHTML = "<p> новый текст </p>";

    buttonElement.addEventListener("click", () => {
      nameInputElement.classList.remove("error");
      if(nameInputElement.value === '') {
        nameInputElement.classList.add("error");
        return;
      }

      commentInputElement.classList.remove("error");
      if(commentInputElement.value === '') {
        commentInputElement.classList.add("error");
        return;
      }

      buttonElement.disabled = true;
      buttonElement.textContent = "Комментарий отправляется...";

    // перенесли в POST //

    // comments.push({
    //   name: nameInputElement.value
    //   .replaceAll("&", "&amp;")
    //   .replaceAll("<", "&lt;")
    //   .replaceAll(">", "&gt;")
    //   .replaceAll('"', "&quot;"),
    //   text: commentInputElement.value
    //   .replaceAll("&", "&amp;")
    //   .replaceAll("<", "&lt;")
    //   .replaceAll(">", "&gt;")
    //   .replaceAll('"', "&quot;"),
    //   date: currentDate(),
    //   likes: 0,
    //   isLike: false
    // });

    // перенесли в цепочку промисов //

    //     const postCommentPromise = fetch("https://wedev-api.sky.pro/api/v1/elena-vakulenko/comments", {
    //   method: "POST",
    //   body: JSON.stringify({
    //     text: commentInputElement.value
    //       .replaceAll("&", "&amp;")
    //       .replaceAll("<", "&lt;")
    //       .replaceAll(">", "&gt;")
    //       .replaceAll('"', "&quot;"),
    //     name: nameInputElement.value
    //       .replaceAll("&", "&amp;")
    //       .replaceAll("<", "&lt;")
    //       .replaceAll(">", "&gt;")
    //       .replaceAll('"', "&quot;"),
    //   }),
    // });
    //   postCommentPromise.then((response) => {
    //       const jsonGetCommentsPromise = response.json();
    //       jsonGetCommentsPromise.then((responseData) => {
    // fetchComments();
    //         fetchComments();
    //         commentArray = responseData.comments;
    //       });
    //     });
    //     renderComments();
    //   });
      
    const postPromise = () => {

    const postCommentPromise = fetch("https://wedev-api.sky.pro/api/v1/elena-vakulenko/comments", {
    method: "POST",
    body: JSON.stringify({
      text: commentInputElement.value
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;"),
      name: nameInputElement.value
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;"),
      }),
    })
    .then((response) => {
      return response.json();
    })
    .then(() => {
      return fetchComments();
    })
    .then(() => {
      buttonElement.disabled = false;
      buttonElement.textContent = "Написать";
      renderComments();
    });
    };
    postPromise();
    });

  console.log('It works!');

  </script>
</html>