<!DOCTYPE html>
<html>

<head>
  <title>Проект "Комменты"</title>
  <meta charset="utf-8" />
  <link rel="stylesheet" href="styles.css" />
  <style>
    .error {
      background-color: red;
    }

    .disabled {
      background-color: gray;
      pointer-events: none;
    }

    .like-button.active {
      background-color: rgba(255, 0, 0, 0.566);
    }

    @keyframes rotating {
      from {
        transform: rotate(0deg);
      }

      25% {
        transform: rotate(30deg);
        ;
      }

      75% {
        transform: rotate(-30deg);
        ;
      }

      to {
        transform: rotate(0deg);
      }
    }

    .-loading-like {
      animation: rotating 2s linear infinite;
    }
  </style>
</head>

<body>
  <div class="container">
    <ul class="comments" id="comments-list">
    </ul>
    <div class="add-form">
      <input type="text" class="add-form-name" id="name-input" placeholder="Введите ваше имя" />
      <textarea type="textarea" class="add-form-text" id="comment-input" placeholder="Введите ваш комментарий"
        rows="4"></textarea>
      <div class="add-form-row">
        <button class="add-form-button" id="add-comment-button">Написать</button>
        <button class="deleteCommentButton" id="deleteCommentButton">Удалить последний комментарий</button>
      </div>
    </div>
  </div>

  <script>
    let addCommentButton = document.getElementById("add-comment-button");
    let nameInput = document.getElementById("name-input");
    let commentInput = document.getElementById("comment-input");
    let commentsList = document.getElementById("comments-list");
    let deleteCommentButton = document.getElementById("deleteCommentButton");
    const likeButtons = document.querySelectorAll(".like-button");
    let isAddingComment = false; 

    likeButtons.forEach((button) => {
      button.addEventListener("click", (event) => {
        event.stopPropagation();
        const likesCounter = button.parentElement.querySelector(".likes-counter");
        const currentLikes = parseInt(likesCounter.textContent, 10);

        if (button.classList.contains("active")) {
          button.classList.remove("active", "loading-like");
          likesCounter.textContent = currentLikes - 1;
        } else {
          button.classList.add("active", "loading-like");
          likesCounter.textContent = currentLikes + 1;
        }

        setTimeout(() => {
          button.classList.remove("loading-like");
        }, 2000);
      });
    });

    function sanitizeInput(input) {
      return input.replaceAll("<", "&lt;").replaceAll(">", "&gt;");
    }

    function displayComments(comments) {
      const commentsList = document.getElementById("comments-list");
      commentsList.innerHTML = "";

      comments.forEach((comment) => {
        const { author, date, text, likes } = comment;
        const formattedDate = new Date(date).toLocaleString();

        const commentHtml = `
          <li class="comment">
            <div class="comment-header">
              <div>${author.name}</div>
              <div>${formattedDate}</div>
            </div>
            <div class="comment-body">
              <div class="comment-text">${text}</div>
            </div>
            <div class="comment-footer">
              <div class="likes">
                <span class="likes-counter">${likes}</span>
                <button class="like-button"></button>
              </div>
            </div>
          </li>
        `;

        commentsList.innerHTML += commentHtml;
      });
    }

    async function addComment() {
      if (isAddingComment) {
        return;
      }

      const name = sanitizeInput(nameInput.value.trim());
      const comment = sanitizeInput(commentInput.value.trim());

      if (name === "" || comment === "") {
        if (name === "") {
          nameInput.classList.add("error");
          addCommentButton.classList.add("disabled");
        }
        if (comment === "") {
          commentInput.classList.add("error");
          addCommentButton.classList.add("disabled");
        } else {
          addCommentButton.classList.remove("disabled");
        }
        return;
      }
      nameInput.classList.remove("error");
      commentInput.classList.remove("error");

      const currentDate = new Date();
      const formattedDate = `${currentDate.getDate()}.${currentDate.getMonth() + 1}.${currentDate.getFullYear()} ${currentDate.getHours()}:${currentDate.getMinutes()}`;

      const newComment = {
        name: name,
        author: { name: name },
        text: comment,
        date: formattedDate,
        likes: 0,
        isLiked: false,
      };

      isAddingComment = true;

      commentsList.textContent = "Добавляю..."
      addCommentButton.textContent = "Добавляю...";
      nameInput.value = "Добавляю...";
      commentInput.value = "Добавляю...";
      nameInput.disabled = true;
      commentInput.disabled = true;

      try {
        const response = await fetch("https://wedev-api.sky.pro/api/v1/atamyrat-isayev/comments", {
          method: "POST",
          body: JSON.stringify(newComment),
        });

        const responseData = await response.json();

        console.log("New comment added:", responseData);

        fetchComments();
      } catch (error) {
        alert.error("Кажется что то пошло не так", error);
      } finally {
        isAddingComment = false;

        addCommentButton.textContent = "Написать";
        nameInput.value = "";
        commentInput.value = "";
        nameInput.disabled = false;
        commentInput.disabled = false;
      }
    }

    addCommentButton.addEventListener("click", addComment);

    deleteCommentButton.addEventListener("click", () => {
      const lastComment = commentsList.lastElementChild;
      if (lastComment) {
        commentsList.removeChild(lastComment);
      }

      fetch("https://wedev-api.sky.pro/api/v1/atamyrat-isayev/comments", {
        method: "DELETE",
      })
        .then(() => {
          console.log("Last comment deleted.");

          fetchComments();
        })
        .catch((error) => {
          console.error("Error deleting last comment:", error);
        });
    });

    async function fetchComments() {
      try {
        const response = await fetch("https://wedev-api.sky.pro/api/v1/atamyrat-isayev/comments");
        const comments = await response.json();

        displayComments(comments.comments);
      } catch (error) {
        console.error("Error fetching comments:", error);
      }
    }

    fetchComments();
  </script>
</body>

</html>