<!DOCTYPE html>
<html lang="en">
  <head>
    <title>Проект "Комменты"</title>
    <meta charset="utf-8" />
    <link rel="stylesheet" href="styles.css" />
  </head>

  <body>
    <div class="container">
      <ul class="comments" id="list">
        <!-- Список рендерится из JS -->
      </ul>
      <div class="add-form">
        <input
          id="name-input"
          type="text"
          class="add-form-name"
          placeholder="Введите ваше имя"
        />
        <textarea
          id="comment-input"
          class="add-form-text"
          placeholder="Введите ваш комментарий"
          rows="4"
        ></textarea>
        <div class="add-form-row">
          <button id="add-button" class="add-form-button" disabled>Написать</button>
          <button id="delete-button" class="add-form-button delete-form-button">Удалить последний комментарий</button>
        </div>
      </div>
    </div>
    <script>
      "use strict";
      const deleteButtonElement = document.getElementById("delete-button");
      const buttonElement = document.getElementById("add-button");
      const listElement = document.getElementById("list");
      const nameInputElement = document.getElementById("name-input");
      const commentInputElement = document.getElementById("comment-input");

      const shortDateTime =
        new Date().getDate().toString().padStart(2, "0") +
        "." +
        (new Date().getMonth() + 1).toString().padStart(2, "0") +
        "." +
        new Date().getFullYear().toString().slice(-2) +
        " " +
        new Date().toLocaleTimeString().slice(0, -3);

      const comments = [
        {
          name: "Глеб Фокин",
          dateOfCreation: "12.02.22 12:18",
          textComment: "Это будет первый комментарий на этой странице",
          likeComment: false,
          likesNumber: 3,
          propertyLikeImage: "like-button -no-active-like",
        },
        {
          name: "Варвара Н.",
          dateOfCreation: "13.02.22 19:22",
          textComment: "Мне нравится как оформлена эта страница! ❤",
          likeComment: false,
          likesNumber: 75,
          propertyLikeImage: "like-button -no-active-like",
        },
      ];

      function getLikes() {
        const likesButton = document.querySelectorAll(".like-button");
        for (const like of likesButton) {
          like.addEventListener("click", (event) => {
            event.stopPropagation();
            const likeIndex = like.dataset.index;
            const commentsElementLikeIndex = comments[likeIndex];
            if (commentsElementLikeIndex.likeComment) {
              commentsElementLikeIndex.likesNumber -= 1;
              commentsElementLikeIndex.likeComment = false;
              commentsElementLikeIndex.propertyLikeImage =
                "like-button -no-active-like";
            } else {
              commentsElementLikeIndex.likesNumber += 1;
              commentsElementLikeIndex.likeComment = true;
              commentsElementLikeIndex.propertyLikeImage =
                "like-button -active-like";
            }
            renderComments();
          });
        }
      }

      function replyToComment() {
        let commentElements = document.querySelectorAll(".comment");
        for (const commentElement of commentElements) {
          commentElement.addEventListener("click", () => {
            const indexComment = commentElement.dataset.index;
            commentInputElement.value = `>${comments[indexComment].name}:\n${comments[indexComment].textComment}\n\n`;
          });
        }
      }

      const renderComments = () => {
        const commentsHtml = comments
          .map((comment, index) => {
            
            return `<li class="comment" data-index="${index}">
              <div class="comment-header" data-index="${index}">
                <div>${comment.name
                  .replaceAll("&", "&amp;")
                  .replaceAll("<", "&lt;")
                  .replaceAll(">", "&gt;")
                  .replaceAll('"', "&quot;")}</div>
                <div>${comment.dateOfCreation}</div>
              </div>
              <div class="comment-body">
                <div data-index="${index}" class="comment-text">
                  ${comment.textComment
                    .replaceAll("&", "&amp;")
                    .replaceAll("<", "&lt;")
                    .replaceAll(">", "&gt;")
                    .replaceAll('"', "&quot;")
                    .replaceAll("QUOTE_BEGIN", "<div class='comment-quote'><b>")
                    .replaceAll("QUOTE_END", "</b></div>")}
                </div>
              </div>
              <div class="comment-footer">
                <div class="likes">
                  <span class="likes-counter">${comment.likesNumber}</span>
                  <button data-index="${index}" class="like-button ${comment.propertyLikeImage}" alt="Like"></button>
                </div>
              </div>
            </li>`;
          })
          .join("");
        listElement.innerHTML = commentsHtml;
        getLikes();
        replyToComment();

        nameInputElement.value = "";
        commentInputElement.value = "";
        buttonElement.disabled = true;
        if (nameInputElement.value.length > 0 && commentInputElement.value.length > 0) {
          buttonElement.disabled = false;
        }
      };

      renderComments();

      nameInputElement.addEventListener("input", () => {
        buttonElement.disabled = true;
        if (nameInputElement.value.length > 0 && commentInputElement.value.length > 0) {
          buttonElement.disabled = false;
        }
      });

      commentInputElement.addEventListener("input", () => {
        buttonElement.disabled = true;
        if (nameInputElement.value.length > 0 && commentInputElement.value.length > 0) {
          buttonElement.disabled = false;
        }
      });

      buttonElement.addEventListener("click", () => {
        const shortDateTime =
        new Date().getDate().toString().padStart(2, "0") +
        "." +
        (new Date().getMonth() + 1).toString().padStart(2, "0") +
        "." +
        new Date().getFullYear().toString().slice(-2) +
        " " +
        new Date().toLocaleTimeString().slice(0, -3);
        comments.push({
          name: nameInputElement.value,
          dateOfCreation: shortDateTime,
          textComment: commentInputElement.value,
          likeComment: false,
          likesNumber: 0,
          propertyLikeImage: "like-button -no-active-like",
        });
        renderComments();
      });

      document.addEventListener("keyup", function (enter) {
        if (enter.keyCode == 13) {
          buttonElement.click();
        }
      });

      deleteButtonElement.addEventListener("click", () => {
        comments.pop();
        renderComments();
      });
    </script>
  </body>
</html>