<!DOCTYPE html>
<html>

<head>
  <title>Проект "Комменты"</title>
  <meta charset="utf-8" />
  <link rel="stylesheet" href="styles.css" />
</head>

<body>
  <div class="container">
    <ul class="comments" id="comments">

    </ul>
    <div class="add-form">
      <input type="text" class="add-form-name" id="add-form-name" placeholder="Введите ваше имя" />
      <textarea type="textarea" class="add-form-text" id="add-form-text" placeholder="Введите ваш коментарий"
        rows="4"></textarea>
      <div class="add-form-row">
        <button class="add-form-button" id="add-form-button">Написать</button>
      </div>
    </div>

    <div class="delete"><button class="button" id="delete-button">Удалить последний комментарий</button></div>
  </div>
</body>

<script>
  "use strict";
  let comments = [
    {
      name: 'Глеб Фокин',
      year: 22,
      month: 2,
      day: 12,
      hour: 12,
      minute: 18, //12.02.22 12:18
      text: 'Это будет первый комментарий на этой странице',
      likes: 3,
      isLiked: false,
      numComment: 0,
      isEdit: false
    },
    {
      name: 'Варвара Н.',
      year: 22,
      month: 2,
      day: 13,
      hour: 19,
      minute: 22,
      text: 'Мне нравится как оформлена эта страница! ❤',
      likes: 73,
      isLiked: true,
      numComment: 1,
      isEdit: false
    },
  ];

  const nameForm = document.getElementById('add-form-name');
  const commentForm = document.getElementById('add-form-text');
  const button = document.getElementById('add-form-button');
  const listElement = document.getElementById('comments');

  function dateCheck(num) {
    let result = ''

    if (num < 10) {
      result = '0' + num;
    } else {
      result = num;
    }

    return result;
  }

  function renderComments() {
    const commentsHTML = comments.map((student) => {
      let liked = '';
      let textEdit = '';
      let btnEdit = '';

      if (student.isLiked) {
        liked = ' -active-like'
      }

      if (student.isEdit) {
        textEdit = `<textarea class="textarea" id='textarea'>${student.text}</textarea>`;
        btnEdit = `Сохранить`;
      } else {
        textEdit = `<div class="comment-text">
          ${student.text}
        </div>`;
        btnEdit = `Редактировать`;
      }

      return `<li class="comment" data-numComments="${student.numComment}">
      <div class="comment-header">
        <div>${student.name}</div>
        <div>${dateCheck(student.day)}.${dateCheck(student.month)}.${dateCheck(student.year)} ${dateCheck(student.hour)}:${dateCheck(student.minute)}</div>
      </div>
      <div class="comment-body">` +
        textEdit +
        `</div>
      <div class="comment-footer">
        <button class="button-edit" data-numComments="${student.numComment}">` + btnEdit + `</button>
        <div class="likes">
          <span class="likes-counter">${student.likes}</span>
          <button class="like-button` + liked
        + `" data-numComments="${student.numComment}"></button>
        </div>
      </div>
    </li>`
    })
      .join('');

    listElement.innerHTML = commentsHTML;
    initEventListeners();
    initEventButtonEdit();
    reply();
  }

  renderComments();

  function addComment() {
    let date = new Date();

    nameForm.classList.remove('error');
    commentForm.classList.remove('error');

    if ((nameForm.value.trim() == '') && (commentForm.value.trim() == '')) {
      nameForm.classList.add('error');
      commentForm.classList.add('error');
      return;
    }
    else if (nameForm.value.trim() == '') {
      nameForm.classList.add('error');
      return;
    } else if (commentForm.value.trim() == '') {
      commentForm.classList.add('error');
      return;
    }

    let unsafeName = nameForm.value; // устранение уязвимости
    let unsafeComm = commentForm.value;

    let safeName = unsafeName.replaceAll("&", "&amp;")
      .replaceAll("<", "&lt;")
      .replaceAll(">", "&gt;")
      .replaceAll('"', "&quot;");
    let safeComm = unsafeComm.replaceAll("&", "&amp;")
      .replaceAll("<", "&lt;")
      .replaceAll(">", "&gt;")
      .replaceAll('"', "&quot;")
      .replaceAll('QUOTE_BEGIN', "<div class='quote'>")
      .replaceAll('QUOTE_END', '</div>');

    if (safeComm.startsWith('>')) {

    }


    comments.push({
      name: safeName,
      text: safeComm,
      isLiked: false,
      likes: 0,
      year: date.getFullYear() - 2000,
      month: date.getMonth(),
      day: date.getDate(),
      hour: date.getHours(),
      minute: date.getMinutes(),
      numComment: comments.length,
      isEdit: false
    });

    nameForm.value = '';
    commentForm.value = '';

    renderComments();
  }

  button.disabled = true;

  nameForm.addEventListener('input', () => {
    commentForm.addEventListener('input', () => {
      button.disabled = false;
    })
  })

  commentForm.addEventListener('input', () => {
    nameForm.addEventListener('input', () => {
      button.disabled = false;
    })
  })

  button.addEventListener("click", addComment);

  commentForm.addEventListener('keypress', (e) => {
    if (e.keyCode == 13) {
      // button.click();
      addComment();
    }
  })

  const deleteButton = document.getElementById('delete-button');

  deleteButton.addEventListener('click', () => {

    if (comments == []) {
      alert('Удалять нечего');
      return;
    }

    let result = comments.pop();
    renderComments();
  })

  function initEventListeners() {
    let likeButtons = document.querySelectorAll('.like-button');
    for (let likeButton of likeButtons) {
      likeButton.addEventListener('click', (event) => {
        event.stopPropagation();
        let numComm = likeButton.getAttribute('data-numComments');

        if (comments[numComm].isLiked) {
          comments[numComm].isLiked = !comments[numComm].isLiked;
          comments[numComm].likes--;
        } else {
          comments[numComm].isLiked = !comments[numComm].isLiked;
          comments[numComm].likes++;
        }

        renderComments();
      })
    }
  }

  function initEventButtonEdit() {
    let buttonsEdit = document.querySelectorAll('.button-edit');

    for (let buttonEdit of buttonsEdit) {
      buttonEdit.addEventListener('click', (event) => {
        event.stopPropagation();
        let numComm = buttonEdit.getAttribute('data-numComments');
        let txtEdit = document.getElementById('textarea');

        comments[numComm].isEdit = !comments[numComm].isEdit;

        if (!comments[numComm].isEdit) {
          comments[numComm].text = txtEdit.value;
        }

        renderComments();;
      });
    }
  }

  function reply() {
    let replyComms = document.querySelectorAll('.comment');

    for (let replyComm of replyComms) {
      replyComm.addEventListener('click', () => {
        let numComm = replyComm.getAttribute('data-numComments');
        console.log('Ответ сработал', numComm);
        commentForm.value = `QUOTE_BEGIN${comments[numComm].name}:
${comments[numComm].text} QUOTE_END

`;
      })
    }
  }
</script>

</html>