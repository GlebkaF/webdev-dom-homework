<!DOCTYPE html>
<html>
  <head>
    <title>Проект "Комменты"</title>
    <meta charset="utf-8" />
    <link rel="stylesheet" href="styles.css" />
  </head>

  <body>
    <div class="container">
      <ul class="comments" id="comment-list">
        
      </ul>
      <div class="dpnone text-wile">
Пожалуйста подождите,комментарий загружается...
      </div>

      <div class="add-form">
        <input
          type="text"
          class="add-form-name"
          placeholder="Введите ваше имя"
          id="input-name"
        />
        <textarea
          type="textarea"
          class="add-form-text"
          placeholder="Введите ваш коментарий"
          id="input-text"
          rows="4"
        ></textarea>
        <div class="add-form-row">
          <button class="add-form-button add-form-button_disabled" id="add-button" disabled>Написать</button>
        </div>
      </div>
    </div>
  </body>

  <style>
.error{
border: 3px solid red;
}
  </style>

  <script>
    "use strict";
    // Код писать здесь 

    let countOfLikes = 0;

    const buttonElement = document.getElementById("add-button");
    const nameElement = document.getElementById("input-name");
    const textElement = document.getElementById("input-text");
    const listElement = document.getElementById("comment-list");
    const formComment = document.querySelector('.add-form');
    const messageComment = document.querySelector('.text-wile');

    let comments = [
    // {
    // name: 'Глеб Фокин', 
    // date: '12.02.22 12:18', 
    // text: 'Это будет первый комментарий на этой странице',
    // likes: '3',
    // isActiveLike: false,
    // }, 
    // {
    //   name: 'Варвара Н.', 
    // date: '13.02.22 19:22', 
    // text: 'Мне нравится как оформлена эта страница! ❤',
    // likes: '75',
    // isActiveLike: false,
    // }
  ];

    const initUpdateLike = () => {
      const likeButtonsElements = document.querySelectorAll('.like-button');

      for (const likeButtonsElement of likeButtonsElements) {
        likeButtonsElement.addEventListener('click', (e) => {
          e.stopPropagation();
          const index = likeButtonsElement.dataset.index; 
          if (likeButtonsElement.classList.contains('-active-like')) {
            comments[index].likes = Number(comments[index].likes)-1;
          } else {
            comments[index].likes = Number(comments[index].likes)+1;
          }
          comments[index].isActiveLike = !comments[index].isActiveLike;
          renderComments();
        })
      }
    };

    const initAnswerComment = () => {
      const oldComments = document.querySelectorAll('.comment')
      for (const oldComment of oldComments) {
        oldComment.addEventListener('click', () => {
          textElement.value = `> ${oldComment.querySelector('.comment-text').innerHTML
          .replaceAll("&amp;" , "&")
          .replaceAll("&lt;" , "<")
          .replaceAll("&gt;" , ">")
          .replaceAll("&quot;" , '"')}`
          + `\n\n${oldComment.querySelector('.comment-header').children[0].innerHTML
          .replaceAll("&amp;" , "&")
          .replaceAll("&lt;" , "<")
          .replaceAll("&gt;" , ">")
          .replaceAll("&quot;" , '"')}`
        })
      }
    }

      //Функция форматирования даты 
      const formattedDate = (dateObject) => {
      let minutes = dateObject.getMinutes();
      let months = dateObject.getMonth() + 1;
      let years = dateObject.getFullYear() - 2000;
      if (minutes < 10) {
        minutes = "0" + minutes;
      }
      if (months < 10) {
        months = "0" + months;
      }
      const outDate = dateObject.getDate() + '.' + months + '.' + years + '  ' + dateObject.getHours() + ':' + minutes;
      return outDate;
    }

    const renderComments = () => {
      const commentHtml = comments.map((item, index) => {
        let activeLike = '';
        if (comments[index].isActiveLike) {
          activeLike = '-active-like'
        }
        return `  
        <li class="comment">
          <div class="comment-header">
            <div> ${item.name} </div>
            <div> ${formattedDate(item.date)} </div>
          </div>
          <div class="comment-body">
            <div class="comment-text">
              ${item.text}
            </div>
          </div>
          <div class="comment-footer">
            <div class="likes">
              <span class="likes-counter">
                ${item.likes}
              </span>
              <button class="like-button ${activeLike}" data-id="${item.id}" data-index="${index}"></button>
            </div>
          </div>
        </li>`
      }).join('');
      listElement.innerHTML = commentHtml;
      initUpdateLike();
      initAnswerComment();
    }

    const convertServer = (response) => {
      response.json().then((responseData) => {
        comments = responseData.comments; 
        comments = comments.map((item) => {
          return {
            name: item.author.name, 
            date: new Date(item.date),
            text: item.text,
            likes: item.likes,
            isActiveLike: item.isLiked,
            id: item.id,
          }
        })
        renderComments();
      })
    }
    
    const protectionHtml = (string) => {
      return string 
      .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
    };

    function letDisabledButton(expectedValue) {
      if (expectedValue === '') {
        buttonElement.disabled = true;
        buttonElement.classList.add('add-form-button_disabled')
      } else {
        buttonElement.disabled = false;
        buttonElement.classList.remove('add-form-button_disabled')
      }
    };

    function letClearForm(form) {
      form.classList.remove('error')
    };
    nameElement.addEventListener('input', () => {
      letDisabledButton(nameElement.value);
    });
    textElement.addEventListener('input', () => {
      letDisabledButton(textElement.value);
    });
    nameElement.addEventListener('click', () => {
      letClearForm(nameElement);
    });
    textElement.addEventListener('click', () => {
      letClearForm(textElement);
    });
    
    //Функция вызываемая в обработчике 
    const sentComment = () => {
    nameElement.classList.remove('error');
    textElement.classList.remove('error');

      let currentDate = new Date();

      if (nameElement.value === '') {
        nameElement.classList.add('error');
        if (textElement.value === '' || textElement.value === '\n') {
          textElement.classList.add('error');
        }
        return;
      }
      if (textElement.value === '' || textElement.value === '\n') {
        textElement.classList.add('error');
        return;
    }

    formComment.classList.add('dpnone');
    messageComment.classList.remove('dpnone');


    // countOfLikes = 0;

    // comments.push({
    //   name: protectionHtml(nameElement.value),
    //   date: formattedDate(currentDate),
    //   text: protectionHtml(textElement.value),
    //   likes: countOfLikes,
    //   isActiveLike: false,
    // })

    fetch("https://wedev-api.sky.pro/api/v1/Andrey-Nosov/comments", {
      method: "POST",
      body: JSON.stringify({
        name: protectionHtml(nameElement.value),
        text: protectionHtml(textElement.value),
      })
    }).then((response) => {
      if (response.status == 201) {
        fetchComments();
        return response;
      } else {
        console.log(response.status);
        return response;
      }
    })
    .then(() => {
      formComment.classList.remove('dpnone');
      messageComment.classList.add('dpnone');
    })

    nameElement.value = '';
    textElement.value = '';
    return;
  };

  function fetchComments(){
    fetch("https://wedev-api.sky.pro/api/v1/Andrey-Nosov/comments", {
      method: "GET",
    }).then((response) => {
      convertServer(response);
    })
  };

  listElement.innerHTML = 'Пожалуйста подождите,комментарии подгружаются...'
  fetchComments();

   buttonElement.addEventListener('click', sentComment);

   document.addEventListener('keyup', (e) => {
    if (e.code === 'Enter') {
      sentComment();
    }
   })

    console.log("It works!");
   
  </script>
</html>
