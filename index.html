<!DOCTYPE html>
<html>
  <head>
    <title>Проект "Комменты"</title>
    <meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="styles.css" />
	<title>COmmentariii</title>
  </head>

  <body>
	<div class="container">
    	<div id="container-preloader"></div>
    	<ul id="list" class="comments"></ul>
    	<div id="container-preloader-post"></div>
		<div class="add-form">
			<input
			type="text"
			class="add-form-name"
			placeholder="Введите ваше имя"
			value=""
			/>
			<textarea
			type="textarea"
			class="add-form-text"
			placeholder="Введите ваш коментарий"
			rows="4"
			>
			</textarea>
       		<div class="add-form-row">
        		<button class="add-form-button">Написать</button>
        	</div>
		</div>	
	</div>
  </body>

  <script>
	"use strict";
	const btnElement = document.querySelector('.add-form-button');
	const nameInputElement = document.querySelector('.add-form-name');
	const nameTextAreaElement = document.querySelector('.add-form-text');
	const myDate = new Date().toLocaleDateString().slice(0, 6) + new Date().toLocaleDateString().slice(-2);
	const nowDate = myDate + ' ' + new Date().toLocaleTimeString().slice(0, -3);

	const listElement = document.getElementById('list');

	
	const containerPreloader = document.getElementById('container-preloader');
	const containerPreloaderPost = document.getElementById('container-preloader-post');
	const addFormElement = document.querySelector('.add-form');

	let comments = [];

	containerPreloader.textContent = `Идет загрузка комментария...`;

	const fetchAndRendetTasks = () => {
		return fetch("https://wedev-api.sky.pro/api/v1/elnur-kakhramanov/comments", {
			method: "GET"
		})

			.then((response) => {
				containerPreloader.textContent = '';
				return response.json();
			})
			.then((responseData) => {

				const appComments = responseData.comments.map((comment) => {
					return {
						name: comment.author.name,
						date: new Date(comment.date),
						likes: comment.likes,
						isLiked: false,
						text: comment.text,
					};
				});

				comments = appComments;
				renderComments();
			});
	}


	const initEventListeners = () => {

		const buttonElements = document.querySelectorAll('.like-button');

		for (const buttonElement of buttonElements) {
			buttonElement.addEventListener('click', (event) => {
				event.stopPropagation();
				const index = buttonElement.dataset.index;
				if (comments[index].isLiked) {
					comments[index].isLiked = false;
					comments[index].likes--;
				} else {
					comments[index].isLiked = true;
					comments[index].likes++;
				}

				renderComments();
			});
		}

		const answerElements = document.querySelectorAll('.comment');

		for (const answer of answerElements) {
			answer.addEventListener('click', () => {
				const index = answer.dataset.index;
				nameTextAreaElement.value = `QUOTE_BEGIN${comments[index].name}:\n${comments[index].comment}QUOTE_END`;
			});
		}
	};

	const renderComments = () => {
		const commentsHtml = comments.map((comment, index) => {
			return `<li class="comment" data-index='${index}'>
						<div class="comment-header">
							<div>${comment.name}</div>
							<div>${comment.date}</div>
						</div>
						<div class="comment-body">
						${comment.isEdit ? `<textarea class='add-form-text comment-edit-text'>${comment.text}</textarea>` : `<div class="comment-text" style="white-space:pre-line">
							${comment.text}
						</div>`}
						</div>
						<button class="add-form-button edits" data-index='${index}'>${comment.isEdit ? 'Сохранить' : 'Редактировать'}</button>
						<div class="comment-footer">
							<div class="likes">
								<span class="likes-counter">${comment.likes}</span>
								<button class="like-button ${comment.isLiked ? '-active-like' : ''}" data-index='${index}'>
								</button>
							</div>
						</div>
					</li>`;
		}).join('');			

		listElement.innerHTML = commentsHtml;
		initEventListeners();
		functionEdit();
	}

	function functionEdit() {
		const commentEditText = document.querySelector('.comment-edit-text');
		const editElements = document.querySelectorAll('.edits');
		for (const edit of editElements) {
			edit.addEventListener('click', () => {
				const index = edit.dataset.index;
				console.log(index);

				if (comments[index].isEdit) {
					comments[index].isEdit = false;
					comments[index].text = commentEditText.value;
				} else {
					comments[index].isEdit = true;
				}
				renderComments();
			});
		}
	}

	fetchAndRendetTasks();
	renderComments();

	const likesElements = document.querySelectorAll('.likes');


	btnElement.addEventListener('click', () => {
		addFormElement.classList.add('form-none');
		nameInputElement.classList.remove('error');
		nameTextAreaElement.classList.remove('error');

		if (nameInputElement.value === '') {
			nameInputElement.classList.add('error');
			return;
		}
		if (nameTextAreaElement.value === '') {
			nameTextAreaElement.classList.add('error');
			return;
		}


		const addTodo = () => {
			containerPreloader.textContent = 'Добавляется комментарий...';
			
			return fetch("https://wedev-api.sky.pro/api/v1/elnur-kakhramanov/comments", {
				method: "POST",
				body: JSON.stringify({
					text: nameTextAreaElement.value.replaceAll("&", "&amp;")
						.replaceAll("<", "&lt;")
						.replaceAll(">", "&gt;")
						.replaceAll('"', "&quot;")
						.replaceAll("QUOTE_BEGIN", "<div class='quote'>")
						.replaceAll("QUOTE_END", "</div>"),
					name: nameInputElement.value.replaceAll("&", "&amp;")
						.replaceAll("<", "&lt;")
						.replaceAll(">", "&gt;")
						.replaceAll('"', "&quot;")
						.replaceAll("QUOTE_BEGIN", "<div class='quote'>")
						.replaceAll("QUOTE_END", "</div>"),
				})
			})
				.then((responseData) => {
					return responseData;
				})
				.then((response) => {
					return response.json();
				})
				.then((responseData) => {
					return fetchAndRendetTasks();
				})
				.then((data) => {
					containerPreloaderPost.textContent = '';
					addFormElement.classList.remove('form-none');
				})
		}
			
		addTodo();
		renderComments();
		nameInputElement.value = '';
		nameTextAreaElement.value = '';
	
	});
  </script>
</html>