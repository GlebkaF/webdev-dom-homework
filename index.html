<!DOCTYPE html>
<html>
  <head>
    <title>Проект "Комменты"</title>
    <link rel="stylesheet" href="styles.css" />
  </head>

  <body>
    <div class="container">
      <ul class="comments" id="list" >
       <!-- рендерится из js  -->
      </ul>
      <div class="add-form">
        <input 
          type="text"
          
          class="add-form-name"
          id ="name-input"
          placeholder="Введите ваше имя"
        />
        <textarea
          type="textarea"
          
          class="add-form-text"
          id="comm-input"
          placeholder="Введите ваш коментарий"
          rows="4"
        ></textarea>
        <div class="add-form-row">
          <button id="add-button" class="add-form-button" disabled class = "disabled" >Написать</button>
        </div>  
      </div>
      <div>
        <button  id ="delete-button" class="add-form-button"> Удалить последний комментарий </button>
              </div>
    </div>

  </body>
  <style>
    .add-form-text {
      white-space: pre-line;
    }
    .disabled{
      background-color: gray;
    }
    .error{
      background-color: #e74a35;
    }
    </style>
  <script>
    const buttonElement = document.getElementById("add-button"); 
    const listElement = document.getElementById("list");
    const nameinputElement = document.getElementById("name-input");
    const comminputElement = document.getElementById("comm-input");
    
  
  // Текст на кнопке серый, пока не заполнишь Имя пользователя:
    nameinputElement.addEventListener('input', () => {
  if (nameinputElement.value.length > 0) {
        buttonElement.disabled = false;
          buttonElement.classList.remove('disabled');
  } else {
        buttonElement.disabled = true;
          buttonElement.classList.add('disabled')
  }

});

 //Кнопка Enter активирует кнопку - Написать
     comminputElement.addEventListener("keyup", function(event) {

    if (event.keyCode === 13) {
        event.preventDefault();
          document.getElementById("add-button").click();
  }
}); //Удаление последнего комментария с помощью кнопки Удалить посл.комм.
    const deleteButtonElement = document.getElementById('delete-button');
        function deleteLastComment() {
// Находим последний элемент списка комментариев
    const lastCommentIndex = listElement.innerHTML.lastIndexOf('<li class="comment">');
         if (lastCommentIndex !== -1) {
  // Удаляем последний элемент
    const lastCommentElement = listElement.children[listElement.children.length - 1];
         listElement.removeChild(lastCommentElement);
}
}
// Добавляем обработчик события click на кнопку
deleteButtonElement.addEventListener('click', deleteLastComment);  
 
//ДЗ 2.10: 

   const likesButtons= document.querySelectorAll('.like-button');
   const inputText = document.querySelectorAll('.input-text');
   const editButtons = document.querySelectorAll('.edit-button');
   const saveButtons = document.querySelectorAll('.save-button');
  

// Создаем массив комментариев, теперь комментарии здесь:
   const comments = [
    {
       name: 'Глеб Фокин',
        text: 'Это будет первый комментарий на этой странице',
        date: '12.02.22 12:18',
        clickOn: false,
        likes: 3,
        isEdit: false,
		    
    },
    {
        name: 'Варвара Н.',
        text: 'Мне нравится как оформлена эта страница! ❤',
        date: '13.02.22 19:22',
        clickOn: false,
        likes: 75,
		    isEdit: false,
    }
    
];

//Добавление лайков :
const eventeLikesButtons = () => {
    const likesButtons = document.querySelectorAll('.like-button')
	for (const likesButton of likesButtons){
      const index =  likesButton.dataset.index;
	  likesButton.addEventListener('click', () => {
           if (!comments[index].clickOn) {
                comments[index].clickOn = true;
                comments[index].active ='-active-like'; 
                comments[index].likes += 1;

            } else {
              comments[index].clickOn = false;
                comments[index].active =''; 
                comments[index].likes -= 1;

            }
        
            renderComment();
          })
        }
      }

      // Добавляем редактирование комментария:
const eventEditButtons = () => {
const editButtons = document.querySelectorAll('.edit-button');
for (const editButton of editButtons){
  const index = editButton.dataset.index;
  editButton.addEventListener('click',() => {
    comments[index].isEdit = !comments[index].isEdit;
    renderComment();
  })
}
}

//  Сохранение отредактированного коментария:
const eventSaveButton = () => {
  const saveButtons = document.querySelectorAll('.save-button');
  for (const saveButton of saveButtons){
    const index = saveButton.dataset.index;
    const editedComment = document.getElementById(`${index}0`); // если 0 не поставим, то значение будет undefined вместо текста отредакт-го коммента
    saveButton.addEventListener('click',() =>{ 
      comments[index].text = editedComment.value;
      comments[index].isEdit = false;
      renderComment();
    })
  }
}

//рендер комментария: 
const renderComment = () => {
  const commentsHTML = comments.map((comment, index) => {
    return comment.isEdit ?
    `<li class="comment">
          <div class="comment-header">
            <div>${comment.name}</div>
            <div>${comment.date}</div>
          </div>
          <div class="comment-body">
            <textarea id="${index}0" class="input-text" type="textarea"> </textarea>
            </div>
          <div class="comment-footer">
            <div class="likes">
              <span id="${index}"class="likes-counter"> ${comment.likes}</span>
              <button data-index ="${index}" data-name = "${comment.name}" data-text = "${comment.text}"
              data-likes = "${comment.likes}" data-index ="${index}" class="like-button ${comment.active}" ></button>
            </div>
          </div>
          <button data-index = "${index}" class = "save-button" type ="button" > Сохранить </button>
        </li>`
        :
        `<li class="comment">
          <div class="comment-header">
            <div>${comment.name}</div>
            <div>${comment.date}</div>
          </div>
          <div class="comment-body">
            <div class="comment-text" >
              ${comment.text}
            </div>
          </div>
          <div class="comment-footer">
            <div class="likes">
              <span id ="${index}"class="likes-counter"> ${comment.likes}</span>
              <button data-index ="${index}" data-name = "${comment.name}" data-text = "${comment.text}"
              data-likes = "${comment.likes}" data-index="${index}" class="like-button ${comment.active}"></button>
            </div>
          </div>
          <button data-index="${index}" class = "edit-button" type ="button"> Редактировать </button>
        </li>`
  }) 
  .join("");
  listElement.innerHTML = commentsHTML;
  eventeLikesButtons();
  eventSaveButton();
  eventEditButtons (); 


function eventReplyButton() {
// добавляем обрабочкик клика на текст комментария
const commentTexts = document.querySelectorAll('.comment-text');
 for (const text of commentTexts) {
  text.addEventListener('click', (event) => {
    const index = event.target.parentNode.parentNode.querySelector('.like-button').dataset.index;//parentNode вызывыется дважды, чтобы получить родительский элемент(все комментарии)
    const authorName = event.target.parentNode.parentNode.querySelector('.comment-header > div:first-child').textContent;
    const commentText = event.target.textContent;

    document.getElementById('name-input').value = " "; 
    document.getElementById('comm-input').value = ">"+ commentText.replace(/\n/g,'') + "\n"+authorName + "\n" ; 
    event.stopPropagation();
  });

}

}
eventReplyButton(); // добавлен вызов

}
renderComment ();

function newComment() {
  nameinputElement.classList.remove('error')
  comminputElement.classList.remove("error");
  if(nameinputElement.value === "" ){
                nameinputElement.classList.add("error");  
                return;
  } else if (comminputElement.value === "" ){
            comminputElement.classList.add("error");
            return;
}
//добавление актуальной даты и времени в новом комментарии:   
  let now = new Date();
  let day = now.getDate().toString().padStart(2, '0');
  let month = (now.getMonth() + 1).toString().padStart(2, '0');
  let year = now.getFullYear().toString().substr(-2);
  let hour = now.getHours().toString().padStart(2, '0');
  let minute = now.getMinutes().toString().padStart(2, '0');
  let formattedDate = `${day}.${month}.${year} ${hour}:${minute}`;

comments.push(
{
        name:nameinputElement.value 
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;"),
        text: comminputElement.value
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;"),
        date: `${formattedDate}`,
        likes: 0,
        isEdit: false,
        clickOn: false,		
}
)

renderComment();
nameinputElement.value = ""; comminputElement.value = "";

}

buttonElement.addEventListener('click',() => {
  newComment();

});


  </script>
</html>





