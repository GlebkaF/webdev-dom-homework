<!DOCTYPE html>
<html>
  <head>
    <title>Проект "Комменты"</title>
    <meta charset="utf-8" />
    <link rel="stylesheet" href="styles.css" />
  </head>

  <body>
    <div class="container">
      <ul class="comments" id="comments">
<!-- Список из js -->
      </ul>
      <div class="add-form" id = 'add-form'>
        <input
          type="text"
          class="add-form-name"
          placeholder="Введите ваше имя" id = 'input-name'
        />
        <textarea
          type="textarea"
          class="add-form-text"
          placeholder="Введите ваш коментарий"
          rows="4" id ="new-text"
        ></textarea>
        <div class="add-form-row">
          <button class="add-form-button" id = 'add-form-button'>Написать</button>
        </div>
      </div>
    </div>
  </body>
  <script>
    "use strict";
const buttonElement = document.getElementById('add-form-button');
const commentsElement = document.querySelector('.comments');
const nameInputElement = document.getElementById('input-name');
const textElement = document.querySelector('.add-form-text');

const addFormElement = document.getElementById('add-form');


let now = new Date().toLocaleDateString('default', {year: '2-digit', month: '2-digit', day: '2-digit'});
let time = new Date().toTimeString().substr(0,5);
let commentDate = ` ${now} ${time}`;

function loaderComments (){
  commentsElement.textContent = "Подождите, лента коммментариев загружается"; 
}


//получить из хранилища данных 
let  comments = [];

function fetchFunction  () {
return fetch("https://wedev-api.sky.pro/api/v1/tanya-bulaeva/comments",{
method: "GET"
})
.then((response) => {

loaderComments();
return  response.json()})
.then((responseData) => {

const appComments  = responseData.comments.map ((comment) => {

  return {
name: comment.author.name,
dateCreation: commentDate,
textElement: comment.text,
likesNumber: comment.likes,
isLiked: false,
  };
});
comments = appComments;
renderComments();
})
}
fetchFunction();
loaderComments ();


//цитирование
const quotation = () => {
let commentElements  = document.querySelectorAll ('.comment');
for (const commentElement of commentElements){
commentElement.addEventListener('click', () => {
const index = commentElement.dataset.index;
textElement.value =  `"${comments[index].name}:  ${comments[index].textElement}"\n`
    });
  };

};
quotation ();

//лайки
function likeCommentButton() {    

const likesButton = document.querySelectorAll('.like-button');

for (const like of likesButton) {
    like.addEventListener("click", (event) => {
    event.stopPropagation();
    const likeIndex = like.dataset.index;
    const commentsElement = comments[likeIndex];
            
    if (commentsElement.likeComment) {
      commentsElement.likesNumber -= 1;
      commentsElement.likeComment = false;
      commentsElement.propertyColorLike = 'like-button -no-active-like';           
    } else {
      commentsElement.likesNumber += 1;
      commentsElement.likeComment = true;
      commentsElement.propertyColorLike = 'like-button -active-like';                  
    }
    renderComments();  
     
  })
}

};
likeCommentButton();



//добавление новых комментариев
const renderComments = () => {
const commentsHTML = comments.map((comment, index) => {
  loaderComments ();
return     `<li class = 'comment' class = 'whiteSpace'   data-index ="${index}"> <div class = 'comment-header'>
      <div>${comment.name}</div> 
      <div>${comment.dateCreation}</div>
    </div>  

    <div class = 'comment-body'>
  <div class = "comment-text">
  ${comment.textElement}
  </div>
  </div>


  <div class = "comment-footer" >
    <div class = 'likes'>      
        <span class="likes-counter">${comment.likesNumber}</span>
    <button data-index = '${index}' class=" like-button ${comment.propertyColorLike}"></button>
            </div> 
</div>
      

            </li>`;}).join('');

commentsElement.innerHTML = commentsHTML;
addFormElement.classList.remove('hide');

likeCommentButton();
quotation();
};

renderComments();

//добавление новых комментариев по кнопке с сохранением в api
buttonElement.addEventListener ("click", () => {
  nameInputElement.style.background = '';
if (nameInputElement.value === "" ){
  nameInputElement.style.background = 'red';
  return;
 };
 textElement.style.background = '';
if (textElement.value === ""){
  textElement.style.background = 'red';
  return;
 };


 fetch("https://wedev-api.sky.pro/api/v1/tanya-bulaeva/comments",
{
method: "POST",
body: JSON.stringify({
name:   nameInputElement.value,
text: textElement.value,
date: commentDate,
likes: 0,
})
}).then((response) => {
addFormElement.classList.add('hide');
commentsElement.textContent = `Загрузка комментария`;
return response.json();
}).then((responseData) => {

return fetchFunction();
      });
nameInputElement.value = "";
textElement.value = ''; 

renderComments();
      });

renderComments();

quotation();




    console.log("It works!");
  </script>
</html>