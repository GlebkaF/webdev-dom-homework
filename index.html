<!DOCTYPE html>
<html>
  <head>
    <title>Проект "Комменты"</title>
    <meta charset="utf-8" />
    <link rel="stylesheet" href="styles.css" />
  </head>

  <body>
    <div class="container">
      <div class="loading">
        <p>Пожалуйста, подождите, загружаю комментарии...</p>
      </div>
      <ul class="comments">
        <!-- Убрали часть кода -->
      </ul>
      <div class="adding">
        <p>Комментарии добавляются...</p>
      </div>
      <div class="add-form">
        <input
          type="text"
          class="add-form-name"
          placeholder="Введите ваше имя"
        />
        <textarea
          type="textarea"
          class="add-form-text"
          placeholder="Введите ваш коментарий"
          rows="4"
        ></textarea>
        <div class="add-form-row">
          <button class="add-form-button">Написать</button>
        </div>
      </div>
      <div class="del-form">
        <button class="del-form-button">Удалить последний комментарий</button>
      </div>
    </div>
  </body>

  <style>
    .error {
      background-color: gray;
    }

    .comment-newline {
      white-space: pre-line;
    }

    .hide {
      display: none;
    }

    @keyframes rotating {
      from {
        transform: rotate(0deg);
      }

      25% {
        transform: rotate(30deg);
      }

      75% {
        transform: rotate(-30deg);
      }

      to {
        transform: rotate(0deg);
      }
    }

    .-loading-like {
      animation: rotating 2s linear infinite;
    }
  </style>

  <script>
    "use strict";

    // Код писать здесь

    const listElement = document.querySelector(".comments");
    const addButtonElement = document.querySelector(".add-form-button");
    const deleteButtonElement = document.querySelector(".del-form-button");
    const nameInputElement = document.querySelector(".add-form-name");
    const commentInputElement = document.querySelector(".add-form-text");
    const selfIdElement = document.querySelector(".self-id");
    const commentsLoading = document.querySelector(".loading");
    const commentsAdding = document.querySelector(".adding");
    const addForm = document.querySelector(".add-form");

    commentsLoading.classList.remove("hide");
    commentsAdding.classList.add("hide");
    addForm.classList.remove("hide");
    deleteButtonElement.classList.remove("hide");

    let userComments = [];

    function fetchPromiseArr() {
      fetch("https://wedev-api.sky.pro/api/v1/OlegGorin/comments", {
        method: "GET",
      })
        .then((response) => {
          // console.log("respobse" ,response);
          if (response.status === 201 || response.status === 200) {
            return response.json();
          } else if (response.status === 500) {
            return Promise.reject(new Error("Сервер недоступен"));
          }
          // return response.json();
        })
        .then((responseData) => {
          const appComments = responseData.comments.map((comment) => {
            return {
              name: comment.author.name,
              date:
                new Date(comment.date).toLocaleDateString("default", {
                  day: "2-digit",
                  month: "2-digit",
                  year: "2-digit",
                }) +
                " " +
                new Date(comment.date).toLocaleTimeString([], {
                  hour: "2-digit",
                  minute: "2-digit",
                }),
              text: comment.text,
              likesCounter: comment.likes,
              likeButton: false,
            };
          });

          commentsLoading.classList.add("hide"); // скрываем надпись о загрузке комментариев с сервера
          commentsAdding.classList.add("hide"); // скрываем надпись о добавлении записей на сервер
          addForm.classList.remove("hide"); // активируем форму добавления комментариев
          deleteButtonElement.classList.remove("hide"); // активируем кнопку "Удалить последний комментарий"

          userComments = appComments;

          renderComments();
          prepareInput();
        })
        .catch((error) => {
          if (error.message === "Сервер недоступен") {
            alert("Сервер недоступен, попробуйте позже");
            fetchPromiseArr();
          } else if (error.message === "Failed to fetch") {
            alert("Неполадки интернета");
            addButtonElement.disabled = true; // деактивируем кнопку "Написать"
            addButtonElement.classList.add("error"); // меняем ее цвет
            commentsAdding.classList.add("hide"); // скрываем надпись о добавлении записей на сервер
            addForm.classList.remove("hide"); // активируем форму добавления комментариев
          } else {
            console.log(error);
          }
          console.warn(error);
        });
    }

    fetchPromiseArr();

    const changeLikeButton = () => {
      const likeButtonElements = document.querySelectorAll(".like-button");

      for (const likeButtonElement of likeButtonElements) {
        likeButtonElement.addEventListener("click", (event) => {
          likeButtonElement.classList.add("-loading-like");
          const index = likeButtonElement.dataset.index;
          event.stopPropagation();

          console.log(likeButtonElement.dataset);

          delay(2000).then(() => {
            userComments[index].likesCounter = userComments[index].likeButton
              ? userComments[index].likesCounter - 1
              : userComments[index].likesCounter + 1;
            userComments[index].likeButton = !userComments[index].likeButton;
            userComments[index].isLikeLoading = false;
            renderComments();
            prepareInput();
          });
        });
      }
    };

    changeLikeButton();
    clearInput();

    // Функция для имитации запросов в API
    // Не смотрите особо на внутренности, мы разберемся с этим позже
    function delay(interval = 300) {
      return new Promise((resolve) => {
        setTimeout(() => {
          resolve();
        }, interval);
      });
    }

    addButtonElement.disabled = true;
    addButtonElement.classList.add("error");

    nameInputElement.addEventListener("input", (event) => {
      addButtonElement.disabled = false;
      addButtonElement.classList.remove("error");
    });

    commentInputElement.addEventListener("input", (event) => {
      addButtonElement.disabled = false;
      addButtonElement.classList.remove("error");
    });

    document.addEventListener("keypress", (event) => {
      if (event.key === "Enter") {
        addListComment();
      }
    });

    deleteButtonElement.addEventListener("click", (event) => {
      userComments.splice(userComments.length - 1, 1);
      renderComments();
      prepareInput();
      clearInput();
      event.stopPropagation();
    });

    // deleteButtonElement.addEventListener("click", (event) => {
    //   event.stopPropagation();

    //   const id = deleteButtonElement.dataset.id;

    //   fetch("https://wedev-api.sky.pro/api/v1/OlegGorin/comments" + id, {
    //     method: "DELETE",
    //   }).then((response) => {
    //     response.json().then((responseData) => {
    //       console.log(responseData.comments);
    //       // { result: 'ok' }
    //       // comments = responseData.comments;
    //       renderComments();
    //     });
    //   });
    //   renderComments();
    // });

    const initEventListeners = () => {
      const commentElements = document.querySelectorAll(".comment");
      for (const commentElement of commentElements) {
        commentElement.addEventListener("click", (event) => {
          const index = commentElement.dataset.index;
          event.stopPropagation();

          let QUOTE_BEGIN = "QUOTE_BEGIN";
          let QUOTE_END = "QUOTE_END";
          commentInputElement.value = `> ${QUOTE_BEGIN} ${userComments[index].text} \n\n${userComments[index].name}, ${QUOTE_END}`;
        });
      }
    };

    initEventListeners();

    addButtonElement.addEventListener("click", handlePostClick);

    function handlePostClick() {
      if (
        nameInputElement.value.trim() === "" ||
        commentInputElement.value.trim() === ""
      ) {
        addButtonElement.disabled = true;
        addButtonElement.classList.add("error");
        return;
      }

      fetch("https://wedev-api.sky.pro/api/v1/OlegGorin/comments", {
        method: "POST",
        body: JSON.stringify({
          name: nameInputElement.value
            .replaceAll("&", "&amp;")
            .replaceAll("<", "&lt;")
            .replaceAll(">", "&gt;")
            .replaceAll('"', "&quot;"),
          text: commentInputElement.value
            .replaceAll("&", "&amp;")
            .replaceAll("<", "&lt;")
            .replaceAll(">", "&gt;")
            .replaceAll('"', "&quot;")
            .replaceAll("QUOTE_BEGIN", "<div class='quote'>")
            .replaceAll("QUOTE_END", "</div>"),
          forceError: true,
        }),
      })
        .then((response) => {
          if (response.status === 201 || response.status === 200) {
            // return response.json();
            fetchPromiseArr();
          } else if (response.status === 400) {
            return Promise.reject(new Error("Неправильный запрос"));
          } else {
            return Promise.reject(new Error("Сервер недоступен"));
          }
        })
        // .then(() => {
        //   return fetchPromiseArr();
        // })
        .then(() => {
          clearInput();
        })
        .catch((error) => {
          if (error.message === "Сервер недоступен") {
            alert("Сервер недоступен, попробуйте позже");
            addButtonElement.disabled = false;
            addButtonElement.classList.remove("error");
            commentsAdding.classList.add("hide");
            addForm.classList.remove("hide");
            deleteButtonElement.classList.remove("hide");
            renderComments();
          } else if (error.message === "Неправильный запрос") {
            alert(
              "Поля 'Имя' и 'Комментарий' должны содержать хотя бы 3 символа"
            );
            commentsAdding.classList.add("hide");
            addForm.classList.remove("hide");
            deleteButtonElement.classList.remove("hide");
            renderComments();
            prepareInput();
          } else if (error.message === "Failed to fetch") {
            alert("Неполадки интернета");
            addButtonElement.disabled = false;
            addButtonElement.classList.remove("error");
            commentsAdding.classList.add("hide");
            addForm.classList.remove("hide");
          } else {
            console.log(error);
          }
        //});
      })
        .then((response) => {
          if (response.status === 500) throw new Error("Сервер недоступен");
          if (response.status === 201 || response.status === 200) {
            fetchPromiseArr();
            // return response.json();
          }
          if (response.status === 400) throw new Error("Неправильный запрос");
        })
        // .then(() => {
        //   return fetchPromiseArr();
        // })
        .then(() => {
          clearInput();
        })
        .catch((error) => {
          if (error.message === "Сервер недоступен") {
            alert("Сервер недоступен, попробуйте позже");
            handlePostClick();
            addButtonElement.disabled = false;
            addButtonElement.classList.remove("error");
            commentsAdding.classList.add("hide");
            addForm.classList.remove("hide");
            deleteButtonElement.classList.remove("hide");
            renderComments();
          } else if (error.message === "Неправильный запрос") {
            alert(
              "Поля 'Имя' и 'Комментарий' должны содержать хотя бы 3 символа"
            );
            commentsAdding.classList.add("hide");
            addForm.classList.remove("hide");
            deleteButtonElement.classList.remove("hide");
            renderComments();
            prepareInput();
          } else if (error.message === "Failed to fetch") {
            alert("Неполадки интернета");
            addButtonElement.disabled = false;
            addButtonElement.classList.remove("error");
            commentsAdding.classList.add("hide");
            addForm.classList.remove("hide");
          } else {
            console.log(error);
          }
        });

      commentsAdding.classList.remove("hide");
      addForm.classList.add("hide");
      deleteButtonElement.classList.add("hide");

      renderComments();
      // clearInput();
    }

    const renderComments = () => {
      const commentHTML = userComments
        .map((comment, index) => {
          let lkBtn = "";
          if (userComments[index].likeButton === true) {
            lkBtn = "like-button -active-like";
            // lkBtn = "like-button -loading-like";
          } else {
            lkBtn = "like-button";
          }
          return `<li data-index="${index}" class="comment">
            <div class="comment-header">
              <div>${userComments[index].name}</div>
              <div>${userComments[index].date}</div>
            </div>
            <div class="comment-body">
              <div data-index="${index}" class="comment-text comment-newline">
                ${userComments[index].text}
              </div >
            </div >
            <div class="comment-footer">
              <div class="likes">
                <span class="likes-counter">${userComments[index].likesCounter}</span>
                <button data-index=${index} class="${lkBtn}"></button>
              </div>
            </div>
          </li >`;
        })
        .join("");

      listElement.innerHTML = commentHTML;

      initEventListeners();
      changeLikeButton();
    };

    renderComments();
    prepareInput();

    function clearInput() {
      nameInputElement.value = "";
      commentInputElement.value = "";
    }

    function prepareInput() {
      addButtonElement.disabled = true;
      addButtonElement.classList.add("error");
    }

    console.log("It works!");
  </script>
</html>
