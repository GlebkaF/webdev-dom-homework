<!DOCTYPE html>
<html>

<head>
  <title>Проект "Комменты"</title>
  <meta charset="utf-8" />
  <link rel="stylesheet" href="styles.css" />
  <style>
    .error {
      background-color: red;
    }

    .disabled {
      background-color: gray;
      pointer-events: none;
    }

    .like-button.active {
      background-color: rgba(255, 0, 0, 0.566);
    }
  </style>
</head>

<body>
  <div class="container">
    <ul class="comments" id="comments-list">
    </ul>
    <div class="add-form">
      <input type="text" class="add-form-name" id="name-input" placeholder="Введите ваше имя" />
      <textarea type="textarea" class="add-form-text" id="comment-input" placeholder="Введите ваш комментарий"
        rows="4"></textarea>
      <div class="add-form-row">
        <button class="add-form-button" id="add-comment-button">Написать</button>
        <button class="deleteCommentButton" id="deleteCommentButton">Удалить последний комментарий</button>
      </div>
    </div>
  </div>

  <script>
    let addCommentButton = document.getElementById("add-comment-button");
    let nameInput = document.getElementById("name-input");
    let commentInput = document.getElementById("comment-input");
    let commentsList = document.getElementById("comments-list");
    let deleteCommentButton = document.getElementById("deleteCommentButton");

    function sanitizeInput(input) {
      return input.replaceAll("<", "&lt;").replaceAll(">", "&gt;");
    }

    function displayComments(comments) {
      const commentsList = document.getElementById("comments-list");
      commentsList.innerHTML = "";

      comments.forEach((comment) => {
        const { author, date, text, likes } = comment;
        const formattedDate = new Date(date).toLocaleString();

        const commentHtml = `
          <li class="comment">
            <div class="comment-header">
              <div>${author.name}</div>
              <div>${formattedDate}</div>
            </div>
            <div class="comment-body">
              <div class="comment-text">${text}</div>
            </div>
            <div class="comment-footer">
              <div class="likes">
                <span class="likes-counter">${likes}</span>
                <button class="like-button"></button>
              </div>
            </div>
          </li>
        `;

        commentsList.innerHTML += commentHtml;
      });
    }

    function addComment() {
  const name = sanitizeInput(nameInput.value.trim());
  const comment = sanitizeInput(commentInput.value.trim());

  if (name === "" || comment === "") {
    if (name === "") {
      nameInput.classList.add("error");
      addCommentButton.classList.add("disabled");
    }
    if (comment === "") {
      commentInput.classList.add("error");
      addCommentButton.classList.add("disabled");
    } else {
      addCommentButton.classList.remove("disabled");
    }
    return;
  }
  nameInput.classList.remove("error");
  commentInput.classList.remove("error");

  const currentDate = new Date();
  const formattedDate = `${currentDate.getDate()}.${currentDate.getMonth() + 1}.${currentDate.getFullYear()} ${currentDate.getHours()}:${currentDate.getMinutes()}`;

  const newComment = {
    name: name, 
    author: { name: name },
    text: comment,
    date: formattedDate,
    likes: 0,
    isLiked: false,
  };

  fetch("https://wedev-api.sky.pro/api/v1/atamyrat-isayev/comments", {
    method: "POST",
    body: JSON.stringify(newComment),
  })
    .then((response) => response.json())
    .then((responseData) => {
      console.log("New comment added:", responseData);

      fetchComments();
    })
    .catch((error) => {
      console.error("Error adding new comment:", error);
    });
}   

    addCommentButton.addEventListener("click", addComment);

    deleteCommentButton.addEventListener("click", () => {
      const lastComment = commentsList.lastElementChild;
      if (lastComment) {
        commentsList.removeChild(lastComment);
      }

      fetch("https://wedev-api.sky.pro/api/v1/atamyrat-isayev/comments", {
        method: "DELETE",
      })
        .then(() => {
          console.log("Last comment deleted.");

          fetchComments();
        })
        .catch((error) => {
          console.error("Error deleting last comment:", error);
        });
    });

    function fetchComments() {
      fetch("https://wedev-api.sky.pro/api/v1/atamyrat-isayev/comments")
        .then((response) => response.json())
        .then((comments) => {
          displayComments(comments.comments);
        })
        .catch((error) => {
          console.error("Error fetching comments:", error);
        });
    }

    fetchComments();
  </script>
</body>

</html>
