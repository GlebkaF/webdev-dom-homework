<!DOCTYPE html>
<html lang="en">
  <head>
    <title>–ü—Ä–æ–µ–∫—Ç "–ö–æ–º–º–µ–Ω—Ç—ã"</title>
    <meta charset="utf-8" />
    <link rel="stylesheet" href="styles.css" />
  </head>
  <body>
    <div class="container">
      <ul class="comments" id="list">
        <!-- –°–ø–∏—Å–æ–∫ —Ä–µ–Ω–¥–µ—Ä–∏—Ç—Å—è –∏–∑ JS -->
      </ul>
      <div class="add-form">
        <input
          id="name-input"
          type="text"
          class="add-form-name"
          placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–∞—à–µ –∏–º—è"
        />
        <textarea
          id="comment-input"
          class="add-form-text"
          placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–∞—à –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π"
          rows="4"
        ></textarea>
        <div class="add-form-row">
          <button id="add-button" class="add-form-button" disabled>üñäÔ∏è –ù–∞–ø–∏—Å–∞—Ç—å</button>
          <button id="delete-button" class="add-form-button delete-form-button">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å –ø–æ—Å–ª–µ–¥–Ω–∏–π –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</button>
        </div>
      </div>
    </div>
    <script>
      "use strict";
      const deleteButtonElement = document.getElementById("delete-button");
      const buttonElement = document.getElementById("add-button");
      const listElement = document.getElementById("list");
      const nameInputElement = document.getElementById("name-input");
      const commentInputElement = document.getElementById("comment-input");
      const currentDate = new Date().toLocaleDateString('default', {day: '2-digit', month: '2-digit', year: '2-digit'}) +
" "+ new Date().toLocaleTimeString().slice(0,-3);

const getCurrentDate = (date) => {
  return date.getDate().toString().padStart(2, '0') + '.' +
    (date.getMonth() + 1).toString().padStart(2, '0') + '.' +
    date.getFullYear().toString().slice(-2) + " " +
    date.toLocaleTimeString().slice(0, -3);
}

let comments = [];

function fetchData() {
  const postData = fetch("https://wedev-api.sky.pro/api/v1/diana-semenova/comments", {
    method: "GET",
  });
  postData.then((response) => {

    response.json().then((responseJson) => {
      const appComments = responseJson.comments.map((comment) => {
        return {
          name: comment.author.name,
          dateOfCreation: getCurrentDate(new Date(comment.date)),
          text: comment.text,
          likeComment: comment.isLiked,
          likesNumber: comment.likes,
          propertyColorLike: 'like-button no-active-like',
        }
      });
      comments = appComments;
      renderComments();
    });

  });
}

fetchData();

function getLikes() {
  const likesButton = document.querySelectorAll(".like-button");
  for (const like of likesButton) {
    like.addEventListener("click", (event) => {
      event.stopPropagation();
      const likeIndex = like.dataset.index;
      const commentsElementLikeIndex = comments[likeIndex];
      if (commentsElementLikeIndex.likeComment) {
        commentsElementLikeIndex.likesNumber -= 1;
        commentsElementLikeIndex.likeComment = false;
        commentsElementLikeIndex.propertyLikeImage =
          "like-button -no-active-like";
      } else {
        commentsElementLikeIndex.likesNumber += 1;
        commentsElementLikeIndex.likeComment = true;
        commentsElementLikeIndex.propertyLikeImage =
          "like-button -active-like";
      }
      renderComments();
    });
  }
}

function replyToComment() {
  let commentElements = document.querySelectorAll(".comment");
  for (const commentElement of commentElements) {
    commentElement.addEventListener("click", () => {
      const indexComment = commentElement.dataset.index;
      commentInputElement.value = `>${comments[indexComment].name}:\n${comments[indexComment].text.replaceAll("QUOTE_BEGIN", "<div class='comment-quote'><b>").replaceAll("QUOTE_END", "</b></div>")}\n\n`;
    });
  }
}

const renderComments = () => {
  const commentsHtml = comments
    .map((comment, index) => {
      return `<li class="comment" data-index="${index}">
              <div class="comment-header" data-index="${index}">
                <div>${comment.name
                  .replaceAll("&", "&amp;")
                  .replaceAll("<", "&lt;")
                  .replaceAll(">", "&gt;")
                  .replaceAll('"', "&quot;")}</div>
                <div>${comment.dateOfCreation}</div>
              </div>
              <div class="comment-body">
                <div data-index="${index}" class="comment-text">
                  ${comment.text
                    .replaceAll("&", "&amp;")
                    .replaceAll("<", "&lt;")
                    .replaceAll(">", "&gt;")
                    .replaceAll('"', "&quot;")
                    .replaceAll("QUOTE_BEGIN", "<div class='comment-quote'><b>")
                    .replaceAll("QUOTE_END", "</b></div>")}
                </div>
              </div>
              <div class="comment-footer">
                <div class="likes">
                  <span class="likes-counter">${comment.likesNumber}</span>
                  <button data-index="${index}" class="like-button ${comment.propertyLikeImage}" alt="Like"></button>
                </div>
              </div>
            </li>`;
    })
    .join("");
  listElement.innerHTML = commentsHtml;
  getLikes();
  replyToComment();
  nameInputElement.value = "";
  commentInputElement.value = "";
  buttonElement.disabled = true;
  if (nameInputElement.value.length > 0 && commentInputElement.value.length > 0) {
    buttonElement.disabled = false;
  }
};

renderComments();

nameInputElement.addEventListener("input", () => {
  buttonElement.disabled = true;
  if (nameInputElement.value.length > 0 && commentInputElement.value.length > 0) {
    buttonElement.disabled = false;
  }
});

commentInputElement.addEventListener("input", () => {
  buttonElement.disabled = true;
  if (nameInputElement.value.length > 0 && commentInputElement.value.length > 0) {
    buttonElement.disabled = false;
  }
});

buttonElement.addEventListener("click", () => {
  const postData = fetch("https://wedev-api.sky.pro/api/v1/diana-semenova/comments", {
    method: "POST",
    body: JSON.stringify({
      name: nameInputElement.value
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;"),
      date: getCurrentDate(new Date()),
      text: commentInputElement.value
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll('QUOTE_BEGIN', "<div class='comment-quote'><b>")
        .replaceAll('QUOTE_END', "</b></div>"),
      isLiked: false,
      likes: 0,
      propertyColorLike: 'like-button no-active-like',
    })
  });

  postData.then((response) => {
    response.json().then((responseData) => {
      fetchData();
    });
  });
});

document.addEventListener("keyup", function (enter) {
  if (enter.keyCode == 13) {
    buttonElement.click();
  }
});

deleteButtonElement.addEventListener("click", () => {
  comments.pop();
  renderComments();
});
    </script>
  </body>
</html>