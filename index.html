<!DOCTYPE html>
<html>
  <head>
    <title>Проект "Комменты"</title>
    <meta charset="utf-8" />
    <link rel="stylesheet" href="styles.css" />
  </head>

  <body>
    <div class="container">
      <div class="loader" id="com-loader" hidden>
        Пожалуйста подождите, комментарии загружаются...
      </div>
      <ul id="list" class="comments">
        <!-- Список рендерится JS -->
      </ul>
      <div class="loader" id="form-loader" hidden>
        Комментарий добавляется...
      </div>
      <div id="add-form" class="add-form">
        <input
          id="add-form-name"
          type="text"
          class="add-form-name"
          placeholder="Введите ваше имя"
        />
        <textarea
          id="add-form-text"
          type="textarea"
          class="add-form-text"
          placeholder="Введите ваш коментарий"
          rows="4"
        ></textarea>
        <div class="add-form-row">
          <button id="add-form-button" class="add-form-button">Написать</button>
        </div>
      </div>
    </div>
  </body>
  <script>
    "use strict";

    let isLoading = false;

    const nameEl = document.getElementById("add-form-name");
    const textEl = document.getElementById("add-form-text");
    const buttonEl = document.getElementById("add-form-button");
    const listEl = document.getElementById("list");
    const formEl = document.getElementById("add-form");
    const comLoader = document.getElementById("com-loader");
    const formLoader = document.getElementById("form-loader");

    function formatDate(date) {
      const options1 = {
        year: "2-digit",
        month: "2-digit",
        day: "2-digit",
      };
      const options2 = {
        hour: "numeric",
        minute: "numeric",
      };

      return (
        date.toLocaleString("ru", options1) +
        " " +
        date.toLocaleString("ru", options2)
      );
    }

    let comments = [];

    function delay(interval = 300) {
      return new Promise((resolve) => {
        setTimeout(() => {
          resolve();
        }, interval);
      });
    }

    const initLikeButtonListener = () => {
      const likeButtonElements = document.querySelectorAll(".like-button");
      likeButtonElements.forEach((el, index) => {
        el.addEventListener("click", () => {
          el.classList.add("-loading-like");
          delay(2000)
            .then(() => {
              comments[index].like_active = !comments[index].like_active;
              comments[index].like_active
                ? comments[index].like_count++
                : comments[index].like_count--;
              renderComments();
            })
            .then(() => {
              el.classList.remove("-loading-like");
            });
        });
      });
    };

    const initReplayListener = () => {
      const replayComments = document.querySelectorAll(".comment-text");
      for (const replayComment of replayComments) {
        replayComment.addEventListener("click", (event) => {
          event.stopPropagation();
          const index = replayComment.dataset.index;
          textEl.value = `QUOTE_BEGIN ${comments[index].name} \n ${comments[index].text} QUOTE_END`;
          renderComments();
        });
      }
    };

    const renderComments = () => {
      const commentsHtml = comments
        .map((comment, index) => {
          let editComment = () => {
            if (comment.isEdit) {
              return `<textarea data-index="${index}" id="add-form-edit-text" type="textarea" class="add-form-edit-text" placeholder=""
    rows="4" > ${sanitize(comment.text)}</textarea>`;
            } else {
              return `${sanitize(comment.text)} `;
            }
          };
          return `<li class="comment">
          <div class="comment-header">
            <div>${sanitize(comment.name)}</div>
            <div id="add-form-date">${comment.date}</div>
          </div>
          <div class="comment-body">
            <div data-index="${index}" class="comment-text" style="white-space:pre-line">
              <a class="replay-form-link" ${
                comment.isEdit ? "" : 'href="#add-form"'
              }> ${editComment()}</a>
            </div>
          </div>
          <div class="comment-footer">
            <div class="likes">
              <span data-index="${index}" class="likes-counter">${
            comment.like_count
          }</span>
              <button data-index="${index}" class="like-button ${
            comment.like_active ? "-active-like" : ""
          }"></button>
            </div>
          </div >
        </li>`;
        })
        .join("");

      listEl.innerHTML = commentsHtml;

      initLikeButtonListener();
      initReplayListener();
    };

    function sanitize(text) {
      return text
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("QUOTE_BEGIN", "<div class='quote'>")
        .replaceAll("QUOTE_END", "</div>");
    }

    buttonEl.disabled = true;
    nameEl.addEventListener("input", evnt);
    textEl.addEventListener("input", evnt);
    function evnt(event) {
      if (event.target.value !== "") buttonEl.disabled = false;
    }

    formEl.addEventListener("keyup", (e) => {
      if (!e.shiftKey && e.code === "Enter") {
        buttonEl.click();
      }
    });

    buttonEl.addEventListener("click", () => {
      nameEl.value = nameEl.value.trim();
      textEl.value = textEl.value.trim();

      nameEl.classList.remove("add-form_error");
      textEl.classList.remove("add-form_error");

      if (nameEl.value === "" && textEl.value === "") {
        nameEl.classList.add("add-form_error");
        textEl.classList.add("add-form_error");
        return;
      } else if (nameEl.value === "") {
        nameEl.classList.add("add-form_error");
        return;
      } else if (textEl.value === "") {
        textEl.classList.add("add-form_error");
        return;
      }

      function fetchPost() {
        formEl.classList.add("add-form_displayNone");
        formLoader.hidden = false;
        isLoading = true;
        fetch("https://wedev-api.sky.pro/api/v1/:vich/comments", {
          method: "POST",
          body: JSON.stringify({
            name: nameEl.value,
            text: textEl.value,
            forceError: true,
          }),
        })
          .then((response) => {
            if (response.status === 400) {
              throw new Error("Неправильный запрос");
            }
            if (response.status === 500) {
              throw new Error("Сервер сломался");
            }
            return response;
          })
          .then((response) => {
            return response.json();
          })
          .then(() => {
            return fetchGet();
          })
          .then(() => {
            buttonEl.disabled = true;
            nameEl.value = "";
            textEl.value = "";
            formEl.classList.remove("add-form_displayNone");
            formLoader.hidden = true;
          })
          .catch((error) => {
            formEl.classList.remove("add-form_displayNone");
            formLoader.hidden = true;

            if (error.message === "Неправильный запрос") {
              alert("Длина имени и комментария должна быть более 3 символов");
              console.warn(error);
              return;
            }
            if (error.message === "Сервер сломался") {
              console.warn(error);
              console.log("Повторная отправка");
              fetchPost();
              return;
            }
            if (error.message === "Failed to fetch") {
              console.warn(error);
              alert(
                "Сбой подключения! Пожалуйста, проверьте подключение и повторите отправку."
              );
              comLoader.textContent =
                "Комментарии не загружены. Пожалуйста, проверьте подключение и повторите отправку.";
              return;
            }
          });
        renderComments();
      }
      fetchPost();
    });

    const fetchGet = () => {
      isLoading ? (comLoader.hidden = true) : (comLoader.hidden = false);

      return fetch("https://wedev-api.sky.pro/api/v1/:vich/comments", {
        method: "GET",
      })
        .then((response) => {
          if (response.status === 500) {
            throw new Error("Сервер сломался");
          }
          return response;
        })
        .then((response) => {
          return response.json();
        })
        .then((responseData) => {
          const appComments = responseData.comments.map((comment) => {
            return {
              name: comment.author.name,
              text: comment.text,
              like_active: comment.isLiked,
              like_count: comment.likes,
              date: formatDate(new Date(comment.date)),
              //forceError: true,
            };
          });
          comLoader.hidden = true;
          comments = appComments;
          renderComments();
        })
        .catch((error) => {
          if (error.message === "Failed to fetch") {
            console.warn(error);
            alert(
              "Сбой подключения! Пожалуйста, проверьте подключение и обновите страницу."
            );
            comLoader.textContent =
              "Комментарии не загружены. Пожалуйста, проверьте подключение и обновите страницу.";
            return;
          }
          if (error.message === "Сервер сломался") {
            console.warn(error);
            console.log("Повторная загрузка");
            fetchGet();
            return;
          }
        });
    };

    fetchGet();
    renderComments();
  </script>
</html>
