<!DOCTYPE html>
<html>
<head>
    <title>Проект "Комменты"</title>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="styles.css"/>
</head>

<body>
<div class="container">
     <ul id="list" class="comments">
        <!-- <li class="comment">
            <div class="comment-header">
                <div>Глеб Фокин</div>
                <div id="comment-date-1">12.02.22 12:18</div>
            </div>
            <div class="comment-body">
                <div class="comment-text">
                    Это будет первый комментарий на этой странице
                </div>
            </div>
            <div class="comment-footer">
                <div class="likes">
                    <span class="likes-counter">3</span>
                    <button class="like-button"></button>
                </div>
            </div>

        </li>
       
          

        <li class="comment">
            <div class="comment-header">
                <div>Варвара Н.</div>
                <div>13.02.22 19:22</div>
            </div>
            <div class="comment-body">
                <div class="comment-text">
                    Мне нравится как оформлена эта страница! ❤️
                </div>
            </div>
            <div class="comment-footer">
                <div class="likes">
                    <span class="likes-counter">75</span>
                    <button class="like-button"></button>
                </div>
            </div>
            
        </li> -->
    </ul>
    <div class="add-form">
        <input
                type="text" id="name-input"
                class="add-form-name"
                placeholder="Введите ваше имя"
        />
        <textarea
                id="comm-input"
                class="add-form-text"
                placeholder="Введите ваш коментарий"
                rows="4"
        ></textarea>
        <div class="add-form-row">
            <button id="publish-button" class="add-form-button">Написать</button>
        </div>
    </div>
</div>
</body>

<script>
    const nameInputElement = document.getElementById("name-input");
    const commInputElement = document.getElementById("comm-input");
    const buttonElement = document.getElementById("publish-button");
    const listElement = document.getElementById("list");
 
    function formatDate(date) {
        const day = String(date.getDate()).padStart(2, '0');
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const year = String(date.getFullYear()).slice(-2);
        const hours = String(date.getHours()).padStart(2, '0');
        const minutes = String(date.getMinutes()).padStart(2, '0');
        return `${day}.${month}.${year} ${hours}:${minutes}`;
    };

    function attachLikeHandler(button, counter) {
        let liked = false;
        button.addEventListener('click', () => {
            if (liked) {
                liked = false;
                button.classList.remove('-active-like');
                counter.textContent = parseInt(counter.textContent) - 1;

            } else {
                liked = true;
                button.classList.add('-active-like');
                counter.textContent = parseInt(counter.textContent) + 1;

            }
        });
    }

    
    function attachCommentClickHandler(comment) {
    comment.addEventListener('click', () => {
        
        const name = comment.querySelector('.comment-header div:first-child').textContent;
        const text = comment.querySelector('.comment-text').textContent;

        
        commInputElement.value = `${name}: ${text}`;
        
    });
}


// document.querySelectorAll('.comment').forEach(attachCommentClickHandler);



buttonElement.addEventListener("click", () => {
    commInputElement.style.backgroundColor = "";
    nameInputElement.style.backgroundColor = "";
    if (commInputElement.value === "" || nameInputElement.value === "") {
        commInputElement.style.backgroundColor = "red";
        nameInputElement.style.backgroundColor = "red";
       
        return;
    }

    //добавлять коммент в хранилище данных
//     const newComment = createComment(nameInputElement.value
//     .replaceAll("<", "&lt;") 
//     .replaceAll(">", "&gt;"), 
//     commInputElement.value 
//     .replaceAll("<", "&lt;") 
//     .replaceAll(">", "&gt;"));
//     listElement.appendChild(newComment);
//     attachCommentClickHandler(newComment);
//     commInputElement.value = "";
//     nameInputElement.value = "";
// });

const newComment = createComment(
            nameInputElement.value.replaceAll("<", "&lt;").replaceAll(">", "&gt;"),
            commInputElement.value.replaceAll("<", "&lt;").replaceAll(">", "&gt;")
        );
        listElement.appendChild(newComment);
        attachCommentClickHandler(newComment);
        commInputElement.value = "";
        nameInputElement.value = "";
    });


    function createComment(name, text) {
        const comment = document.createElement('li');
        comment.className = 'comment';

        const header = document.createElement('div');
        header.className = 'comment-header';
        header.innerHTML = `<div>${name}</div><div>${formatDate(new Date())}</div>`;

        const body = document.createElement('div');
        body.className = 'comment-body';
        body.innerHTML = `<div class="comment-text">${text}</div>`;

        const footer = document.createElement('div');
        footer.className = 'comment-footer';
        footer.innerHTML = `
        <div class="likes">
            <span class="likes-counter">0</span>
            <button class="like-button"></button>
        </div>`;

        comment.appendChild(header);
        comment.appendChild(body);
        comment.appendChild(footer);

      
        const likeButton = footer.querySelector('.like-button');
        const likeCount = footer.querySelector('.likes-counter');
        attachLikeHandler(likeButton, likeCount);

        return comment;
    }



    function renderComments(commentData) {
        listElement.innerHTML = "";
        commentData.forEach((comment) => {
            const commentElement = createComment(comment.name, comment.text);
            listElement.appendChild(commentElement);
        });
    }

    let commentsData = [];
    renderComments(commentsData);

    const likeButtons = document.querySelectorAll(".like-button");
    const likeCounts = document.querySelectorAll(".likes-counter");
    likeButtons.forEach((button, index) => {
        attachLikeHandler(button, likeCounts[index]);
    });


// const getComments = () => {
//     let fetchPromise = fetch("https://wedev-api.sky.pro/api/v1/yana-orlova/comments", {
//         method: "GET",
//     });
//     fetchPromise.then((response) => {
//             if (!response.ok) {
//                 throw new Error("Network response was not ok");
//             }
//             return response.json();
//         }).then((responseData) => {
//             let appComments = responseData.comments.map((comment) => {
//                 return {
//                     name: comment.author.name,
//                     text: comment.text,
//                     date: comment.date,
//                     likes: comment.likes,
//                 }
//             });

//             commentsData = appComments;
//             renderComments(commentsData);
//         }).catch((error) => {
//             console.error("Fetch error:", error);
//         });
//     }

//     getComments();
//     fetchPromise.then((response) => {
//         response.json().then((responseData) => {
//             let appComments = responseData.comments.map((comment) => {
//                 return {
//                     name: comment.author.name,
//                     comment: comment.text,
//                     date: comment.date,
//                     likes: comment.likes,
//                 }
//             });

// commentsData = appComments;

function sendCommentToServer(comment) {
        const postData = {
            name: comment.querySelector('.comment-header div:first-child').textContent,
            text: comment.querySelector('.comment-text').textContent,
            date: formatDate(new Date()),
        };

        fetch("https://wedev-api.sky.pro/api/v1/yana-orlova/comments", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
            },
            body: JSON.stringify(postData),
        }).then((response) => {
            if (!response.ok) {
                throw new Error("Network response was not ok");
            }
            return response.json();
        }).then((responseData) => {
            // Обработка успешной отправки комментария (если нужно)
            console.log("Comment sent successfully:", responseData);
        }).catch((error) => {
            console.error("Fetch error:", error);
        });
    }

    function getCommentsFromServer() {
    fetch("https://wedev-api.sky.pro/api/v1/yana-orlova/comments", {
        method: "GET",
    })
    .then((response) => {
        if (!response.ok) {
            throw new Error("Network response was not ok");
        }
        return response.json();
    })
    .then((responseData) => {
        let appComments = responseData.comments.map((comment) => {
            return {
                name: comment.author.name,
                text: comment.text,
                date: comment.date,
                likes: comment.likes,
            };
        });

        commentsData = appComments;
        renderComments(commentsData);
    })
    .catch((error) => {
        console.error("Fetch error:", error);
    });
}

// Вызываем getCommentsFromServer для загрузки комментариев при загрузке страницы
getCommentsFromServer();

// Функция для добавления нового комментария и отправки его на сервер
function addCommentAndSendToServer(name, text) {
    const newComment = createComment(name, text);
    listElement.appendChild(newComment);

    // Отправляем комментарий на сервер
    sendCommentToServer(newComment);
}

// Обновляем обработчик кнопки "Написать" для добавления и отправки нового комментария
buttonElement.addEventListener("click", () => {
    commInputElement.style.backgroundColor = "";
    nameInputElement.style.backgroundColor = "";
    if (commInputElement.value === "" || nameInputElement.value === "") {
        commInputElement.style.backgroundColor = "red";
        nameInputElement.style.backgroundColor = "red";
        return;
    }

    addCommentAndSendToServer(nameInputElement.value, commInputElement.value);

    // Очищаем поля ввода
    commInputElement.value = "";
    nameInputElement.value = "";
});
    

    console.log("It works!");

</script>
</html>
