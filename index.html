<!DOCTYPE html>
<html>

<head>
  <title>Проект "Комменты"</title>
  <meta charset="utf-8" />
  <link rel="stylesheet" href="styles.css" />
</head>

<body>
  <div class="container">
    <ul class="comments" id="list">
      <!-- Список рендерится из Js -->
    </ul>
    <div class="add-form">
      <input
        type="text"
        class="add-form-name"
        placeholder="Введите ваше имя"
        id="name-input"
      />
      <textarea
        type="textarea"
        class="add-form-text"
        placeholder="Введите ваш коментарий"
        rows="4"
        id="comment-input"
      ></textarea>
      <div class="add-form-row">
        <button id="add-button" class="add-form-button">Написать</button>
        <button id="delete-button" class="add-form-delete">Удалить</button>
      </div>
    </div>
  </div>
</body>

<script>
const buttonElement = document.getElementById('add-button');
const listElement = document.getElementById('list');
const nameInputElement = document.getElementById('name-input');
const commentInputElement = document.getElementById('comment-input');
const deleteButtonElement = document.getElementById('delete-button');

let commentsArray = [];

const fetchPromise = fetch("https://wedev-api.sky.pro/api/v1/anna-terenteva/comments",
{
  method: 'GET',
});

fetchPromise.then((response) => {
  const jsonPromise = response.json();
  jsonPromise.then((responseData) =>{
    console.log(responseData);
    const appComments = responseData.comments.map((comment) => {
      return {
        name: comment.author.name,
        date: comment.date,
        text: comment.text,
        like: 0,
        userLike: false,
      }
    });

    commentsArray = appComments;
    renderComments();
  })
});


const likes = () => {
  const likeButtons = document.querySelectorAll('.like-button');
  for (const likeButton of likeButtons) {
    likeButton.addEventListener('click', (event) => {
      event.stopPropagation();
      const index = likeButton.dataset.index;
      if (commentsArray[index].userLike === false) {
        commentsArray[index].paint = '-active-like';
        commentsArray[index].like += 1;
        commentsArray[index].userLike = true;
      } else {
        commentsArray[index].paint = '';
        commentsArray[index].like -= 1;
        commentsArray[index].userLike = false;
      }
      renderComments();
    });
  }
};


const renderComments = () => {
  const commentsHtml = commentsArray.map((item, index) =>{
    return `
    <li data-index="${index}" class="comment">
          <div class="comment-header">
            <div>${item.name}</div>
            <div>${item.date}</div>
          </div>
          <div class="comment-body">
            <div class="comment-text">
              ${item.comment}
            </div>
          </div>
          <div class="comment-footer">
            <div class="likes">
              <span class="likes-counter">${item.like}</span>
              <button data-index='${index}' class="like-button ${item.paint}"></button>
            </div>
          </div>
        </li>
    `})
    .join('');
    listElement.innerHTML = commentsHtml;
    likes();
    answerComment();
};
renderComments();

buttonElement.disabled = true;
nameInputElement.addEventListener('input', () =>{
  if (nameInputElement.value  === '' ) {
    buttonElement.disabled = true;
    return;
  } else {
    buttonElement.disabled = false;
  }
})

buttonElement.addEventListener('click', () => {
    nameInputElement.classList.remove('error');
    commentInputElement.classList.remove('error');
    
    if ((nameInputElement.value || commentInputElement.value) === '') {
      nameInputElement.classList.add('error');
      commentInputElement.classList.add('error');
      return;
    }

  const date = new Date();
  const formattedDate =
  date.getDate().toString().padStart(2, '0') + '.' + 
  (date.getMonth() + 1).toString().padStart(2, '0') + '.' +
  date.getFullYear().toString().slice(-2) + ' ' +
  date.getHours().toString().padStart(2, '0') + ':' +
  date.getMinutes().toString().padStart(2, '0');

  const fetchPromise = fetch("https://wedev-api.sky.pro/api/v1/anna-terenteva/comments",
  {
    method: 'POST',
    body: JSON.stringify({
      name: nameInputElement.value,
      text: commentInputElement.value,
    }),
  })
  
  fetchPromise.then((response) =>{
    response.json().then((responseData) =>{
      
      const appComments = responseData.comments.map((comment) => {
        return {
          name: comment.author.name,
          date: comment.date,
          text: comment.text,
          like: 0,
          userLike: false,
        }
      })
  
      commentsArray = appComments;
      getAndRenderComments();
      renderComments();
    })
  })
  
    renderComments();
    
    nameInputElement.value = '';
    commentInputElement.value = '';
    buttonElement.disabled = true;
});

function answerComment() {
  const oldComments = document.querySelectorAll('.comment');

  for (const oldComment of oldComments) {
    oldComment.addEventListener('click', (event) =>{
      event.stopPropagation();

      const index = oldComment.dataset.index;
      const comment = commentsArray[index];

      commentInputElement.value = `%BEGIN_QUOTE${commentsArray[index].name} \n
      ${comment.comment}END_QUOTE%`
    })
  }
}

deleteButtonElemesnt.addEventListener('click', () =>{
  const lastCommentIndex = listElement.innerHTML.lastIndexOf( '<li class="comment">' );
  if (lastCommentIndex !== -1) {
    listElement.innerHTML = listElement.innerHTML.substring( 0, lastCommentIndex ); 
  }
});


document.addEventListener('keyup', (event) =>{
  if (event.key === 'Enter') {
    buttonElement.click();
  }
});
</script>

</html>