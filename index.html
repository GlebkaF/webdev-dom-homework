<!DOCTYPE html>
<html>

<head>
  <title>Проект "Комменты"</title>
  <meta charset="utf-8" />
  <link rel="stylesheet" href="styles.css" />
</head>

<body>
  <div class="container">
    <div class="loader" id="loader-list">Пожалуйста подождите, загружаю комментарии...</div>
    <ul class="comments" id="list">
    </ul>
    <div class="loader" id="loader-comment">Комментарий добавляется...</div>
    <div class="add-form" id="form">
      <input type="text" class="add-form-name" placeholder="Введите ваше имя" id="name" />
      <textarea type="textarea" class="add-form-text" placeholder="Введите ваш коментарий" rows="4"
        id="comment"></textarea>
      <div class="add-form-row">
        <button class="add-form-button" id="add-button">Написать</button>
      </div>
    </div>
  </div>
</body>
<style>
  .button-off {
    color: #d2d5db;
    background: #6c7589;
    cursor: not-allowed;
  }

  .error {
    background-color: #df6262;
  }
</style>
<script>
  "use strict";
  const listElement = document.getElementById('list');
  const buttonElement = document.getElementById('add-button');
  const nameInputElement = document.getElementById('name');
  const commentTextareaElement = document.getElementById('comment');
  const formElement = document.getElementById('form');
  const loaderListElement = document.getElementById('loader-list');
  const loaderCommentElement = document.getElementById('loader-comment');

  const fetchGet = () => {
    return fetch("https://wedev-api.sky.pro/api/v1/Volkov_Pavel/comments", {
    method: "GET"
    })
    .then((response) => {
      return response.json();
    })
    .then((responseData) => {
      console.log(responseData);

      const appComments = responseData.comments.map((comment) => {
        let currentDate = new Date(comment.date);
        let myDate = currentDate.toLocaleDateString('ru-RU', { day: 'numeric', month: 'numeric', year: '2-digit' }) + ' ' + currentDate.toLocaleTimeString('ru-RU', { hour: 'numeric', minute: 'numeric' });
        return {
          name: comment.author.name,
          date: myDate,
          comment: comment.text,
          like: comment.isLiked,
          likeNumber: comment.likes,
          id: comment.id,
        }
      })

      listElementData = appComments;
      renderListElement();
      loaderListElement.style.display = 'none';
    });
  } 
  
  loaderCommentElement.style.display = 'none';
  
  fetchGet();

  let listElementData = [];

  const renderListElement = () => {
    listElement.innerHTML = listElementData
      .map((element, index) => {
        return `
          <li class="comment" data-index=${index}>
            <div class="comment-header">
              <div>${element.name}</div>
              <div>${element.date}</div>
            </div>
            <div class="comment-body">
              <div class="comment-text">
                ${element.comment 
            .replaceAll("QUOTE_BEGIN", "<div class='quote'>")
            .replaceAll("QUOTE_END", "</div>")
                } 
              </div>
            </div>
            <div class="comment-footer">
              <div class="likes">
                <span class="likes-counter">${(element.likeNumber)}</span>
                <button class="like-button ${(element.like) ? "-active-like" : ""}" data-index=${index}></button>
              </div>
              <div class="redactor">
                <button class="redactor-button" data-index=${index}>Реадактировать</button>
                <button class="delete-button" data-index=${index}>Удалить</button>
              </div>
            </div>
          </li>`
      }).join('');

    initLikeEvent();
    initRedactorEvent();
    initDeleteEvent();
    initAnsverEvent();
  }

  const initAnsverEvent = () => {
    for (const comment of document.querySelectorAll('.comment')) {
      comment.addEventListener('click', () => {
        const index = comment.dataset.index;
        const commentText = `${listElementData[index].name}: "${listElementData[index].comment}"`;
        // commentText
        commentTextareaElement.value = `QUOTE_BEGIN ${commentText} QUOTE_END`;

        renderListElement();
      })
    }
  }

  const initLikeEvent = () => {
    for (const likeButton of document.querySelectorAll('.like-button')) {
      likeButton.addEventListener('click', () => {
        event.stopPropagation();
        const index = likeButton.dataset.index;
        if (listElementData[index].like === false) {
          listElementData[index].like = true;
          listElementData[index].likeNumber += 1;
        } else {
          listElementData[index].like = false;
          listElementData[index].likeNumber -= 1;
        }

        renderListElement();
      })
    }
  }

  const initRedactorEvent = () => {
    for (const redactorButton of document.querySelectorAll('.redactor-button')) {
      redactorButton.addEventListener('click', () => {
        event.stopPropagation();
        const index = redactorButton.dataset.index;
        console.log(index);

        renderListElement();
      })
    }
  }

  const initDeleteEvent = () => {
    for (const deleteButton of document.querySelectorAll('.delete-button')) {
      deleteButton.addEventListener('click', () => {
        event.stopPropagation();
        const index = deleteButton.dataset.index;
        listElementData.splice(index, 1);

        renderListElement();
      })
    }
  }

  renderListElement();

  document.addEventListener('mouseover', () => {
    if (nameInputElement.value === '' || commentTextareaElement.value === '') {
      buttonElement.classList.add('button-off');
      buttonElement.disabled = true;
    }
  })

  document.addEventListener('keyup', () => {
    if (nameInputElement.value !== '' && commentTextareaElement.value !== '') {
      buttonElement.classList.remove('button-off');
      buttonElement.disabled = false;
    }
  })

  const enterComment = () => {
    nameInputElement.classList.remove('error');
    commentTextareaElement.classList.remove('error');
    loaderCommentElement.style.display = 'block';
    formElement.style.display = 'none';

    if (nameInputElement.value === '' && commentTextareaElement.value === '') {
      nameInputElement.classList.add('error');
      commentTextareaElement.classList.add('error');
      return;
    }
    else if (commentTextareaElement.value === '') {
      commentTextareaElement.classList.add('error');
      return;
    }
    else if (nameInputElement.value === '') {
      nameInputElement.classList.add('error');
      return;
    }

    

    fetch("https://wedev-api.sky.pro/api/v1/Volkov_Pavel/comments", {
      method: "POST",
      body: JSON.stringify({
        text: commentTextareaElement.value,
        name: nameInputElement.value,
      }),
    }).then((response) => {
      return response.json();
    })
    .then((responseData) => {
      console.log(responseData);

      return fetchGet();
    })
    .then(() => {
      formElement.style.display = 'flex';
      loaderCommentElement.style.display = 'none';
    });

    renderListElement();
    initLikeEvent();

    nameInputElement.value = '';
    commentTextareaElement.value = '';
  }

  document.addEventListener('keyup', function (e, l) {
    if (e.ctrlKey & e.key === 'Enter') {
      enterComment();
    }
  });

  buttonElement.addEventListener('click', () => {
    enterComment();
  });
  console.log("It works!");

</script>

</html>