<!DOCTYPE html>
<html>
  <head>
    <title>Проект "Комменты"</title>
    <meta charset="utf-8" />
    <link rel="stylesheet" href="styles.css" />
  </head>

  <body>
    <div class="container">
      <ul class="comments"></ul>
      <div class="loading-message"></div>
      <div class="add-form">
        <input type="text" id="name-input" class="add-form-name" placeholder="Введите ваше имя"/>
        <textarea 
        id="comment-input"
        type="textarea"
        class="add-form-text"
        placeholder="Введите ваш коментарий"
        rows="4"
        ></textarea>
        <div class="add-form-row">
          <button class="add-form-button">Написать</button>
        </div>
      </div>
    </div>
  </body>

  <script>
    "use strict";
  // 1. нужно найти элементы формы DOM с помощью метода document.querySelector(), используя добавленные id:
  // Получаем элементы формы и список комментариев из DOM
const nameInput = document.querySelector('#name-input');
const commentInput = document.querySelector('#comment-input');
const addButton = document.querySelector('.add-form-button');
const commentsList = document.querySelector('.comments');
const loadingMessage = document.querySelector('.loading-message');
let isLoading = true;

let comments = [];

let getComments = () => {
  fetch("https://wedev-api.sky.pro/api/v1/kristina-sapega/comments", {
    method: "GET",
  })
    .then((response) => {
      if (!response) {
        throw new Error("Ошибка при получении комментариев");
      }
      return response.json();
    })
    .then((responseData) => {
      const appComments = responseData.comments.map((comment) => {
        return {
          id: comment.id,
          name: comment.author.name,
          date: new Date(comment.date),
          text: comment.text,
          likes: comment.likes,
          liked: false,
        };
      });
      comments = appComments;
      isLoading = false;
      renderComments();
    })
    .catch((error) => {
      console.error(error);
      alert("Кажется что-то пошло не так, попробуйте позже.");
      isLoading = false;
      renderComments();
    });
};

getComments();


function showLoadingMessage() {
  if (isLoading) {
    loadingMessage.textContent = "Пожалуйста, подождите, загружаю комментарии...";
    loadingMessage.style.display = 'block';
  } else {
    loadingMessage.style.display = 'none';
  }
}

  const renderComments = () => {
  commentsList.innerHTML = "";
  showLoadingMessage();


  comments.forEach((comment) => {
  const newComment = document.createElement("li");
  newComment.classList.add("comment");
  
  const likeButtonClass = comment.liked ? "like-button -active-like" : "like-button";

    const dateAndTime = `${comment.date.toLocaleDateString()} ${comment.date.toLocaleTimeString()}`;
    newComment.innerHTML = `
      <div class="comment-header">
        <div>${comment.name}</div>
        <div>${dateAndTime}</div>
      </div>
      <div class="comment-body">
        <div class="comment-text">
          ${comment.text}
        </div>
      </div>
      <div class="comment-footer">
        <div class="likes">
          <span class="likes-counter">${comment.likes}</span>
          <button class="${likeButtonClass}" data-comment-id="${comment.id}"></button>
          <div class="edit-buttons">
      <button class="edit-button" data-comment-id="${comment.id}">Редактировать</button>
        </div>
      </div>
    `;

    newComment.addEventListener("click", () => {
    // При клике на комментарий, заполняем поля формы добавления комментария данными комментария
    nameInput.value = '';
    commentInput.value = `@${comment.name}, ${comment.text}:`;
    commentInput.focus();
    });
    commentsList.appendChild(newComment);
  });

    // Найти кнопку лайка внутри текущего комм
    const likeButtons = document.querySelectorAll('.like-button');
    likeButtons.forEach((button) => {
    button.addEventListener('click', (event) => {
      event.stopPropagation();
    // Получаем идентификатор комментария из атрибута data-comment-id кнопки лайка
    const commentId = parseInt(button.dataset.commentId);
    // Находим комментарий в массиве comments по идентификатору
    const comment = comments.find((c) => c.id === commentId);

      // Если комментарий уже был отмечен как понравившийся, уменьшаем счетчик лайков
      // Если комментарий не был отмечен, увеличиваем счетчик лайков
      if (comment.liked) {
        comment.likes--;
      } else {
        comment.likes++;
      }
      // Инвертируем значение свойства liked у комментария
      comment.liked = !comment.liked;

      // Перерисовываем список комментариев для отображения обновленных данных
      renderComments();
    });
  });
};


//addButton.addEventListener('click', function() {
  //if (nameInput.value.trim() === '' || commentInput.value.trim() === '') {
  //alert('Заполните все поля ввода!');
  //return;
  //}
  addButton.addEventListener("click", function () {
  if (nameInput.value.trim().length < 3 || commentInput.value.trim().length < 3) {
    alert("Имя и комментарий должны содержать хотя бы 3 символа!");
    return;
  }
 
//Скрытие формы добавления комментария и отображение сообщения "Комментарий добавляется ..."
  nameInput.disabled = true;
  commentInput.disabled = true;
  addButton.disabled = true;
  loadingMessage.textContent = "Комментарий добавляется...";


  const now = new Date();
  const dateString = `${now.getDate()}.${now.getMonth() + 1}.${now.getFullYear()} ${now.getHours()}:${now.getMinutes()}`;

  const newComment = {
    id: comments.length + 1,
    author: nameInput.value.
    replaceAll("<", "&lt;")
    .replaceAll(">", "&gt;")
    .replaceAll("&", "&amp;")
    .replaceAll('"', "&quot;"),
    date: dateString,
    text: commentInput.value
    .replaceAll("<", "&lt;")
    .replaceAll(">", "&gt;")
    .replaceAll("&", "&amp;")
    .replaceAll('"', "&quot;"),
    likes: "0",
    liked: false
  };

  // Сохраняем значения полей формы перед отправкой запроса
  const nameValue = nameInput.value;
  const commentValue = commentInput.value;

  addButton.disabled = true;
  addButton.textContent = "Элемент добавляется...";

  // Отправляем новый комментарий на сервер через POST-запрос
  function addCommentRequest() {
    const newComment = {
    name: nameInput.value,
    text: commentInput.value,
  };

  fetch("https://wedev-api.sky.pro/api/v1/kristina-sapega/comments", {
    method: "POST",
    body: JSON.stringify(newComment),
  })
    .then((response) => {
    if (response.status === 400) {
        throw new Error("Ошибка: имя и комментарий должны быть не короче 3 символов"); 
      } else if (response.status === 500) {
        throw new Error("Ошибка сервера: попробуйте позже");
      }
      return response.json();
    })
    .then((responseData) => {
      return fetch("https://wedev-api.sky.pro/api/v1/kristina-sapega/comments");
    })
    //.then((response) => response.json())
    .then((response) => {
  if (!response.ok) {
    throw new Error("Ошибка при получении комментариев");
  }
  return response.json();
})
    .then((responseData) => {
      //Обновление массива коммениариев
      comments.push(responseData);
      //comments = responseData.comments;
      renderComments();
      
      // Очистка полей ввода
      nameInput.value = " ";
      commentInput.value = " ";
      //Включение элементов формы
      nameInput.disabled = false;
      commentInput.disabled = false;
      addButton.disabled = false;
      addButton.textContent = "Добавить";
      loadingMessage.style.display = "none";
    })

    .catch((error) => {
      console.error(error);
      alert("Произошла ошибка при добавлении комментария");
      nameInput.disabled = false;
      commentInput.disabled = false;
      addButton.disabled = false;
      addButton.textContent = "Добавить";
      loadingMessage.style.display = "none";
    });
  }

  nameInput.disabled = true;
  commentInput.disabled = true;
  addButton.disabled = true;
  loadingMessage.textContent = "Комментарий добавляется...";
  getComments();
  renderComments();

  addCommentRequest();

});


//TODO: Рендерим комментарий впервые, чтобы показать надпись "Загружаю комментарии"
renderComments();
  

  </script>
</html>



