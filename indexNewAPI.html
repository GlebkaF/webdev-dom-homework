<!DOCTYPE html>
<html>
  <head>
    <title>Проект "Комменты"</title>
    <meta charset="utf-8" />
    <link rel="stylesheet" href="styles.css" />
  </head>

  <body>
    <div class="container">
      <ul class="comments">
        <!--список рендерится из js -->
      </ul>
      <div class="add-form">
        <input
          type="text"
          class="form add-form-name"
          placeholder="Введите ваше имя"
        />
        <textarea
          type="textarea"
          class="form add-form-text"
          placeholder="Введите ваш коментарий"
          rows="4"
        ></textarea>
        <div class="add-form-row">
          <button class="add-form-button">Написать</button>
        </div>
      </div>
    </div>
  </body>

  <script src="getComments.js"></script>
  <script src="editComment.js"></script>
  <script src="addLike.js"></script>
  <script>
    // const date = new Date();
    // let month = date.getMonth() + 1;
    // let minutes = date.getMinutes();
    const commentList = document.querySelector(".comments");
    const addFormButton = document.querySelector(".add-form-button");
    const inputName = document.querySelector(".add-form-name");
    const inputText = document.querySelector(".add-form-text");
    const form = document.querySelectorAll(".form");
    const container = document.querySelector(".container");
    getComments();
    let comments = [];
    const renderComments = () => {
      const commentsHtml = comments
        .map((comment, index) => {
          return `<li class='comment'>
      <div class='comment-header'>
        <div>${comment.name}</div>
        <div>${comment.date}
          </div>
        </div>
        <div class='comment-body'>
          <div class= 'comment-text'
          data-index="${index}"
          > ${comment.text} </div>
          </div>
          <div class='comment-footer'>
          <div class='likes'>
          <span class= 'likes-counter'> ${comment.likes}
            </div>
          <button class='like-button ${
            comment.isLiked ? "-active-like" : ""
          }' data-index="${index}"></button>
          </div>
          <div class='edit-container'>
            <button class='edit-button ${
              comment.edit ? "" : "edit-click"
            }' data-index="${index}">Изменить комментарий</button>
          </div>

      </li>`;
        })
        .join("");

      commentList.innerHTML = commentsHtml;
      initLikeButtonListener();
      editClick();
    };

    renderComments();

    addFormButton.addEventListener("click", (event) => {
      form.forEach((element) => {
        if (element.value === "") {
          element.classList.add("error");
        } else {
          element.classList.remove("error");
        }
      });

      if (inputName.value === "" || inputText.value.length < 1) {
        addFormButton.disabled = true;
        return;
      } else {
        const date = new Date();
        let month = date.getMonth() + 1;
        let minutes = date.getMinutes();

        if (month < 10) {
          month = "0" + month;
        }
        if (minutes < 10) {
          minutes = "0" + minutes;
        }

        /*Объявлена функции в функции , так насколько мне известно работать не будет*/
        //     function addNewComment() {

        const dateNow = Date.now();
        // у тебя в отправке нового коммента один адрес API в функции получения комментов другой
        //то есть даже при условие что обработчик клика по кнопке отправить не содержал ы в себе ошибки function addNewComment() {
        //ты бы все равно не получил ответа с новым комментом
        //  получается ты отправил сообщение на Сахалин , а хочешь получить его из Москвы )))
        //поменял адреса API на - из урока

        addFormButton.disabled = true;
        addFormButton.textContent = "Комментарий добавляется, подождите";

        fetch("https://webdev-hw-api.vercel.app/api/v1/eldar/comments", {
          method: "POST",
          body: JSON.stringify({
            text: inputText.value
              .replaceAll("&", "&amp;")
              .replaceAll("<", "&lt;")
              .replaceAll(">", "&gt;")
              .replaceAll('"', "&quot;")
              .replace("|", "<div class='quote'>")
              .replace("|", "</div>"),
            name: inputName.value
              .replaceAll("&", "&amp;")
              .replaceAll("<", "&lt;")
              .replaceAll(">", "&gt;")
              .replaceAll('"', "&quot;"),
          }),
        })
          .then((response) => {
            console.log("Время", Date.now() - dateNow);
            return response;
          })
          .then((response) => {
            console.log(response);
            return response.json();
          })
          .then((response) => {
            console.log("Время", Date.now() - dateNow);
            return response;
          })
          .then(() => {
            return getComments();
          })
          .then((data) => {
            addFormButton.disabled = false;
            addFormButton.textContent = "Написать";
          });
      }

      // renderComments(); возможно будет работать и тут
      initLikeButtonListener();
    });

    inputName.addEventListener("input", (event) => {
      if (event.target.value !== "") {
        addFormButton.disabled = false;
      }
    });

    inputText.addEventListener("input", (event) => {
      if (event.target.value !== "") {
        addFormButton.disabled = false;
      }
    });
  </script>
</html>
